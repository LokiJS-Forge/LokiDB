(function webpackUniversalModuleDefinition(root,factory){if(typeof exports==="object"&&typeof module==="object")module.exports=factory(require("@lokijs/loki"));else if(typeof define==="function"&&define.amd)define(["@lokijs/loki"],factory);else if(typeof exports==="object")exports["@lokijs/partitioning-adapter"]=factory(require("@lokijs/loki"));else{root["@lokijs/partitioning-adapter"]=factory(root["@lokijs/loki"]);root["LokiPartitioningAdapter"]=root["@lokijs/partitioning-adapter"].default}})(this,function(__WEBPACK_EXTERNAL_MODULE_1__){return function(modules){var installedModules={};function __webpack_require__(moduleId){if(installedModules[moduleId]){return installedModules[moduleId].exports}var module=installedModules[moduleId]={i:moduleId,l:false,exports:{}};modules[moduleId].call(module.exports,module,module.exports,__webpack_require__);module.l=true;return module.exports}__webpack_require__.m=modules;__webpack_require__.c=installedModules;__webpack_require__.d=function(exports,name,getter){if(!__webpack_require__.o(exports,name)){Object.defineProperty(exports,name,{configurable:false,enumerable:true,get:getter})}};__webpack_require__.n=function(module){var getter=module&&module.__esModule?function getDefault(){return module["default"]}:function getModuleExports(){return module};__webpack_require__.d(getter,"a",getter);return getter};__webpack_require__.o=function(object,property){return Object.prototype.hasOwnProperty.call(object,property)};__webpack_require__.p="";return __webpack_require__(__webpack_require__.s=0)}([function(module,__webpack_exports__,__webpack_require__){"use strict";Object.defineProperty(__webpack_exports__,"__esModule",{value:true});var __WEBPACK_IMPORTED_MODULE_0__loki_src_loki__=__webpack_require__(1);var __WEBPACK_IMPORTED_MODULE_0__loki_src_loki___default=__webpack_require__.n(__WEBPACK_IMPORTED_MODULE_0__loki_src_loki__);class LokiPartitioningAdapter{constructor(adapter,{paging:paging=false,pageSize:pageSize=25*1024*1024,delimiter:delimiter="$<\n"}={}){this.mode="reference";this._adapter=null;this._dbref=null;this._dbname="";this._pageIterator={};if(adapter){if(adapter.mode==="reference"){throw new Error("LokiPartitioningAdapter cannot be instantiated with a reference mode adapter.")}else{this._adapter=adapter}}else{throw new Error("LokiPartitioningAdapter requires a (non-reference mode) adapter on construction.")}this._paging=paging;this._pageSize=pageSize;this._delimiter=delimiter}loadDatabase(dbname){this._dbname=dbname;this._dbref=new __WEBPACK_IMPORTED_MODULE_0__loki_src_loki__["Loki"](dbname);return this._adapter.loadDatabase(dbname).then(result=>{if(typeof result!=="string"){throw new Error("LokiPartitioningAdapter received an unexpected response from inner adapter loadDatabase()")}let db=JSON.parse(result);this._dbref.loadJSONObject(db);db=null;if(this._dbref.collections.length===0){return this._dbref}this._pageIterator={collection:0,pageIndex:0};return this.loadNextPartition(0).then(()=>this._dbref)})}loadNextPartition(partition){const keyname=this._dbname+"."+partition;if(this._paging===true){this._pageIterator.pageIndex=0;return this.loadNextPage()}return this._adapter.loadDatabase(keyname).then(result=>{const data=this._dbref.deserializeCollection(result,{delimited:true,collectionIndex:partition});this._dbref.collections[partition].data=data;if(++partition<this._dbref.collections.length){return this.loadNextPartition(partition)}})}loadNextPage(){const keyname=this._dbname+"."+this._pageIterator.collection+"."+this._pageIterator.pageIndex;return this._adapter.loadDatabase(keyname).then(result=>{let data=result.split(this._delimiter);result="";let dlen=data.length;let idx;const isLastPage=data[dlen-1]==="";if(isLastPage){data.pop();dlen=data.length;if(data[dlen-1]===""&&dlen===1){data.pop();dlen=data.length}}for(idx=0;idx<dlen;idx++){this._dbref.collections[this._pageIterator.collection].data.push(JSON.parse(data[idx]));data[idx]=null}data=[];if(isLastPage){if(++this._pageIterator.collection<this._dbref.collections.length){return this.loadNextPartition(this._pageIterator.collection)}}else{this._pageIterator.pageIndex++;return this.loadNextPage()}})}exportDatabase(dbname,dbref){let idx;const clen=dbref.collections.length;this._dbref=dbref;this._dbname=dbname;this.dirtyPartitions=[-1];for(idx=0;idx<clen;idx++){if(dbref.collections[idx].dirty){this.dirtyPartitions.push(idx)}}return this.saveNextPartition()}saveNextPartition(){const partition=this.dirtyPartitions.shift();const keyname=this._dbname+(partition===-1?"":"."+partition);if(this._paging&&partition!==-1){this._pageIterator={collection:partition,docIndex:0,pageIndex:0};return this.saveNextPage().then(()=>{if(this.dirtyPartitions.length!==0){return this.saveNextPartition()}})}const result=this._dbref.serializeDestructured({partitioned:true,delimited:true,partition:partition});return this._adapter.saveDatabase(keyname,result).then(()=>{if(this.dirtyPartitions.length!==0){return this.saveNextPartition()}})}saveNextPage(){const coll=this._dbref.collections[this._pageIterator.collection];const keyname=this._dbname+"."+this._pageIterator.collection+"."+this._pageIterator.pageIndex;let pageLen=0;const cdlen=coll.data.length;const delimlen=this._delimiter.length;let serializedObject="";let pageBuilder="";let doneWithPartition=false;let doneWithPage=false;const pageSaveCallback=()=>{pageBuilder="";if(!doneWithPartition){this._pageIterator.pageIndex++;return this.saveNextPage()}};if(coll.data.length===0){doneWithPartition=true}while(!doneWithPartition&&!doneWithPage){if(!doneWithPartition){serializedObject=JSON.stringify(coll.data[this._pageIterator.docIndex]);pageBuilder+=serializedObject;pageLen+=serializedObject.length;if(++this._pageIterator.docIndex>=cdlen)doneWithPartition=true}if(pageLen>=this._pageSize)doneWithPage=true;if(!doneWithPage||doneWithPartition){pageBuilder+=this._delimiter;pageLen+=delimlen}}return this._adapter.saveDatabase(keyname,pageBuilder).then(pageSaveCallback)}}__webpack_exports__["LokiPartitioningAdapter"]=LokiPartitioningAdapter;__webpack_exports__["default"]=LokiPartitioningAdapter},function(module,exports){module.exports=__WEBPACK_EXTERNAL_MODULE_1__}])});