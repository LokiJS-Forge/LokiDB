(function webpackUniversalModuleDefinition(root,factory){if(typeof exports==="object"&&typeof module==="object")module.exports=factory(require("@lokidb/loki"));else if(typeof define==="function"&&define.amd)define("@lokidb/partitioning-adapter",["@lokidb/loki"],factory);else if(typeof exports==="object")exports["@lokidb/partitioning-adapter"]=factory(require("@lokidb/loki"));else{root["@lokidb/partitioning-adapter"]=factory(root["@lokidb/loki"]);root["LokiPartitioningAdapter"]=root["@lokidb/partitioning-adapter"].default}})(typeof self!=="undefined"?self:this,function(__WEBPACK_EXTERNAL_MODULE__1__){return function(modules){var installedModules={};function __webpack_require__(moduleId){if(installedModules[moduleId]){return installedModules[moduleId].exports}var module=installedModules[moduleId]={i:moduleId,l:false,exports:{}};modules[moduleId].call(module.exports,module,module.exports,__webpack_require__);module.l=true;return module.exports}__webpack_require__.m=modules;__webpack_require__.c=installedModules;__webpack_require__.d=function(exports,name,getter){if(!__webpack_require__.o(exports,name)){Object.defineProperty(exports,name,{enumerable:true,get:getter})}};__webpack_require__.r=function(exports){if(typeof Symbol!=="undefined"&&Symbol.toStringTag){Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"})}Object.defineProperty(exports,"__esModule",{value:true})};__webpack_require__.t=function(value,mode){if(mode&1)value=__webpack_require__(value);if(mode&8)return value;if(mode&4&&typeof value==="object"&&value&&value.__esModule)return value;var ns=Object.create(null);__webpack_require__.r(ns);Object.defineProperty(ns,"default",{enumerable:true,value:value});if(mode&2&&typeof value!="string")for(var key in value)__webpack_require__.d(ns,key,function(key){return value[key]}.bind(null,key));return ns};__webpack_require__.n=function(module){var getter=module&&module.__esModule?function getDefault(){return module["default"]}:function getModuleExports(){return module};__webpack_require__.d(getter,"a",getter);return getter};__webpack_require__.o=function(object,property){return Object.prototype.hasOwnProperty.call(object,property)};__webpack_require__.p="";return __webpack_require__(__webpack_require__.s=2)}([function(module,__webpack_exports__,__webpack_require__){"use strict";(function(global){__webpack_require__.d(__webpack_exports__,"a",function(){return PLUGINS});function getGlobal(){let glob;(function(global){glob=global})(global!==undefined&&global||this);return glob}function create(){const global=getGlobal();const sym=Symbol.for("LOKI");if(global[sym]===undefined){global[sym]={}}return global[sym]}const PLUGINS=create()}).call(this,__webpack_require__(3))},function(module,exports){module.exports=__WEBPACK_EXTERNAL_MODULE__1__},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var loki_=__webpack_require__(1);var common_plugin=__webpack_require__(0);class partitioning_adapter_PartitioningAdapter{static register(){common_plugin["a"]["PartitioningAdapter"]=partitioning_adapter_PartitioningAdapter}static deregister(){delete common_plugin["a"]["PartitioningAdapter"]}constructor(adapter,{paging:paging=false,pageSize:pageSize=25*1024*1024,delimiter:delimiter="$<\n"}={}){this.mode="reference";this._adapter=null;this._dbref=null;this._dbname="";this._pageIterator={};if(adapter){if(adapter.mode==="reference"){throw new Error("LokiPartitioningAdapter cannot be instantiated with a reference mode adapter.")}else{this._adapter=adapter}}else{throw new Error("LokiPartitioningAdapter requires a (non-reference mode) adapter on construction.")}this._paging=paging;this._pageSize=pageSize;this._delimiter=delimiter}loadDatabase(dbname){this._dbname=dbname;this._dbref=new loki_["Loki"](dbname);return this._adapter.loadDatabase(dbname).then(result=>{if(typeof result!=="string"){throw new Error("LokiPartitioningAdapter received an unexpected response from inner adapter loadDatabase()")}let db=JSON.parse(result);this._dbref.loadJSONObject(db);db=null;if(this._dbref._collections.length===0){return this._dbref}this._pageIterator={collection:0,pageIndex:0};return this._loadNextPartition(0).then(()=>this._dbref)})}_loadNextPartition(partition){if(this._paging===true){this._pageIterator.pageIndex=0;return this._loadNextPage()}const keyname=this._dbname+"."+partition;return this._adapter.loadDatabase(keyname).then(result=>{this._dbref._collections[partition]._data=this._dbref.deserializeCollection(result,{delimited:true});if(++partition<this._dbref._collections.length){return this._loadNextPartition(partition)}return Promise.resolve()})}_loadNextPage(){const keyname=this._dbname+"."+this._pageIterator.collection+"."+this._pageIterator.pageIndex;return this._adapter.loadDatabase(keyname).then(result=>{let data=result.split(this._delimiter);result="";let dlen=data.length;const isLastPage=data[dlen-1]==="";if(isLastPage){data.pop();dlen=data.length;if(data[dlen-1]===""&&dlen===1){data.pop();dlen=data.length}}for(let idx=0;idx<dlen;idx++){this._dbref._collections[this._pageIterator.collection]._data.push(JSON.parse(data[idx]));data[idx]=null}data=[];if(isLastPage){if(++this._pageIterator.collection<this._dbref._collections.length){return this._loadNextPartition(this._pageIterator.collection)}}else{this._pageIterator.pageIndex++;return this._loadNextPage()}return Promise.resolve()})}exportDatabase(dbname,dbref){this._dbref=dbref;this._dbname=dbname;this._dirtyPartitions=[-1];for(let idx=0;idx<dbref._collections.length;idx++){if(dbref._collections[idx]._dirty){this._dirtyPartitions.push(idx)}}return this._saveNextPartition()}_saveNextPartition(){const partition=this._dirtyPartitions.shift();const keyname=this._dbname+(partition===-1?"":"."+partition);if(this._paging&&partition!==-1){this._pageIterator={collection:partition,docIndex:0,pageIndex:0};return this._saveNextPage().then(()=>{if(this._dirtyPartitions.length!==0){return this._saveNextPartition()}return Promise.resolve()})}const result=this._dbref.serializeDestructured({partitioned:true,delimited:true,partition:partition});return this._adapter.saveDatabase(keyname,result).then(()=>{if(this._dirtyPartitions.length!==0){return this._saveNextPartition()}return Promise.resolve()})}_saveNextPage(){const coll=this._dbref._collections[this._pageIterator.collection];const keyname=this._dbname+"."+this._pageIterator.collection+"."+this._pageIterator.pageIndex;let pageLen=0;const cdlen=coll._data.length;const delimlen=this._delimiter.length;let serializedObject="";let pageBuilder="";let doneWithPartition=false;let doneWithPage=false;const pageSaveCallback=()=>{pageBuilder="";if(!doneWithPartition){this._pageIterator.pageIndex++;return this._saveNextPage()}return Promise.resolve()};if(coll._data.length===0){doneWithPartition=true}while(!doneWithPartition&&!doneWithPage){if(!doneWithPartition){serializedObject=JSON.stringify(coll._data[this._pageIterator.docIndex]);pageBuilder+=serializedObject;pageLen+=serializedObject.length;if(++this._pageIterator.docIndex>=cdlen)doneWithPartition=true}if(pageLen>=this._pageSize)doneWithPage=true;if(!doneWithPage||doneWithPartition){pageBuilder+=this._delimiter;pageLen+=delimlen}}return this._adapter.saveDatabase(keyname,pageBuilder).then(pageSaveCallback)}}__webpack_require__.d(__webpack_exports__,"PartitioningAdapter",function(){return partitioning_adapter_PartitioningAdapter});var src=__webpack_exports__["default"]=partitioning_adapter_PartitioningAdapter},function(module,exports){var g;g=function(){return this}();try{g=g||Function("return this")()||(1,eval)("this")}catch(e){if(typeof window==="object")g=window}module.exports=g}])});