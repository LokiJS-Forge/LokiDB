(function webpackUniversalModuleDefinition(root,factory){if(typeof exports==="object"&&typeof module==="object")module.exports=factory();else if(typeof define==="function"&&define.amd)define([],factory);else if(typeof exports==="object")exports["@lokijs/loki"]=factory();else{root["@lokijs/loki"]=factory();root["Loki"]=root["@lokijs/loki"].default}})(this,function(){return function(modules){var installedModules={};function __webpack_require__(moduleId){if(installedModules[moduleId]){return installedModules[moduleId].exports}var module=installedModules[moduleId]={i:moduleId,l:false,exports:{}};modules[moduleId].call(module.exports,module,module.exports,__webpack_require__);module.l=true;return module.exports}__webpack_require__.m=modules;__webpack_require__.c=installedModules;__webpack_require__.d=function(exports,name,getter){if(!__webpack_require__.o(exports,name)){Object.defineProperty(exports,name,{configurable:false,enumerable:true,get:getter})}};__webpack_require__.n=function(module){var getter=module&&module.__esModule?function getDefault(){return module["default"]}:function getModuleExports(){return module};__webpack_require__.d(getter,"a",getter);return getter};__webpack_require__.o=function(object,property){return Object.prototype.hasOwnProperty.call(object,property)};__webpack_require__.p="";return __webpack_require__(__webpack_require__.s=8)}([function(module,__webpack_exports__,__webpack_require__){"use strict";class LokiEventEmitter{constructor(){this.events={};this.asyncListeners=false}on(eventName,listener){let event;if(Array.isArray(eventName)){eventName.forEach(currentEventName=>{this.on(currentEventName,listener)});return listener}event=this.events[eventName];if(!event){event=this.events[eventName]=[]}event.push(listener);return listener}emit(eventName,...data){if(eventName&&this.events[eventName]){this.events[eventName].forEach(listener=>{if(this.asyncListeners){setTimeout(()=>{listener(...data)},1)}else{listener(...data)}})}}addListener(eventName,listener){return this.on(eventName,listener)}removeListener(eventName,listener){if(Array.isArray(eventName)){eventName.forEach(currentEventName=>{this.removeListener(currentEventName,listener)})}if(this.events[eventName]){const listeners=this.events[eventName];listeners.splice(listeners.indexOf(listener),1)}}}__webpack_exports__["a"]=LokiEventEmitter},function(module,__webpack_exports__,__webpack_require__){"use strict";var __WEBPACK_IMPORTED_MODULE_0__event_emitter__=__webpack_require__(0);var __WEBPACK_IMPORTED_MODULE_1__unique_index__=__webpack_require__(10);var __WEBPACK_IMPORTED_MODULE_2__resultset__=__webpack_require__(5);var __WEBPACK_IMPORTED_MODULE_3__dynamic_view__=__webpack_require__(11);var __WEBPACK_IMPORTED_MODULE_4__helper__=__webpack_require__(6);var __WEBPACK_IMPORTED_MODULE_5__clone__=__webpack_require__(2);var __WEBPACK_IMPORTED_MODULE_6__full_text_search_src_full_text_search__=__webpack_require__(12);var __WEBPACK_IMPORTED_MODULE_7__common_plugin__=__webpack_require__(3);function isDeepProperty(field){return field.indexOf(".")!==-1}function average(array){return array.reduce((a,b)=>a+b,0)/array.length}function standardDeviation(values){const avg=average(values);const squareDiffs=values.map(value=>{const diff=value-avg;return diff*diff});const avgSquareDiff=average(squareDiffs);return Math.sqrt(avgSquareDiff)}function deepProperty(obj,property,isDeep){if(isDeep===false){return obj[property]}const pieces=property.split(".");let root=obj;while(pieces.length>0){root=root[pieces.shift()]}return root}class Collection extends __WEBPACK_IMPORTED_MODULE_0__event_emitter__["a"]{constructor(name,options={}){super();this.constraints={unique:{}};this.name=name;this.data=[];this.idIndex=[];this.binaryIndices={};this.constraints={unique:{}};this.transforms={};this.dirty=true;this.cachedIndex=null;this.cachedBinaryIndex=null;this.cachedData=null;if(options.unique!==undefined){if(!Array.isArray(options.unique)){options.unique=[options.unique]}options.unique.forEach(prop=>{this.constraints.unique[prop]=new __WEBPACK_IMPORTED_MODULE_1__unique_index__["a"](prop)})}if(__WEBPACK_IMPORTED_MODULE_7__common_plugin__["a"]["FullTextSearch"]!==undefined){this._fullTextSearch=options.fullTextSearch!==undefined?new __WEBPACK_IMPORTED_MODULE_7__common_plugin__["a"]["FullTextSearch"](options.fullTextSearch):null}else{this._fullTextSearch=null}this.adaptiveBinaryIndices=options.adaptiveBinaryIndices!==undefined?options.adaptiveBinaryIndices:true;this.transactional=options.transactional!==undefined?options.transactional:false;this.cloneObjects=options.clone!==undefined?options.clone:false;this.asyncListeners=options.asyncListeners!==undefined?options.asyncListeners:false;this.disableChangesApi=options.disableChangesApi!==undefined?options.disableChangesApi:true;this.disableDeltaChangesApi=options.disableDeltaChangesApi!==undefined?options.disableDeltaChangesApi:true;this.cloneMethod=options.cloneMethod!==undefined?options.cloneMethod:__WEBPACK_IMPORTED_MODULE_5__clone__["a"].DEEP;if(this.disableChangesApi){this.disableDeltaChangesApi=true}this.serializableIndices=options.serializableIndices!==undefined?options.serializableIndices:true;this.ttl={age:null,ttlInterval:null,daemon:null};this.setTTL(options.ttl||-1,options.ttlInterval);this.maxId=0;this._dynamicViews=[];this.events={insert:[],update:[],"pre-insert":[],"pre-update":[],close:[],flushbuffer:[],error:[],delete:[],warning:[]};this.changes=[];this.ensureId();let indices=options.indices?options.indices:[];for(let idx=0;idx<indices.length;idx++){this.ensureIndex(options.indices[idx])}this.setChangesApi(this.disableChangesApi,this.disableDeltaChangesApi);this.on("insert",obj=>{this.insertHandler(obj)});this.on("update",(obj,old)=>{this.updateHandler(obj,old)});this.on("delete",obj=>{if(!this.disableChangesApi){this._createChange(this.name,"R",obj)}});this.on("warning",warning=>{this.console.warn(warning)});this.flushChanges();this.console={log(){},warn(){},error(){}};this.stages={};this.commitLog=[]}toJSON(){return{name:this.name,_dynamicViews:this._dynamicViews,uniqueNames:Object.keys(this.constraints.unique),transforms:this.transforms,binaryIndices:this.binaryIndices,data:this.data,idIndex:this.idIndex,maxId:this.maxId,dirty:this.dirty,adaptiveBinaryIndices:this.adaptiveBinaryIndices,transactional:this.transactional,asyncListeners:this.asyncListeners,disableChangesApi:this.disableChangesApi,cloneObjects:this.cloneObjects,cloneMethod:this.cloneMethod,changes:this.changes,_fullTextSearch:this._fullTextSearch}}static fromJSONObject(obj,options){let coll=new Collection(obj.name,{disableChangesApi:obj.disableChangesApi,disableDeltaChangesApi:obj.disableDeltaChangesApi});coll.adaptiveBinaryIndices=obj.adaptiveBinaryIndices!==undefined?obj.adaptiveBinaryIndices===true:false;coll.transactional=obj.transactional;coll.asyncListeners=obj.asyncListeners;coll.disableChangesApi=obj.disableChangesApi;coll.cloneObjects=obj.cloneObjects;coll.cloneMethod=obj.cloneMethod||__WEBPACK_IMPORTED_MODULE_5__clone__["a"].DEEP;coll.changes=obj.changes;coll.dirty=options&&options.retainDirtyFlags===true?obj.dirty:false;function makeLoader(coll){const collOptions=options[coll.name];if(collOptions.proto){let inflater=collOptions.inflate||((src,dest)=>{for(let prop in src){dest[prop]=src[prop]}});return data=>{const collObj=new collOptions.proto;inflater(data,collObj);return collObj}}return collOptions.inflate}let clen=obj.data.length;let j=0;if(options&&options[obj.name]!==undefined){let loader=makeLoader(obj);for(j;j<clen;j++){coll.data[j]=loader(obj.data[j])}}else{for(j;j<clen;j++){coll.data[j]=obj.data[j]}}coll.maxId=typeof obj.maxId==="undefined"?0:obj.maxId;coll.idIndex=obj.idIndex;if(obj.binaryIndices!==undefined){coll.binaryIndices=obj.binaryIndices}if(obj.transforms!==undefined){coll.transforms=obj.transforms}coll.ensureId();if(obj.uniqueNames!==undefined){for(j=0;j<obj.uniqueNames.length;j++){coll.ensureUniqueIndex(obj.uniqueNames[j])}}if(obj._dynamicViews!==undefined){for(let idx=0;idx<obj._dynamicViews.length;idx++){coll._dynamicViews.push(__WEBPACK_IMPORTED_MODULE_3__dynamic_view__["a"].fromJSONObject(coll,obj._dynamicViews[idx]))}}if(obj._fullTextSearch){coll._fullTextSearch=__WEBPACK_IMPORTED_MODULE_6__full_text_search_src_full_text_search__["a"].fromJSONObject(obj._fullTextSearch)}return coll}addTransform(name,transform){if(this.transforms[name]!==undefined){throw new Error("a transform by that name already exists")}this.transforms[name]=transform}getTransform(name){return this.transforms[name]}setTransform(name,transform){this.transforms[name]=transform}removeTransform(name){delete this.transforms[name]}ttlDaemonFuncGen(){const collection=this;const age=this.ttl.age;return function ttlDaemon(){const now=Date.now();const toRemove=collection.chain().where(member=>{const timestamp=member.meta.updated||member.meta.created;const diff=now-timestamp;return age<diff});toRemove.remove()}}setTTL(age,interval){if(age<0){clearInterval(this.ttl.daemon)}else{this.ttl.age=age;this.ttl.ttlInterval=interval;this.ttl.daemon=setInterval(this.ttlDaemonFuncGen(),interval)}}prepareFullDocIndex(){const len=this.data.length;const indexes=new Array(len);for(let i=0;i<len;i+=1){indexes[i]=i}return indexes}ensureIndex(property,force=false){if(property===null||property===undefined){throw new Error("Attempting to set index without an associated property")}if(this.binaryIndices[property]&&!force){if(!this.binaryIndices[property].dirty)return}if(this.adaptiveBinaryIndices===true&&this.binaryIndices[property]!==undefined&&!force){return}const index={name:property,dirty:true,values:this.prepareFullDocIndex()};this.binaryIndices[property]=index;const wrappedComparer=((prop,data)=>(a,b)=>{let val1,val2,arr;if(~prop.indexOf(".")){arr=prop.split(".");val1=arr.reduce(function(obj,i){return obj&&obj[i]||undefined},data[a]);val2=arr.reduce(function(obj,i){return obj&&obj[i]||undefined},data[b])}else{val1=data[a][prop];val2=data[b][prop]}if(val1!==val2){if(Object(__WEBPACK_IMPORTED_MODULE_4__helper__["c"])(val1,val2,false))return-1;if(Object(__WEBPACK_IMPORTED_MODULE_4__helper__["b"])(val1,val2,false))return 1}return 0})(property,this.data);index.values.sort(wrappedComparer);index.dirty=false;this.dirty=true}getSequencedIndexValues(property){let idx;const idxvals=this.binaryIndices[property].values;let result="";for(idx=0;idx<idxvals.length;idx++){result+=" ["+idx+"] "+this.data[idxvals[idx]][property]}return result}ensureUniqueIndex(field){let index=new __WEBPACK_IMPORTED_MODULE_1__unique_index__["a"](field);this.constraints.unique[field]=index;for(let i=0;i<this.data.length;i++){index.set(this.data[i],i)}return index}ensureAllIndexes(force=false){let key;const bIndices=this.binaryIndices;for(key in bIndices){if(bIndices[key]!==undefined){this.ensureIndex(key,force)}}}flagBinaryIndexesDirty(){let key;const bIndices=this.binaryIndices;for(key in bIndices){if(bIndices[key]!==undefined){bIndices[key].dirty=true}}}flagBinaryIndexDirty(index){if(this.binaryIndices[index])this.binaryIndices[index].dirty=true}count(query){if(!query){return this.data.length}return this.chain().find(query).filteredrows.length}ensureId(){const len=this.data.length;let i=0;this.idIndex=[];for(i;i<len;i+=1){this.idIndex.push(this.data[i].$loki)}}addDynamicView(name,options){const dv=new __WEBPACK_IMPORTED_MODULE_3__dynamic_view__["a"](this,name,options);this._dynamicViews.push(dv);return dv}removeDynamicView(name){for(let idx=0;idx<this._dynamicViews.length;idx++){if(this._dynamicViews[idx].name===name){this._dynamicViews.splice(idx,1)}}}getDynamicView(name){for(let idx=0;idx<this._dynamicViews.length;idx++){if(this._dynamicViews[idx].name===name){return this._dynamicViews[idx]}}return null}findAndUpdate(filterObject,updateFunction){if(typeof filterObject==="function"){this.updateWhere(filterObject,updateFunction)}else{this.chain().find(filterObject).update(updateFunction)}}findAndRemove(filterObject){this.chain().find(filterObject).remove()}insert(doc){if(!Array.isArray(doc)){return this.insertOne(doc)}let obj;let results=[];this.emit("pre-insert",doc);for(let i=0;i<doc.length;i++){obj=this.insertOne(doc[i],true);if(!obj){return undefined}results.push(obj)}this.emit("insert",results);results=this.cloneObjects?Object(__WEBPACK_IMPORTED_MODULE_5__clone__["b"])(results,this.cloneMethod):results;return results.length===1?results[0]:results}insertOne(doc,bulkInsert=false){let err=null;let returnObj;if(typeof doc!=="object"){err=new TypeError("Document needs to be an object")}else if(doc===null){err=new TypeError("Object cannot be null")}if(err!==null){this.emit("error",err);throw err}const obj=this.cloneObjects?Object(__WEBPACK_IMPORTED_MODULE_5__clone__["b"])(doc,this.cloneMethod):doc;if(obj.meta===undefined){obj.meta={revision:0,created:0}}if(!bulkInsert){this.emit("pre-insert",obj)}if(!this.add(obj)){return undefined}returnObj=obj;if(!bulkInsert){this.emit("insert",obj);returnObj=this.cloneObjects?Object(__WEBPACK_IMPORTED_MODULE_5__clone__["b"])(obj,this.cloneMethod):obj}return returnObj}clear(options={}){this.data=[];this.idIndex=[];this.cachedIndex=null;this.cachedBinaryIndex=null;this.cachedData=null;this.maxId=0;this._dynamicViews=[];this.dirty=true;if(options.removeIndices===true){this.binaryIndices={};this.constraints={unique:{}}}else{const keys=Object.keys(this.binaryIndices);keys.forEach(biname=>{this.binaryIndices[biname].dirty=false;this.binaryIndices[biname].values=[]});const uniqueNames=Object.keys(this.constraints.unique);for(let i=0;i<uniqueNames.length;i++){this.constraints.unique[uniqueNames[i]].clear()}}if(this._fullTextSearch!==null){this._fullTextSearch.clear()}}update(doc){if(Array.isArray(doc)){let k=0;const len=doc.length;for(k;k<len;k+=1){this.update(doc[k])}return}if(doc.$loki===undefined){throw new Error("Trying to update unsynced document. Please save the document first by using insert() or addMany()")}try{this.startTransaction();const arr=this.get(doc.$loki,true);if(!arr){throw new Error("Trying to update a document not in collection.")}let oldInternal=arr[0];let position=arr[1];let newInternal=this.cloneObjects||!this.disableDeltaChangesApi?Object(__WEBPACK_IMPORTED_MODULE_5__clone__["b"])(doc,this.cloneMethod):doc;this.emit("pre-update",doc);Object.keys(this.constraints.unique).forEach(key=>{this.constraints.unique[key].update(newInternal,position)});this.data[position]=newInternal;for(let idx=0;idx<this._dynamicViews.length;idx++){this._dynamicViews[idx]._evaluateDocument(position,false)}let key;if(this.adaptiveBinaryIndices){const bIndices=this.binaryIndices;for(key in bIndices){this.adaptiveBinaryIndexUpdate(position,key)}}else{this.flagBinaryIndexesDirty()}this.idIndex[position]=newInternal.$loki;if(this._fullTextSearch!==null){this._fullTextSearch.updateDocument(doc,position)}this.commit();this.dirty=true;this.emit("update",doc,this.cloneObjects||!this.disableDeltaChangesApi?Object(__WEBPACK_IMPORTED_MODULE_5__clone__["b"])(oldInternal,this.cloneMethod):null);return doc}catch(err){this.rollback();this.console.error(err.message);this.emit("error",err);throw err}}add(obj){if("object"!==typeof obj){throw new TypeError("Object being added needs to be an object")}if(obj["$loki"]!==undefined){throw new Error("Document is already in collection, please use update()")}try{this.startTransaction();this.maxId++;if(isNaN(this.maxId)){this.maxId=this.data[this.data.length-1].$loki+1}const newDoc=obj;newDoc.$loki=this.maxId;newDoc.meta.version=0;let key;const constrUnique=this.constraints.unique;for(key in constrUnique){if(constrUnique[key]!==undefined){constrUnique[key].set(newDoc,this.data.length)}}this.idIndex.push(newDoc.$loki);this.data.push(newDoc);const addedPos=this.data.length-1;const dvlen=this._dynamicViews.length;for(let i=0;i<dvlen;i++){this._dynamicViews[i]._evaluateDocument(addedPos,true)}if(this.adaptiveBinaryIndices){const bIndices=this.binaryIndices;for(key in bIndices){this.adaptiveBinaryIndexInsert(addedPos,key)}}else{this.flagBinaryIndexesDirty()}if(this._fullTextSearch!==null){this._fullTextSearch.addDocument(newDoc,addedPos)}this.commit();this.dirty=true;return this.cloneObjects?Object(__WEBPACK_IMPORTED_MODULE_5__clone__["b"])(newDoc,this.cloneMethod):newDoc}catch(err){this.rollback();this.console.error(err.message);this.emit("error",err);throw err}}updateWhere(filterFunction,updateFunction){const results=this.where(filterFunction);let i=0;let obj;try{for(i;i<results.length;i++){obj=updateFunction(results[i]);this.update(obj)}}catch(err){this.rollback();this.console.error(err.message)}}removeWhere(query){let list;if(typeof query==="function"){list=this.data.filter(query);this.remove(list)}else{this.chain().find(query).remove()}}removeDataOnly(){this.remove(this.data.slice())}remove(doc){if(typeof doc==="number"){doc=this.get(doc)}if("object"!==typeof doc){throw new Error("Parameter is not an object")}if(Array.isArray(doc)){let k=0;const len=doc.length;for(k;k<len;k+=1){this.remove(doc[k])}return}if(doc.$loki===undefined){throw new Error("Object is not a document stored in the collection")}try{this.startTransaction();const arr=this.get(doc.$loki,true);const position=arr[1];Object.keys(this.constraints.unique).forEach(key=>{if(doc[key]!==null&&typeof doc[key]!=="undefined"){this.constraints.unique[key].remove(doc[key])}});for(let idx=0;idx<this._dynamicViews.length;idx++){this._dynamicViews[idx]._removeDocument(position)}if(this.adaptiveBinaryIndices){let key;const bIndices=this.binaryIndices;for(key in bIndices){this.adaptiveBinaryIndexRemove(position,key)}}else{this.flagBinaryIndexesDirty()}this.data.splice(position,1);this.idIndex.splice(position,1);if(this._fullTextSearch!=null){this._fullTextSearch.removeDocument(doc,position)}this.commit();this.dirty=true;this.emit("delete",arr[0]);delete doc.$loki;delete doc.meta;return doc}catch(err){this.rollback();this.console.error(err.message);this.emit("error",err);return null}}getChanges(){return this.changes}setChangesApi(disableChangesApi,disableDeltaChangesApi=true){this.disableChangesApi=disableChangesApi;this.disableDeltaChangesApi=disableDeltaChangesApi;if(disableChangesApi){this.disableDeltaChangesApi=true}this.insertHandler=this.disableChangesApi?this._insertMeta:this._insertMetaWithChange;this.updateHandler=this.disableChangesApi?this._updateMeta:this._updateMetaWithChange}flushChanges(){this.changes=[]}_getObjectDelta(oldObject,newObject){const propertyNames=newObject!==null&&typeof newObject==="object"?Object.keys(newObject):null;if(propertyNames&&propertyNames.length&&["string","boolean","number"].indexOf(typeof newObject)<0){const delta={};for(let i=0;i<propertyNames.length;i++){const propertyName=propertyNames[i];if(newObject.hasOwnProperty(propertyName)){if(!oldObject.hasOwnProperty(propertyName)||this.constraints.unique[propertyName]!==undefined||propertyName==="$loki"||propertyName==="meta"){delta[propertyName]=newObject[propertyName]}else{const propertyDelta=this._getObjectDelta(oldObject[propertyName],newObject[propertyName]);if(propertyDelta!==undefined&&propertyDelta!=={}){delta[propertyName]=propertyDelta}}}}return Object.keys(delta).length===0?undefined:delta}else{return oldObject===newObject?undefined:newObject}}_getChangeDelta(obj,old){if(old){return this._getObjectDelta(old,obj)}else{return JSON.parse(JSON.stringify(obj))}}_createChange(name,op,obj,old){this.changes.push({name:name,operation:op,obj:op==="U"&&!this.disableDeltaChangesApi?this._getChangeDelta(obj,old):JSON.parse(JSON.stringify(obj))})}_createInsertChange(obj){this._createChange(this.name,"I",obj)}_insertMeta(obj){let len;let idx;if(!obj){return}if(Array.isArray(obj)){len=obj.length;for(idx=0;idx<len;idx++){if(obj[idx].meta===undefined){obj[idx].meta={}}obj[idx].meta.created=(new Date).getTime();obj[idx].meta.revision=0}return}if(!obj.meta){obj.meta={}}obj.meta.created=(new Date).getTime();obj.meta.revision=0}_updateMeta(obj){if(!obj){return}obj.meta.updated=(new Date).getTime();obj.meta.revision+=1}_createUpdateChange(obj,old){this._createChange(this.name,"U",obj,old)}_insertMetaWithChange(obj){this._insertMeta(obj);this._createInsertChange(obj)}_updateMetaWithChange(obj,old){this._updateMeta(obj);this._createUpdateChange(obj,old)}get(id,returnPosition=false){const data=this.idIndex;let max=data.length-1;let min=0;let mid=min+max>>1;id=typeof id==="number"?id:parseInt(id,10);if(isNaN(id)){throw new TypeError("Passed id is not an integer")}while(data[min]<data[max]){mid=min+max>>1;if(data[mid]<id){min=mid+1}else{max=mid}}if(max===min&&data[min]===id){if(returnPosition){return[this.data[min],min]}return this.data[min]}return null}getBinaryIndexPosition(dataPosition,binaryIndexName){const val=this.data[dataPosition][binaryIndexName];const index=this.binaryIndices[binaryIndexName].values;const range=this.calculateRange("$eq",binaryIndexName,val);if(range[0]===0&&range[1]===-1){return null}const min=range[0];const max=range[1];for(let idx=min;idx<=max;idx++){if(index[idx]===dataPosition)return idx}return null}adaptiveBinaryIndexInsert(dataPosition,binaryIndexName){const index=this.binaryIndices[binaryIndexName].values;let val=this.data[dataPosition][binaryIndexName];if(this.serializableIndices===true&&val instanceof Date){this.data[dataPosition][binaryIndexName]=val.getTime();val=this.data[dataPosition][binaryIndexName]}const idxPos=index.length===0?0:this._calculateRangeStart(binaryIndexName,val,true);this.binaryIndices[binaryIndexName].values.splice(idxPos,0,dataPosition)}adaptiveBinaryIndexUpdate(dataPosition,binaryIndexName){let idxPos;const index=this.binaryIndices[binaryIndexName].values;const len=index.length;for(idxPos=0;idxPos<len;idxPos++){if(index[idxPos]===dataPosition)break}this.binaryIndices[binaryIndexName].values.splice(idxPos,1);this.adaptiveBinaryIndexInsert(dataPosition,binaryIndexName)}adaptiveBinaryIndexRemove(dataPosition,binaryIndexName,removedFromIndexOnly=false){const idxPos=this.getBinaryIndexPosition(dataPosition,binaryIndexName);const index=this.binaryIndices[binaryIndexName].values;let len;let idx;if(idxPos===null){return null}this.binaryIndices[binaryIndexName].values.splice(idxPos,1);if(removedFromIndexOnly===true){return}len=index.length;for(idx=0;idx<len;idx++){if(index[idx]>dataPosition){index[idx]--}}}_calculateRangeStart(prop,val,adaptive=false){const rcd=this.data;const index=this.binaryIndices[prop].values;let min=0;let max=index.length-1;let mid=0;if(index.length===0){return-1}while(min<max){mid=min+max>>1;if(Object(__WEBPACK_IMPORTED_MODULE_4__helper__["c"])(rcd[index[mid]][prop],val,false)){min=mid+1}else{max=mid}}const lbound=min;if(Object(__WEBPACK_IMPORTED_MODULE_4__helper__["a"])(val,rcd[index[lbound]][prop])){return lbound}if(Object(__WEBPACK_IMPORTED_MODULE_4__helper__["c"])(val,rcd[index[lbound]][prop],false)){return adaptive?lbound:lbound-1}return adaptive?lbound+1:lbound}_calculateRangeEnd(prop,val){const rcd=this.data;const index=this.binaryIndices[prop].values;let min=0;let max=index.length-1;let mid=0;if(index.length===0){return-1}while(min<max){mid=min+max>>1;if(Object(__WEBPACK_IMPORTED_MODULE_4__helper__["c"])(val,rcd[index[mid]][prop],false)){max=mid}else{min=mid+1}}const ubound=max;if(Object(__WEBPACK_IMPORTED_MODULE_4__helper__["a"])(val,rcd[index[ubound]][prop])){return ubound}if(Object(__WEBPACK_IMPORTED_MODULE_4__helper__["b"])(val,rcd[index[ubound]][prop],false)){return ubound+1}if(Object(__WEBPACK_IMPORTED_MODULE_4__helper__["a"])(val,rcd[index[ubound-1]][prop])){return ubound-1}return ubound}calculateRange(op,prop,val){const rcd=this.data;const index=this.binaryIndices[prop].values;const min=0;const max=index.length-1;let lbound;let lval;let ubound;if(rcd.length===0){return[0,-1]}const minVal=rcd[index[min]][prop];const maxVal=rcd[index[max]][prop];switch(op){case"$eq":case"$aeq":if(Object(__WEBPACK_IMPORTED_MODULE_4__helper__["c"])(val,minVal,false)||Object(__WEBPACK_IMPORTED_MODULE_4__helper__["b"])(val,maxVal,false)){return[0,-1]}break;case"$dteq":if(Object(__WEBPACK_IMPORTED_MODULE_4__helper__["c"])(val,minVal,false)||Object(__WEBPACK_IMPORTED_MODULE_4__helper__["b"])(val,maxVal,false)){return[0,-1]}break;case"$gt":if(Object(__WEBPACK_IMPORTED_MODULE_4__helper__["b"])(val,maxVal,true)){return[0,-1]}if(Object(__WEBPACK_IMPORTED_MODULE_4__helper__["b"])(minVal,val,false)){return[min,max]}break;case"$gte":if(Object(__WEBPACK_IMPORTED_MODULE_4__helper__["b"])(val,maxVal,false)){return[0,-1]}if(Object(__WEBPACK_IMPORTED_MODULE_4__helper__["b"])(minVal,val,true)){return[min,max]}break;case"$lt":if(Object(__WEBPACK_IMPORTED_MODULE_4__helper__["c"])(val,minVal,true)){return[0,-1]}if(Object(__WEBPACK_IMPORTED_MODULE_4__helper__["c"])(maxVal,val,false)){return[min,max]}break;case"$lte":if(Object(__WEBPACK_IMPORTED_MODULE_4__helper__["c"])(val,minVal,false)){return[0,-1]}if(Object(__WEBPACK_IMPORTED_MODULE_4__helper__["c"])(maxVal,val,true)){return[min,max]}break;case"$between":if(Object(__WEBPACK_IMPORTED_MODULE_4__helper__["b"])(val[0],maxVal,false)){return[0,-1]}if(Object(__WEBPACK_IMPORTED_MODULE_4__helper__["c"])(val[1],minVal,false)){return[0,-1]}lbound=this._calculateRangeStart(prop,val[0]);ubound=this._calculateRangeEnd(prop,val[1]);if(lbound<0)lbound++;if(ubound>max)ubound--;if(!Object(__WEBPACK_IMPORTED_MODULE_4__helper__["b"])(rcd[index[lbound]][prop],val[0],true))lbound++;if(!Object(__WEBPACK_IMPORTED_MODULE_4__helper__["c"])(rcd[index[ubound]][prop],val[1],true))ubound--;if(ubound<lbound)return[0,-1];return[lbound,ubound]}switch(op){case"$eq":case"$aeq":case"$dteq":case"$gte":case"$lt":lbound=this._calculateRangeStart(prop,val);lval=rcd[index[lbound]][prop];break;default:break}switch(op){case"$eq":case"$aeq":case"$dteq":case"$lte":case"$gt":ubound=this._calculateRangeEnd(prop,val);break;default:break}switch(op){case"$eq":case"$aeq":case"$dteq":if(!Object(__WEBPACK_IMPORTED_MODULE_4__helper__["a"])(lval,val)){return[0,-1]}return[lbound,ubound];case"$gt":if(!Object(__WEBPACK_IMPORTED_MODULE_4__helper__["a"])(rcd[index[ubound]][prop],val)){return[ubound,max]}return[ubound+1,max];case"$gte":if(!Object(__WEBPACK_IMPORTED_MODULE_4__helper__["a"])(rcd[index[lbound]][prop],val)){return[lbound+1,max]}return[lbound,max];case"$lt":if(!Object(__WEBPACK_IMPORTED_MODULE_4__helper__["a"])(rcd[index[lbound]][prop],val)){return[min,lbound]}return[min,lbound-1];case"$lte":if(!Object(__WEBPACK_IMPORTED_MODULE_4__helper__["a"])(rcd[index[ubound]][prop],val)){return[min,ubound-1]}return[min,ubound];default:return[0,rcd.length-1]}}by(field,value){return this.findOne({[field]:value})}findOne(query){query=query||{};const result=this.chain().find(query,true).data();if(Array.isArray(result)&&result.length===0){return null}else{if(!this.cloneObjects){return result[0]}else{return Object(__WEBPACK_IMPORTED_MODULE_5__clone__["b"])(result[0],this.cloneMethod)}}}chain(transform,parameters){const rs=new __WEBPACK_IMPORTED_MODULE_2__resultset__["a"](this);if(transform===undefined){return rs}return rs.transform(transform,parameters)}find(query){return this.chain().find(query).data()}findOneUnindexed(prop,value){let i=this.data.length;let doc;while(i--){if(this.data[i][prop]===value){doc=this.data[i];return doc}}return null}startTransaction(){if(this.transactional){this.cachedData=Object(__WEBPACK_IMPORTED_MODULE_5__clone__["b"])(this.data,this.cloneMethod);this.cachedIndex=this.idIndex;this.cachedBinaryIndex=this.binaryIndices;for(let idx=0;idx<this._dynamicViews.length;idx++){this._dynamicViews[idx].startTransaction()}}}commit(){if(this.transactional){this.cachedData=null;this.cachedIndex=null;this.cachedBinaryIndex=null;for(let idx=0;idx<this._dynamicViews.length;idx++){this._dynamicViews[idx].commit()}}}rollback(){if(this.transactional){if(this.cachedData!==null&&this.cachedIndex!==null){this.data=this.cachedData;this.idIndex=this.cachedIndex;this.binaryIndices=this.cachedBinaryIndex}for(let idx=0;idx<this._dynamicViews.length;idx++){this._dynamicViews[idx].rollback()}}}where(fun){return this.chain().where(fun).data()}mapReduce(mapFunction,reduceFunction){try{return reduceFunction(this.data.map(mapFunction))}catch(err){throw err}}eqJoin(joinData,leftJoinProp,rightJoinProp,mapFun){return new __WEBPACK_IMPORTED_MODULE_2__resultset__["a"](this).eqJoin(joinData,leftJoinProp,rightJoinProp,mapFun)}getStage(name){if(!this.stages[name]){this.stages[name]={}}return this.stages[name]}stage(stageName,obj){const copy=JSON.parse(JSON.stringify(obj));this.getStage(stageName)[obj.$loki]=copy;return copy}commitStage(stageName,message){const stage=this.getStage(stageName);let prop;const timestamp=(new Date).getTime();for(prop in stage){this.update(stage[prop]);this.commitLog.push({timestamp:timestamp,message:message,data:JSON.parse(JSON.stringify(stage[prop]))})}this.stages[stageName]={}}extract(field){let i=0;const len=this.data.length;const isDotNotation=isDeepProperty(field);const result=[];for(i;i<len;i+=1){result.push(deepProperty(this.data[i],field,isDotNotation))}return result}max(field){return Math.max.apply(null,this.extract(field))}min(field){return Math.min.apply(null,this.extract(field))}maxRecord(field){let i=0;const len=this.data.length;const deep=isDeepProperty(field);const result={index:0,value:0};let max;for(i;i<len;i+=1){if(max!==undefined){if(max<deepProperty(this.data[i],field,deep)){max=deepProperty(this.data[i],field,deep);result.index=this.data[i].$loki}}else{max=deepProperty(this.data[i],field,deep);result.index=this.data[i].$loki}}result.value=max;return result}minRecord(field){let i=0;const len=this.data.length;const deep=isDeepProperty(field);const result={index:0,value:0};let min;for(i;i<len;i+=1){if(min!==undefined){if(min>deepProperty(this.data[i],field,deep)){min=deepProperty(this.data[i],field,deep);result.index=this.data[i].$loki}}else{min=deepProperty(this.data[i],field,deep);result.index=this.data[i].$loki}}result.value=min;return result}extractNumerical(field){return this.extract(field).map(parseFloat).filter(Number).filter(n=>!isNaN(n))}avg(field){return average(this.extractNumerical(field))}stdDev(field){return standardDeviation(this.extractNumerical(field))}mode(field){const dict={};const data=this.extract(field);data.forEach(obj=>{if(dict[obj]){dict[obj]+=1}else{dict[obj]=1}});let max;let prop;let mode;for(prop in dict){if(max){if(max<dict[prop]){mode=prop}}else{mode=prop;max=dict[prop]}}return mode}median(field){const values=this.extractNumerical(field);values.sort((a,b)=>a-b);const half=Math.floor(values.length/2);if(values.length%2){return values[half]}else{return(values[half-1]+values[half])/2}}}__webpack_exports__["a"]=Collection},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,"a",function(){return CloneMethod});__webpack_exports__["b"]=clone;var CloneMethod;(function(CloneMethod){CloneMethod[CloneMethod["PARSE_STRINGIFY"]=0]="PARSE_STRINGIFY";CloneMethod[CloneMethod["DEEP"]=1]="DEEP";CloneMethod[CloneMethod["SHALLOW"]=2]="SHALLOW";CloneMethod[CloneMethod["SHALLOW_ASSIGN"]=3]="SHALLOW_ASSIGN";CloneMethod[CloneMethod["SHALLOW_RECURSE_OBJECTS"]=4]="SHALLOW_RECURSE_OBJECTS"})(CloneMethod||(CloneMethod={}));function add(copy,key,value){if(copy instanceof Array){copy.push(value);return copy[copy.length-1]}else if(copy instanceof Object){copy[key]=value;return copy[key]}}function walk(target,copy){for(let key in target){let obj=target[key];if(obj instanceof Date){let value=new Date(obj.getTime());add(copy,key,value)}else if(obj instanceof Function){let value=obj;add(copy,key,value)}else if(obj instanceof Array){let value=[];let last=add(copy,key,value);walk(obj,last)}else if(obj instanceof Object){let value={};let last=add(copy,key,value);walk(obj,last)}else{let value=obj;add(copy,key,value)}}}function deepCopy(target){if(/number|string|boolean/.test(typeof target)){return target}if(target instanceof Date){return new Date(target.getTime())}const copy=target instanceof Array?[]:{};walk(target,copy);return copy}function clone(data,method=CloneMethod.PARSE_STRINGIFY){if(data===null||data===undefined){return null}let cloned;switch(method){case CloneMethod.PARSE_STRINGIFY:cloned=JSON.parse(JSON.stringify(data));break;case CloneMethod.DEEP:cloned=deepCopy(data);break;case CloneMethod.SHALLOW:cloned=Object.create(data.constructor.prototype);Object.assign(cloned,data);break;case CloneMethod.SHALLOW_RECURSE_OBJECTS:cloned=clone(data,CloneMethod.SHALLOW);const keys=Object.keys(data);for(let i=0;i<keys.length;i++){const key=keys[i];if(typeof data[key]==="object"&&data[key].constructor.name==="Object"){cloned[key]=clone(data[key],CloneMethod.SHALLOW_RECURSE_OBJECTS)}}break;default:break}return cloned}},function(module,__webpack_exports__,__webpack_require__){"use strict";(function(global){function getGlobal(){let glob;(function(global){glob=global})(global!==undefined&&global||this);return glob}function create(){const global=getGlobal();const sym=Symbol.for("LOKI");if(global[sym]===undefined){global[sym]={}}return global[sym]}const PLUGINS=create();__webpack_exports__["a"]=PLUGINS}).call(__webpack_exports__,__webpack_require__(4))},function(module,exports){var g;g=function(){return this}();try{g=g||Function("return this")()||(1,eval)("this")}catch(e){if(typeof window==="object")g=window}module.exports=g},function(module,__webpack_exports__,__webpack_require__){"use strict";var __WEBPACK_IMPORTED_MODULE_0__collection__=__webpack_require__(1);var __WEBPACK_IMPORTED_MODULE_1__clone__=__webpack_require__(2);var __WEBPACK_IMPORTED_MODULE_2__helper__=__webpack_require__(6);function resolveTransformObject(subObj,params,depth=0){let prop;let pname;if(++depth>=10)return subObj;for(prop in subObj){if(typeof subObj[prop]==="string"&&subObj[prop].indexOf("[%lktxp]")===0){pname=subObj[prop].substring(8);if(params[pname]!==undefined){subObj[prop]=params[pname]}}else if(typeof subObj[prop]==="object"){subObj[prop]=resolveTransformObject(subObj[prop],params,depth)}}return subObj}function resolveTransformParams(transform,params){let idx;let clonedStep;const resolvedTransform=[];if(params===undefined)return transform;for(idx=0;idx<transform.length;idx++){clonedStep=Object(__WEBPACK_IMPORTED_MODULE_1__clone__["b"])(transform[idx],__WEBPACK_IMPORTED_MODULE_1__clone__["a"].SHALLOW_RECURSE_OBJECTS);resolvedTransform.push(resolveTransformObject(clonedStep,params))}return resolvedTransform}function containsCheckFn(a){if(typeof a==="string"||Array.isArray(a)){return b=>a.indexOf(b)!==-1}else if(typeof a==="object"&&a!==null){return b=>Object.hasOwnProperty.call(a,b)}return null}function doQueryOp(val,op){for(let p in op){if(Object.hasOwnProperty.call(op,p)){return LokiOps[p](val,op[p])}}return false}const LokiOps={$eq(a,b){return a===b},$aeq(a,b){return a==b},$ne(a,b){if(b!==b){return a===a}return a!==b},$dteq(a,b){return Object(__WEBPACK_IMPORTED_MODULE_2__helper__["a"])(a,b)},$gt(a,b){return Object(__WEBPACK_IMPORTED_MODULE_2__helper__["b"])(a,b,false)},$gte(a,b){return Object(__WEBPACK_IMPORTED_MODULE_2__helper__["b"])(a,b,true)},$lt(a,b){return Object(__WEBPACK_IMPORTED_MODULE_2__helper__["c"])(a,b,false)},$lte(a,b){return Object(__WEBPACK_IMPORTED_MODULE_2__helper__["c"])(a,b,true)},$between(a,vals){if(a===undefined||a===null)return false;return Object(__WEBPACK_IMPORTED_MODULE_2__helper__["b"])(a,vals[0],true)&&Object(__WEBPACK_IMPORTED_MODULE_2__helper__["c"])(a,vals[1],true)},$in(a,b){return b.indexOf(a)!==-1},$nin(a,b){return b.indexOf(a)===-1},$keyin(a,b){return a in b},$nkeyin(a,b){return!(a in b)},$definedin(a,b){return b[a]!==undefined},$undefinedin(a,b){return b[a]===undefined},$regex(a,b){return b.test(a)},$containsString(a,b){return typeof a==="string"&&a.indexOf(b)!==-1},$containsNone(a,b){return!LokiOps.$containsAny(a,b)},$containsAny(a,b){const checkFn=containsCheckFn(a);if(checkFn!==null){return Array.isArray(b)?b.some(checkFn):checkFn(b)}return false},$contains(a,b){const checkFn=containsCheckFn(a);if(checkFn!==null){return Array.isArray(b)?b.every(checkFn):checkFn(b)}return false},$type(a,b){let type=typeof a;if(type==="object"){if(Array.isArray(a)){type="array"}else if(a instanceof Date){type="date"}}return typeof b!=="object"?type===b:doQueryOp(type,b)},$finite(a,b){return b===isFinite(a)},$size(a,b){if(Array.isArray(a)){return typeof b!=="object"?a.length===b:doQueryOp(a.length,b)}return false},$len(a,b){if(typeof a==="string"){return typeof b!=="object"?a.length===b:doQueryOp(a.length,b)}return false},$where(a,b){return b(a)===true},$not(a,b){return!doQueryOp(a,b)},$and(a,b){for(let idx=0,len=b.length;idx<len;idx+=1){if(!doQueryOp(a,b[idx])){return false}}return true},$or(a,b){for(let idx=0,len=b.length;idx<len;idx+=1){if(doQueryOp(a,b[idx])){return true}}return false}};const indexedOps={$eq:LokiOps.$eq,$aeq:true,$dteq:true,$gt:true,$gte:true,$lt:true,$lte:true,$in:true,$between:true};function dotSubScan(root,paths,fun,value,pathOffset=0){const path=paths[pathOffset];if(root===undefined||root===null||root[path]===undefined){return false}let valueFound=false;const element=root[path];if(pathOffset+1>=paths.length){valueFound=fun(element,value)}else if(Array.isArray(element)){for(let index=0,len=element.length;index<len;index+=1){valueFound=dotSubScan(element[index],paths,fun,value,pathOffset+1);if(valueFound===true){break}}}else{valueFound=dotSubScan(element,paths,fun,value,pathOffset+1)}return valueFound}class Resultset{constructor(collection){this.collection=collection;this.filteredrows=[];this.filterInitialized=false;this._scoring=null}reset(){if(this.filteredrows.length>0){this.filteredrows=[]}this.filterInitialized=false;return this}toJSON(){const copy=this.copy();copy.collection=null;return copy}limit(qty){if(!this.filterInitialized&&this.filteredrows.length===0){this.filteredrows=this.collection.prepareFullDocIndex()}this.filteredrows=this.filteredrows.slice(0,qty);this.filterInitialized=true;return this}offset(pos){if(!this.filterInitialized&&this.filteredrows.length===0){this.filteredrows=this.collection.prepareFullDocIndex()}this.filteredrows=this.filteredrows.slice(pos);this.filterInitialized=true;return this}copy(){const result=new Resultset(this.collection);if(this.filteredrows.length>0){result.filteredrows=this.filteredrows.slice()}result.filterInitialized=this.filterInitialized;return result}branch(){return this.copy()}transform(transform,parameters){let idx;let step;let rs=this;if(typeof transform==="string"){if(this.collection.transforms[transform]!==undefined){transform=this.collection.transforms[transform]}}if(typeof transform!=="object"||!Array.isArray(transform)){throw new Error("Invalid transform")}if(parameters!==undefined){transform=resolveTransformParams(transform,parameters)}for(idx=0;idx<transform.length;idx++){step=transform[idx];switch(step.type){case"find":rs.find(step.value);break;case"where":rs.where(step.value);break;case"simplesort":rs.simplesort(step.property,step.desc);break;case"compoundsort":rs.compoundsort(step.value);break;case"sort":rs.sort(step.value);break;case"limit":rs=rs.limit(step.value);break;case"offset":rs=rs.offset(step.value);break;case"map":rs=rs.map(step.value,step.dataOptions);break;case"eqJoin":rs=rs.eqJoin(step.joinData,step.leftJoinKey,step.rightJoinKey,step.mapFun,step.dataOptions);break;case"mapReduce":rs=rs.mapReduce(step.mapFunction,step.reduceFunction);break;case"update":rs.update(step.value);break;case"remove":rs.remove();break;default:break}}return rs}sort(comparefun){if(!this.filterInitialized&&this.filteredrows.length===0){this.filteredrows=this.collection.prepareFullDocIndex()}const wrappedComparer=((userComparer,data)=>(a,b)=>userComparer(data[a],data[b]))(comparefun,this.collection.data);this.filteredrows.sort(wrappedComparer);return this}simplesort(propname,isdesc){if(typeof isdesc==="undefined"){isdesc=false}if(!this.filterInitialized&&this.filteredrows.length===0){if(this.collection.binaryIndices[propname]!==undefined){this.collection.ensureIndex(propname);this.filteredrows=this.collection.binaryIndices[propname].values.slice(0);if(isdesc){this.filteredrows.reverse()}return this}else{this.filteredrows=this.collection.prepareFullDocIndex()}}const wrappedComparer=((prop,desc,data)=>(a,b)=>{let val1,val2,arr;if(~prop.indexOf(".")){arr=prop.split(".");val1=arr.reduce(function(obj,i){return obj&&obj[i]||undefined},data[a]);val2=arr.reduce(function(obj,i){return obj&&obj[i]||undefined},data[b])}else{val1=data[a][prop];val2=data[b][prop]}return Object(__WEBPACK_IMPORTED_MODULE_2__helper__["d"])(val1,val2,desc)})(propname,isdesc,this.collection.data);this.filteredrows.sort(wrappedComparer);return this}compoundsort(properties){if(properties.length===0){throw new Error("Invalid call to compoundsort, need at least one property")}let prop;if(properties.length===1){prop=properties[0];if(typeof prop==="string"){return this.simplesort(prop,false)}else{return this.simplesort(prop[0],prop[1])}}for(let i=0,len=properties.length;i<len;i+=1){prop=properties[i];if(typeof prop==="string"){properties[i]=[prop,false]}}if(!this.filterInitialized&&this.filteredrows.length===0){this.filteredrows=this.collection.prepareFullDocIndex()}const wrappedComparer=((props,data)=>(a,b)=>this._compoundeval(props,data[a],data[b]))(properties,this.collection.data);this.filteredrows.sort(wrappedComparer);return this}_compoundeval(properties,obj1,obj2){let res=0;let prop;let field;let val1,val2,arr;for(let i=0,len=properties.length;i<len;i++){prop=properties[i];field=prop[0];if(~field.indexOf(".")){arr=field.split(".");val1=arr.reduce((obj,i)=>{return obj&&obj[i]||undefined},obj1);val2=arr.reduce((obj,i)=>{return obj&&obj[i]||undefined},obj2)}else{val1=obj1[field];val2=obj2[field]}res=Object(__WEBPACK_IMPORTED_MODULE_2__helper__["d"])(val1,val2,prop[1]);if(res!==0){return res}}return 0}sortByScoring(ascending=false){if(this._scoring===null){throw new Error("No scoring available")}if(ascending){this.filteredrows.sort((a,b)=>this._scoring[a]-this._scoring[b])}else{this.filteredrows.sort((a,b)=>this._scoring[b]-this._scoring[a])}return this}findOr(expressionArray){let fr=null;let fri=0;let frlen=0;const docset=[];const idxset=[];let idx=0;const origCount=this.count();for(let ei=0,elen=expressionArray.length;ei<elen;ei++){fr=this.branch().find(expressionArray[ei]).filteredrows;frlen=fr.length;if(frlen===origCount){return this}for(fri=0;fri<frlen;fri++){idx=fr[fri];if(idxset[idx]===undefined){idxset[idx]=true;docset.push(idx)}}}this.filteredrows=docset;this.filterInitialized=true;return this}$or(expressionArray){return this.findOr(expressionArray)}findAnd(expressionArray){for(let i=0,len=expressionArray.length;i<len;i++){if(this.count()===0){return this}this.find(expressionArray[i])}return this}$and(expressionArray){return this.findAnd(expressionArray)}find(query,firstOnly=false){if(this.collection.data.length===0){this.filteredrows=[];this.filterInitialized=true;return this}const queryObject=query||"getAll";let property;let queryObjectOp;let value;if(typeof queryObject==="object"){let filters=[];for(let p in queryObject){let obj={};obj[p]=queryObject[p];filters.push(obj);if(queryObject[p]!==undefined){property=p;queryObjectOp=queryObject[p]}}if(filters.length>1){return this.find({$and:filters},firstOnly)}}if(!property||queryObject==="getAll"){if(firstOnly){this.filteredrows=this.collection.data.length>0?[0]:[];this.filterInitialized=true}return this}if(property==="$and"||property==="$or"){this[property](queryObjectOp);if(firstOnly&&this.filteredrows.length>1){this.filteredrows=this.filteredrows.slice(0,1)}return this}let operator;if(queryObjectOp===null||(typeof queryObjectOp!=="object"||queryObjectOp instanceof Date)){operator="$eq";value=queryObjectOp}else if(typeof queryObjectOp==="object"){for(let key in queryObjectOp){if(queryObjectOp[key]!==undefined){operator=key;value=queryObjectOp[key];break}}}else{throw new Error("Do not know what you want to do.")}if(operator==="$regex"){if(Array.isArray(value)){value=new RegExp(value[0],value[1])}else if(!(value instanceof RegExp)){value=new RegExp(value)}}const usingDotNotation=property.indexOf(".")!==-1;const doIndexCheck=!usingDotNotation&&!this.filterInitialized;let searchByIndex=false;if(doIndexCheck&&this.collection.binaryIndices[property]&&indexedOps[operator]){if(this.collection.adaptiveBinaryIndices!==true){this.collection.ensureIndex(property)}searchByIndex=true}const fun=LokiOps[operator];const data=this.collection.data;let result=[];if(this.filterInitialized){let filter=this.filteredrows;if(usingDotNotation){property=property.split(".");for(let i=0;i<filter.length;i++){let rowIdx=filter[i];if(dotSubScan(data[rowIdx],property,fun,value)){result.push(rowIdx)}}}else if(property==="$fts"){this._scoring=this.collection._fullTextSearch.search(query["$fts"]);let keys=Object.keys(this._scoring);for(let i=0;i<keys.length;i++){if(filter.includes(+keys[i])){result.push(+keys[i])}}}else if(this.collection.constraints.unique[property]!==undefined&&operator=="$eq"){let row=this.collection.constraints.unique[property].get(value);if(filter.includes(row)){result.push(row)}}else{for(let i=0;i<filter.length;i++){let rowIdx=filter[i];if(fun(data[rowIdx][property],value)){result.push(rowIdx)}}}this.filteredrows=result;this.filterInitialized=true;return this}this.filteredrows=result;this.filterInitialized=true;if(property==="$fts"){this._scoring=this.collection._fullTextSearch.search(query["$fts"]);let keys=Object.keys(this._scoring);for(let i=0;i<keys.length;i++){result.push(+keys[i])}return this}if(this.collection.constraints.unique[property]!==undefined&&operator=="$eq"){result.push(this.collection.constraints.unique[property].get(value));return this}if(!searchByIndex){if(usingDotNotation){property=property.split(".");for(let i=0;i<data.length;i++){if(dotSubScan(data[i],property,fun,value)){result.push(i);if(firstOnly){return this}}}}else{for(let i=0;i<data.length;i++){if(fun(data[i][property],value)){result.push(i);if(firstOnly){return this}}}}return this}let index=this.collection.binaryIndices[property];if(operator!=="$in"){const segm=this.collection.calculateRange(operator,property,value);for(let i=segm[0];i<=segm[1];i++){if(indexedOps[operator]!==true){if(indexedOps[operator](data[index.values[i]][property],value)){result.push(index.values[i]);if(firstOnly){return this}}}else{result.push(index.values[i]);if(firstOnly){return this}}}}else{const idxset=[];for(let j=0,len=value.length;j<len;j++){const segm=this.collection.calculateRange("$eq",property,value[j]);for(let i=segm[0];i<=segm[1];i++){if(idxset[i]===undefined){idxset[i]=true;result.push(index.values[i])}if(firstOnly){return this}}}}return this}where(fun){let viewFunction;let result=[];if("function"===typeof fun){viewFunction=fun}else{throw new TypeError("Argument is not a stored view or a function")}try{if(this.filterInitialized){let j=this.filteredrows.length;while(j--){if(viewFunction(this.collection.data[this.filteredrows[j]])===true){result.push(this.filteredrows[j])}}this.filteredrows=result;return this}else{let k=this.collection.data.length;while(k--){if(viewFunction(this.collection.data[k])===true){result.push(k)}}this.filteredrows=result;this.filterInitialized=true;return this}}catch(err){throw err}}count(){if(this.filterInitialized){return this.filteredrows.length}return this.collection.count()}data(options={}){let forceClones;let forceCloneMethod;let removeMeta;({forceClones:forceClones,forceCloneMethod:forceCloneMethod=this.collection.cloneMethod,removeMeta:removeMeta=false}=options);let result=[];let data=this.collection.data;let obj;let len;let i;let method;if(removeMeta&&!forceClones){forceClones=true;forceCloneMethod=__WEBPACK_IMPORTED_MODULE_1__clone__["a"].SHALLOW}if(!this.collection.disableDeltaChangesApi){forceClones=true;forceCloneMethod=__WEBPACK_IMPORTED_MODULE_1__clone__["a"].DEEP}if(!this.filterInitialized){if(this.filteredrows.length===0){if(this.collection.cloneObjects||forceClones){len=data.length;method=forceCloneMethod;for(i=0;i<len;i++){obj=Object(__WEBPACK_IMPORTED_MODULE_1__clone__["b"])(data[i],method);if(removeMeta){delete obj.$loki;delete obj.meta}result.push(obj)}return result}else{return data.slice()}}else{this.filterInitialized=true}}const fr=this.filteredrows;len=fr.length;if(this.collection.cloneObjects||forceClones){method=forceCloneMethod;for(i=0;i<len;i++){obj=Object(__WEBPACK_IMPORTED_MODULE_1__clone__["b"])(data[fr[i]],method);if(removeMeta){delete obj.$loki;delete obj.meta}result.push(obj)}}else{for(i=0;i<len;i++){result.push(data[fr[i]])}}return result}update(updateFunction){if(!this.filterInitialized&&this.filteredrows.length===0){this.filteredrows=this.collection.prepareFullDocIndex()}const len=this.filteredrows.length;const rcd=this.collection.data;for(let idx=0;idx<len;idx++){updateFunction(rcd[this.filteredrows[idx]]);this.collection.update(rcd[this.filteredrows[idx]])}return this}remove(){if(!this.filterInitialized&&this.filteredrows.length===0){this.filteredrows=this.collection.prepareFullDocIndex()}this.collection.remove(this.data());this.filteredrows=[];return this}mapReduce(mapFunction,reduceFunction){try{return reduceFunction(this.data().map(mapFunction))}catch(err){throw err}}eqJoin(joinData,leftJoinKey,rightJoinKey,mapFun,dataOptions){let leftData=[];let leftDataLength;let rightData=[];let rightDataLength;let key;let result=[];let leftKeyisFunction=typeof leftJoinKey==="function";let rightKeyisFunction=typeof rightJoinKey==="function";let joinMap={};leftData=this.data(dataOptions);leftDataLength=leftData.length;if(joinData instanceof __WEBPACK_IMPORTED_MODULE_0__collection__["a"]){rightData=joinData.chain().data(dataOptions)}else if(joinData instanceof Resultset){rightData=joinData.data(dataOptions)}else if(Array.isArray(joinData)){rightData=joinData}else{throw new TypeError("joinData needs to be an array or result set")}rightDataLength=rightData.length;for(let i=0;i<rightDataLength;i++){key=rightKeyisFunction?rightJoinKey(rightData[i]):rightData[i][rightJoinKey];joinMap[key]=rightData[i]}if(!mapFun){mapFun=((left,right)=>({left:left,right:right}))}for(let j=0;j<leftDataLength;j++){key=leftKeyisFunction?leftJoinKey(leftData[j]):leftData[j][leftJoinKey];result.push(mapFun(leftData[j],joinMap[key]||{}))}this.collection=new __WEBPACK_IMPORTED_MODULE_0__collection__["a"]("joinData");this.collection.insert(result);this.filteredrows=[];this.filterInitialized=false;return this}map(mapFun,dataOptions){let data=this.data(dataOptions).map(mapFun);this.collection=new __WEBPACK_IMPORTED_MODULE_0__collection__["a"]("mappedData");this.collection.insert(data);this.filteredrows=[];this.filterInitialized=false;return this}}__webpack_exports__["a"]=Resultset},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_exports__["a"]=aeqHelper;__webpack_exports__["c"]=ltHelper;__webpack_exports__["b"]=gtHelper;__webpack_exports__["d"]=sortHelper;function aeqHelper(prop1,prop2){let cv1;let cv2;let t1;let t2;if(prop1===prop2)return true;if(!prop1||!prop2||prop1===true||prop2===true||prop1!==prop1||prop2!==prop2){switch(prop1){case undefined:t1=1;break;case null:t1=1;break;case false:t1=3;break;case true:t1=4;break;case"":t1=5;break;default:t1=prop1===prop1?9:0;break}switch(prop2){case undefined:t2=1;break;case null:t2=1;break;case false:t2=3;break;case true:t2=4;break;case"":t2=5;break;default:t2=prop2===prop2?9:0;break}if(t1!==9||t2!==9){return t1===t2}}cv1=Number(prop1);cv2=Number(prop2);if(cv1===cv1||cv2===cv2){return cv1===cv2}cv1=prop1.toString();cv2=prop2.toString();return cv1==cv2}function ltHelper(prop1,prop2,equal){let cv1;let cv2;let t1;let t2;if(!prop1||!prop2||prop1===true||prop2===true||prop1!==prop1||prop2!==prop2){switch(prop1){case undefined:t1=1;break;case null:t1=1;break;case false:t1=3;break;case true:t1=4;break;case"":t1=5;break;default:t1=prop1===prop1?9:0;break}switch(prop2){case undefined:t2=1;break;case null:t2=1;break;case false:t2=3;break;case true:t2=4;break;case"":t2=5;break;default:t2=prop2===prop2?9:0;break}if(t1!==9||t2!==9){return t1===t2?equal:t1<t2}}cv1=Number(prop1);cv2=Number(prop2);if(cv1===cv1&&cv2===cv2){if(cv1<cv2)return true;if(cv1>cv2)return false;return equal}if(cv1===cv1&&cv2!==cv2){return true}if(cv2===cv2&&cv1!==cv1){return false}if(prop1<prop2)return true;if(prop1>prop2)return false;if(prop1==prop2)return equal;cv1=prop1.toString();cv2=prop2.toString();if(cv1<cv2){return true}if(cv1==cv2){return equal}return false}function gtHelper(prop1,prop2,equal){let cv1;let cv2;let t1;let t2;if(!prop1||!prop2||prop1===true||prop2===true||prop1!==prop1||prop2!==prop2){switch(prop1){case undefined:t1=1;break;case null:t1=1;break;case false:t1=3;break;case true:t1=4;break;case"":t1=5;break;default:t1=prop1===prop1?9:0;break}switch(prop2){case undefined:t2=1;break;case null:t2=1;break;case false:t2=3;break;case true:t2=4;break;case"":t2=5;break;default:t2=prop2===prop2?9:0;break}if(t1!==9||t2!==9){return t1===t2?equal:t1>t2}}cv1=Number(prop1);cv2=Number(prop2);if(cv1===cv1&&cv2===cv2){if(cv1>cv2)return true;if(cv1<cv2)return false;return equal}if(cv1===cv1&&cv2!==cv2){return false}if(cv2===cv2&&cv1!==cv1){return true}if(prop1>prop2)return true;if(prop1<prop2)return false;if(prop1==prop2)return equal;cv1=prop1.toString();cv2=prop2.toString();if(cv1>cv2){return true}if(cv1==cv2){return equal}return false}function sortHelper(prop1,prop2,desc){if(aeqHelper(prop1,prop2))return 0;if(ltHelper(prop1,prop2,false)){return desc?1:-1}if(gtHelper(prop1,prop2,false)){return desc?-1:1}return 0}},function(module,__webpack_exports__,__webpack_require__){"use strict";var __WEBPACK_IMPORTED_MODULE_0__tokenizer__=__webpack_require__(13);class InvertedIndex{constructor(options={}){this._docCount=0;this._docStore={};this._totalFieldLength=0;this._root={};({store:this._store=true,optimizeChanges:this._optimizeChanges=true,tokenizer:this._tokenizer=new __WEBPACK_IMPORTED_MODULE_0__tokenizer__["a"]}=options)}get store(){return this._store}get tokenizer(){return this._tokenizer}get documentCount(){return this._docCount}get documentStore(){return this._docStore}get totalFieldLength(){return this._totalFieldLength}get root(){return this._root}insert(field,docId){if(this._docStore[docId]!==undefined){throw Error("Field already added.")}this._docCount+=1;this._docStore[docId]={};const fieldTokens=this._tokenizer.tokenize(field);this._totalFieldLength+=fieldTokens.length;const termRefs=[];this._docStore[docId]={fieldLength:fieldTokens.length};if(this._optimizeChanges){Object.defineProperties(this._docStore[docId],{termRefs:{enumerable:false,configurable:true,writable:true,value:termRefs}})}for(const term of new Set(fieldTokens)){if(term===""){continue}let tf=0;for(let j=0;j<fieldTokens.length;j++){if(fieldTokens[j]===term){++tf}}let branch=this._root;for(let i=0;i<term.length;i++){const c=term[i];if(branch[c]===undefined){const child={};if(this._optimizeChanges){Object.defineProperties(child,{pa:{enumerable:false,configurable:true,writable:true,value:branch}})}branch[c]=child}branch=branch[c]}if(branch.dc===undefined){branch.dc={};branch.df=0}branch.dc[docId]=tf;branch.df+=1;termRefs.push(branch)}}remove(docId){if(this._docStore[docId]===undefined){return}const docStore=this._docStore[docId];delete this._docStore[docId];this._docCount-=1;this._totalFieldLength-=docStore.fieldLength;if(this._optimizeChanges){const termRefs=docStore.termRefs;for(let j=0;j<termRefs.length;j++){let index=termRefs[j];index.df-=1;delete index.dc[docId];if(index.df===0){delete index.df;delete index.dc;if(Object.keys(index).length!==0){continue}let keys=[];do{const parent=index.pa;delete index.pa;keys=Object.keys(parent);for(let k=0;k<keys.length;k++){const key=keys[k];if(key.length!==1){continue}if(parent[key]===index){delete parent[key];break}}index=parent}while(index.pa!==undefined&&keys.length===1)}}}else{const recursive=root=>{const keys=Object.keys(root);for(let i=0;i<keys.length;i++){const key=keys[i];if(key.length===1){if(recursive(root[key])){delete root[key]}}}if(root.df!==undefined){if(root.dc[docId]!==undefined){root.df-=1;delete root.dc[docId];if(root.df===0){delete root.df;delete root.dc}}}return Object.keys(root).length===0};recursive(this._root)}}static getTermIndex(term,root,start=0){if(start>=term.length){return null}for(let i=start;i<term.length;i++){if(root[term[i]]===undefined){return null}root=root[term[i]]}return root}static getNextTermIndex(root){const termIndices=[];const keys=Object.keys(root);for(let i=0;i<keys.length;i++){if(keys[i].length===1){termIndices.push({index:root[keys[i]],term:keys[i]})}}return termIndices}static extendTermIndex(root){const termIndices=[];const stack=[root];const treeStack=[""];do{const root=stack.pop();const treeTerm=treeStack.pop();if(root.df!==undefined){termIndices.push({index:root,term:treeTerm})}const keys=Object.keys(root);for(let i=0;i<keys.length;i++){if(keys[i].length===1){stack.push(root[keys[i]]);treeStack.push(treeTerm+keys[i])}}}while(stack.length!==0);return termIndices}toJSON(){if(this._store){return this}return{_store:false,_optimizeChanges:this._optimizeChanges,_tokenizer:this._tokenizer}}static fromJSONObject(serialized,funcTok=undefined){const invIdx=new InvertedIndex({store:serialized._store,optimizeChanges:serialized._optimizeChanges,tokenizer:__WEBPACK_IMPORTED_MODULE_0__tokenizer__["a"].fromJSONObject(serialized._tokenizer,funcTok)});if(invIdx._store){invIdx._docCount=serialized._docCount;invIdx._docStore=serialized._docStore;invIdx._totalFieldLength=serialized._totalFieldLength;invIdx._root=serialized._root}const regenerate=(index,parent)=>{if(parent!==null){Object.defineProperties(index,{pa:{enumerable:false,configurable:true,writable:false,value:parent}})}const keys=Object.keys(index);for(let i=0;i<keys.length;i++){if(keys[i]==="dc"){const docIds=Object.keys(index.dc);for(let j=0;j<docIds.length;j++){const ref=invIdx._docStore[docIds[j]];if(ref.termRefs===undefined){Object.defineProperties(ref,{termRefs:{enumerable:false,configurable:true,writable:true,value:[]}})}ref.termRefs.push(index)}}else if(keys[i].length===1){regenerate(index[keys[i]],index)}}};if(invIdx._optimizeChanges){regenerate(invIdx._root,null)}return invIdx}}__webpack_exports__["a"]=InvertedIndex},function(module,__webpack_exports__,__webpack_require__){"use strict";Object.defineProperty(__webpack_exports__,"__esModule",{value:true});var __WEBPACK_IMPORTED_MODULE_0__loki__=__webpack_require__(9);var __WEBPACK_IMPORTED_MODULE_1__collection__=__webpack_require__(1);__webpack_require__.d(__webpack_exports__,"Loki",function(){return __WEBPACK_IMPORTED_MODULE_0__loki__["a"]});__webpack_require__.d(__webpack_exports__,"Collection",function(){return __WEBPACK_IMPORTED_MODULE_1__collection__["a"]});__webpack_exports__["default"]={Loki:__WEBPACK_IMPORTED_MODULE_0__loki__["a"]}},function(module,__webpack_exports__,__webpack_require__){"use strict";(function(global){var __WEBPACK_IMPORTED_MODULE_0__event_emitter__=__webpack_require__(0);var __WEBPACK_IMPORTED_MODULE_1__collection__=__webpack_require__(1);var __WEBPACK_IMPORTED_MODULE_2__common_plugin__=__webpack_require__(3);function getENV(){if(global!==undefined&&(global["android"]||global["NSObject"])){return Loki.Environment.NATIVE_SCRIPT}const isNode=global!==undefined&&{}.toString.call(global)==="[object global]";if(isNode){if(global["window"]){return Loki.Environment.NODE_JS}else{return Loki.Environment.NODE_JS}}const isBrowser=window!==undefined&&{}.toString.call(window)==="[object Window]";if(document!==undefined){if(document.URL.indexOf("http://")===-1&&document.URL.indexOf("https://")===-1){return Loki.Environment.CORDOVA}return Loki.Environment.BROWSER}if(!isBrowser){throw SyntaxError("Unknown environment...")}}class Loki extends __WEBPACK_IMPORTED_MODULE_0__event_emitter__["a"]{constructor(filename="loki.db",options={}){super();this.filename=filename;this._collections=[];({serializationMethod:this._serializationMethod=Loki.SerializationMethod.NORMAL,destructureDelimiter:this._destructureDelimiter="$<\n",verbose:this._verbose=false,env:this._env=getENV()}=options);this.databaseVersion=1.5;this.engineVersion=1.5;this._autosave=false;this._autosaveInterval=5e3;this._autosaveHandle=null;this._throttledSaves=true;this._persistenceMethod=null;this._persistenceAdapter=null;this._throttledSaveRunning=null;this._throttledSavePending=null;this.events={init:[],loaded:[],flushChanges:[],close:[],changes:[],warning:[]};this.on("init",this.clearChanges)}initializePersistence(options={}){({autosave:this._autosave=false,autosaveInterval:this._autosaveInterval=5e3,persistenceMethod:this._persistenceMethod,throttledSaves:this._throttledSaves=true}=options);const DEFAULT_PERSISTENCE={[Loki.Environment.NODE_JS]:[Loki.PersistenceMethod.FS_STORAGE],[Loki.Environment.BROWSER]:[Loki.PersistenceMethod.LOCAL_STORAGE,Loki.PersistenceMethod.INDEXED_STORAGE],[Loki.Environment.CORDOVA]:[Loki.PersistenceMethod.LOCAL_STORAGE,Loki.PersistenceMethod.INDEXED_STORAGE],[Loki.Environment.MEMORY]:[Loki.PersistenceMethod.MEMORY_STORAGE]};const PERSISTENCE_METHODS={[Loki.PersistenceMethod.FS_STORAGE]:__WEBPACK_IMPORTED_MODULE_2__common_plugin__["a"]["LokiFSStorage"],[Loki.PersistenceMethod.LOCAL_STORAGE]:__WEBPACK_IMPORTED_MODULE_2__common_plugin__["a"]["LokiLocalStorage"],[Loki.PersistenceMethod.INDEXED_STORAGE]:__WEBPACK_IMPORTED_MODULE_2__common_plugin__["a"]["LokiIndexedStorage"],[Loki.PersistenceMethod.MEMORY_STORAGE]:__WEBPACK_IMPORTED_MODULE_2__common_plugin__["a"]["LokiMemoryStorage"]};if(this._persistenceMethod!==undefined){if(typeof PERSISTENCE_METHODS[this._persistenceMethod]==="function"){this._persistenceAdapter=new PERSISTENCE_METHODS[this._persistenceMethod]}else{throw Error("Unknown persistence method.")}}if(options.adapter!==undefined){this._persistenceMethod=Loki.PersistenceMethod.ADAPTER;this._persistenceAdapter=options.adapter}if(this._persistenceAdapter===null){let possiblePersistenceMethods=DEFAULT_PERSISTENCE[this._env];if(possiblePersistenceMethods){for(let i=0;i<possiblePersistenceMethods.length;i++){if(PERSISTENCE_METHODS[possiblePersistenceMethods[i]]){this._persistenceMethod=possiblePersistenceMethods[i];this._persistenceAdapter=new PERSISTENCE_METHODS[possiblePersistenceMethods[i]];break}}}}this.autosaveDisable();let loaded;if(options.autoload){loaded=this.loadDatabase(options.inflate)}else{loaded=Promise.resolve()}return loaded.then(()=>{if(this._autosave){this.autosaveEnable()}})}copy(options={}){const databaseCopy=new Loki(this.filename,{env:this._env});databaseCopy.loadJSONObject(this,{retainDirtyFlags:true});if(options.removeNonSerializable){databaseCopy._autosaveHandle=null;databaseCopy._persistenceAdapter=null;for(let idx=0;idx<databaseCopy._collections.length;idx++){databaseCopy._collections[idx].constraints=null;databaseCopy._collections[idx].ttl=null}}return databaseCopy}addCollection(name,options={}){const collection=new __WEBPACK_IMPORTED_MODULE_1__collection__["a"](name,options);this._collections.push(collection);if(this._verbose){collection.console=console}return collection}loadCollection(collection){if(!collection.name){throw new Error("Collection must have a name property to be loaded")}this._collections.push(collection)}getCollection(collectionName){let i;const len=this._collections.length;for(i=0;i<len;i+=1){if(this._collections[i].name===collectionName){return this._collections[i]}}this.emit("warning","collection "+collectionName+" not found");return null}renameCollection(oldName,newName){const c=this.getCollection(oldName);if(c){c.name=newName}return c}listCollections(){const colls=[];for(let i=0;i<this._collections.length;i++){colls.push({name:this._collections[i].name,count:this._collections[i].data.length})}return colls}removeCollection(collectionName){for(let i=0;i<this._collections.length;i+=1){if(this._collections[i].name===collectionName){const tmpcol=new __WEBPACK_IMPORTED_MODULE_1__collection__["a"](collectionName,{});const curcol=this._collections[i];for(const prop in curcol){if(curcol[prop]!==undefined&&tmpcol[prop]!==undefined){curcol[prop]=tmpcol[prop]}}this._collections.splice(i,1);return}}}getName(){return this.filename}serialize(options={}){if(options.serializationMethod===undefined){options.serializationMethod=this._serializationMethod}switch(options.serializationMethod){case Loki.SerializationMethod.NORMAL:return JSON.stringify(this);case Loki.SerializationMethod.PRETTY:return JSON.stringify(this,null,2);case Loki.SerializationMethod.DESTRUCTURED:return this.serializeDestructured();default:return JSON.stringify(this)}}toJSON(){return{_env:this._env,_serializationMethod:this._serializationMethod,_autosave:this._autosave,_autosaveInterval:this._autosaveInterval,_collections:this._collections,databaseVersion:this.databaseVersion,engineVersion:this.engineVersion,filename:this.filename,_persistenceAdapter:this._persistenceAdapter,_persistenceMethod:this._persistenceMethod,_throttledSaves:this._throttledSaves,_verbose:this._verbose}}serializeDestructured(options={}){if(options.partitioned===undefined){options.partitioned=false}if(options.delimited===undefined){options.delimited=true}if(options.delimiter===undefined){options.delimiter=this._destructureDelimiter}if(options.partitioned===true&&options.partition!==undefined&&options.partition>=0){return this.serializeCollection({delimited:options.delimited,delimiter:options.delimiter,collectionIndex:options.partition})}let dbcopy=new Loki(this.filename);dbcopy.loadJSONObject(this);for(let idx=0;idx<dbcopy._collections.length;idx++){dbcopy._collections[idx].data=[]}if(options.partitioned===true&&options.partition===-1){return dbcopy.serialize({serializationMethod:Loki.SerializationMethod.NORMAL})}const reconstruct=[];reconstruct.push(dbcopy.serialize({serializationMethod:Loki.SerializationMethod.NORMAL}));dbcopy=null;for(let idx=0;idx<this._collections.length;idx++){let result=this.serializeCollection({delimited:options.delimited,delimiter:options.delimiter,collectionIndex:idx});if(options.partitioned===false&&options.delimited===false){if(!Array.isArray(result)){throw new Error("a nondelimited, non partitioned collection serialization did not return an expected array")}for(let sidx=0;sidx<result.length;sidx++){reconstruct.push(result[sidx]);result[sidx]=null}reconstruct.push("")}else{reconstruct.push(result)}}if(options.partitioned){if(options.delimited){return reconstruct}else{return reconstruct}}else{if(options.delimited){reconstruct.push("");return reconstruct.join(options.delimiter)}else{reconstruct.push("");return reconstruct}}}serializeCollection(options={}){let doccount;let docidx;let resultlines=[];if(options.delimited===undefined){options.delimited=true}if(options.collectionIndex===undefined){throw new Error("serializeCollection called without 'collectionIndex' option")}doccount=this._collections[options.collectionIndex].data.length;resultlines=[];for(docidx=0;docidx<doccount;docidx++){resultlines.push(JSON.stringify(this._collections[options.collectionIndex].data[docidx]))}if(options.delimited){resultlines.push("");return resultlines.join(options.delimiter)}else{return resultlines}}deserializeDestructured(destructuredSource,options={}){let workarray=[];let len;let cdb;let collIndex=0;let collCount;let lineIndex=1;let done=false;let currObject;if(options.partitioned===undefined){options.partitioned=false}if(options.delimited===undefined){options.delimited=true}if(options.delimiter===undefined){options.delimiter=this._destructureDelimiter}if(options.partitioned){if(options.partition!==undefined){if(options.partition===-1){cdb=JSON.parse(destructuredSource[0]);return cdb}return this.deserializeCollection(destructuredSource[options.partition+1],options)}cdb=JSON.parse(destructuredSource[0]);collCount=cdb._collections.length;for(collIndex=0;collIndex<collCount;collIndex++){cdb._collections[collIndex].data=this.deserializeCollection(destructuredSource[collIndex+1],options)}return cdb}if(options.delimited){workarray=destructuredSource.split(options.delimiter);destructuredSource=null;len=workarray.length;if(len===0){return null}}else{workarray=destructuredSource}cdb=JSON.parse(workarray[0]);collCount=cdb._collections.length;workarray[0]=null;while(!done){if(workarray[lineIndex]===""){if(++collIndex>collCount){done=true}}else{currObject=JSON.parse(workarray[lineIndex]);cdb._collections[collIndex].data.push(currObject)}workarray[lineIndex++]=null}return cdb}deserializeCollection(destructuredSource,options={}){if(options.partitioned===undefined){options.partitioned=false}if(options.delimited===undefined){options.delimited=true}if(options.delimiter===undefined){options.delimiter=this._destructureDelimiter}let workarray=[];if(options.delimited){workarray=destructuredSource.split(options.delimiter);workarray.pop()}else{workarray=destructuredSource}for(let idx=0;idx<workarray.length;idx++){workarray[idx]=JSON.parse(workarray[idx])}return workarray}loadJSON(serializedDb,options){let dbObject;if(serializedDb.length===0){dbObject={}}else{switch(this._serializationMethod){case Loki.SerializationMethod.NORMAL:case Loki.SerializationMethod.PRETTY:dbObject=JSON.parse(serializedDb);break;case Loki.SerializationMethod.DESTRUCTURED:dbObject=this.deserializeDestructured(serializedDb);break;default:dbObject=JSON.parse(serializedDb);break}}this.loadJSONObject(dbObject,options)}loadJSONObject(dbObject,options={}){const len=dbObject._collections?dbObject._collections.length:0;this.filename=dbObject.filename;this._collections=[];for(let i=0;i<len;++i){this._collections.push(__WEBPACK_IMPORTED_MODULE_1__collection__["a"].fromJSONObject(dbObject._collections[i],options))}}close(){let saved;if(this._autosave){this.autosaveDisable();for(let idx=0;idx<this._collections.length;idx++){if(this._collections[idx].dirty){saved=this.saveDatabase();break}}}return Promise.resolve(saved).then(()=>{this.emit("close")})}generateChangesNotification(arrayOfCollectionNames){let changes=[];const selectedCollections=arrayOfCollectionNames||this._collections.map(coll=>coll.name);this._collections.forEach(coll=>{if(selectedCollections.indexOf(coll.name)!==-1){changes=changes.concat(coll.getChanges())}});return changes}serializeChanges(collectionNamesArray){return JSON.stringify(this.generateChangesNotification(collectionNamesArray))}clearChanges(){this._collections.forEach(coll=>{if(coll.flushChanges){coll.flushChanges()}})}throttledSaveDrain(options={}){const now=(new Date).getTime();if(!this._throttledSaves){return Promise.resolve()}if(options.recursiveWait===undefined){options.recursiveWait=true}if(options.recursiveWaitLimit===undefined){options.recursiveWaitLimit=false}if(options.recursiveWaitLimitDuration===undefined){options.recursiveWaitLimitDuration=2e3}if(options.started===undefined){options.started=new Date}if(this._throttledSaves&&this._throttledSaveRunning!==null){if(options.recursiveWait){return Promise.resolve(Promise.all([this._throttledSaveRunning,this._throttledSavePending])).then(()=>{if(this._throttledSaveRunning!==null||this._throttledSavePending!==null){if(options.recursiveWaitLimit&&now-options.started.getTime()>options.recursiveWaitLimitDuration){return Promise.reject({})}return this.throttledSaveDrain(options)}else{return Promise.resolve()}})}else{return Promise.resolve(this._throttledSaveRunning)}}else{return Promise.resolve()}}_loadDatabase(options={}){if(this._persistenceAdapter===null){return Promise.reject(new Error("persistenceAdapter not configured"))}return Promise.resolve(this._persistenceAdapter.loadDatabase(this.filename)).then(dbString=>{if(typeof dbString==="string"){this.loadJSON(dbString,options);this.emit("load",this)}else{dbString=dbString;if(typeof dbString==="object"&&dbString!==null&&!(dbString instanceof Error)){this.loadJSONObject(dbString,options);this.emit("load",this)}else{if(dbString instanceof Error)throw dbString;throw new TypeError("The persistence adapter did not load a serialized DB string or object.")}}})}loadDatabase(options={}){if(!this._throttledSaves){return this._loadDatabase(options)}return this.throttledSaveDrain(options).then(()=>{this._throttledSaveRunning=this._loadDatabase(options).then(()=>{this._throttledSaveRunning=null});return this._throttledSaveRunning},()=>{throw new Error("Unable to pause save throttling long enough to read database")})}_saveDatabase(){if(this._persistenceAdapter===null){return Promise.reject(new Error("persistenceAdapter not configured"))}let saved;if(this._persistenceAdapter.mode==="reference"&&typeof this._persistenceAdapter.exportDatabase==="function"){saved=this._persistenceAdapter.exportDatabase(this.filename,this.copy({removeNonSerializable:true}))}else{saved=this._persistenceAdapter.saveDatabase(this.filename,this.serialize())}return Promise.resolve(saved).then(()=>{for(let idx=0;idx<this._collections.length;idx++){this._collections[idx].dirty=false}this.emit("save")})}saveDatabase(){if(!this._throttledSaves){return this._saveDatabase()}if(this._throttledSaveRunning!==null&&this._throttledSavePending===null){this._throttledSavePending=Promise.resolve(this._throttledSaveRunning).then(()=>{this._throttledSaveRunning=null;this._throttledSavePending=null;return this.saveDatabase()})}if(this._throttledSavePending!==null){return this._throttledSavePending}this._throttledSaveRunning=this._saveDatabase().then(()=>{this._throttledSaveRunning=null});return this._throttledSaveRunning}deleteDatabase(){if(this._persistenceAdapter===null){return Promise.reject(new Error("persistenceAdapter not configured"))}return Promise.resolve(this._persistenceAdapter.deleteDatabase(this.filename))}autosaveEnable(){if(this._autosaveHandle){return}let running=true;this._autosave=true;this._autosaveHandle=(()=>{running=false;this._autosaveHandle=undefined});setTimeout(()=>{if(running){this.saveDatabase().then(this.saveDatabase,this.saveDatabase)}},this._autosaveInterval)}autosaveDisable(){this._autosave=false;if(this._autosaveHandle){this._autosaveHandle()}}}__webpack_exports__["a"]=Loki;(function(Loki){let SerializationMethod;(function(SerializationMethod){SerializationMethod[SerializationMethod["NORMAL"]=0]="NORMAL";SerializationMethod[SerializationMethod["PRETTY"]=1]="PRETTY";SerializationMethod[SerializationMethod["DESTRUCTURED"]=2]="DESTRUCTURED"})(SerializationMethod=Loki.SerializationMethod||(Loki.SerializationMethod={}));let PersistenceMethod;(function(PersistenceMethod){PersistenceMethod[PersistenceMethod["FS_STORAGE"]=0]="FS_STORAGE";PersistenceMethod[PersistenceMethod["LOCAL_STORAGE"]=1]="LOCAL_STORAGE";PersistenceMethod[PersistenceMethod["INDEXED_STORAGE"]=2]="INDEXED_STORAGE";PersistenceMethod[PersistenceMethod["MEMORY_STORAGE"]=3]="MEMORY_STORAGE";PersistenceMethod[PersistenceMethod["ADAPTER"]=4]="ADAPTER"})(PersistenceMethod=Loki.PersistenceMethod||(Loki.PersistenceMethod={}));let Environment;(function(Environment){Environment[Environment["NODE_JS"]=0]="NODE_JS";Environment[Environment["NATIVE_SCRIPT"]=1]="NATIVE_SCRIPT";Environment[Environment["BROWSER"]=2]="BROWSER";Environment[Environment["CORDOVA"]=3]="CORDOVA";Environment[Environment["MEMORY"]=4]="MEMORY"})(Environment=Loki.Environment||(Loki.Environment={}))})(Loki||(Loki={}))}).call(__webpack_exports__,__webpack_require__(4))},function(module,__webpack_exports__,__webpack_require__){"use strict";class UniqueIndex{constructor(propertyField){this._field=propertyField;this._keyMap={}}set(doc,row){const fieldValue=doc[this._field];if(fieldValue!==null&&fieldValue!==undefined){if(this._keyMap[fieldValue]!==undefined){throw new Error("Duplicate key for property "+this._field+": "+fieldValue)}else{this._keyMap[fieldValue]=row}}}get(index){return this._keyMap[index]}update(doc,row){const uniqueNames=Object.keys(this._keyMap);for(let i=0;i<uniqueNames.length;i++){if(row===this._keyMap[uniqueNames[i]]){delete this._keyMap[uniqueNames[i]];break}}this.set(doc,row)}remove(index){if(this._keyMap[index]!==undefined){delete this._keyMap[index]}else{throw new Error("Key is not in unique index: "+this._field)}}clear(){this._keyMap={}}}__webpack_exports__["a"]=UniqueIndex},function(module,__webpack_exports__,__webpack_require__){"use strict";var __WEBPACK_IMPORTED_MODULE_0__event_emitter__=__webpack_require__(0);var __WEBPACK_IMPORTED_MODULE_1__resultset__=__webpack_require__(5);class DynamicView extends __WEBPACK_IMPORTED_MODULE_0__event_emitter__["a"]{constructor(collection,name,options={}){super();({persistent:this._persistent=false,sortPriority:this._sortPriority=DynamicView.SortPriority.PASSIVE,minRebuildInterval:this._minRebuildInterval=1}=options);this._collection=collection;this.name=name;this._rebuildPending=false;this._resultset=new __WEBPACK_IMPORTED_MODULE_1__resultset__["a"](collection);this._resultdata=[];this._resultsdirty=false;this._cachedresultset=null;this._filterPipeline=[];this._sortFunction=null;this._sortCriteria=null;this._sortByScoring=null;this._sortDirty=false;this.events={rebuild:[]}}_rematerialize({removeWhereFilters:removeWhereFilters=false}){let fpl;let fpi;let idx;this._resultdata=[];this._resultsdirty=true;this._resultset=new __WEBPACK_IMPORTED_MODULE_1__resultset__["a"](this._collection);if(this._sortFunction||this._sortCriteria||this._sortByScoring!==null){this._sortDirty=true}if(removeWhereFilters){fpl=this._filterPipeline.length;fpi=fpl;while(fpi--){if(this._filterPipeline[fpi].type==="where"){if(fpi!==this._filterPipeline.length-1){this._filterPipeline[fpi]=this._filterPipeline[this._filterPipeline.length-1]}this._filterPipeline.length--}}}const ofp=this._filterPipeline;this._filterPipeline=[];fpl=ofp.length;for(idx=0;idx<fpl;idx++){this.applyFind(ofp[idx].val)}this.data();this.emit("rebuild",this);return this}branchResultset(transform,parameters){const rs=this._resultset.branch();if(transform===undefined){return rs}return rs.transform(transform,parameters)}toJSON(){return{name:this.name,_persistent:this._persistent,_sortPriority:this._sortPriority,_minRebuildInterval:this._minRebuildInterval,_resultset:this._resultset,_resultsdirty:true,_filterPipeline:this._filterPipeline,_sortCriteria:this._sortCriteria,_sortByScoring:this._sortByScoring,_sortDirty:this._sortDirty}}static fromJSONObject(collection,obj){let dv=new DynamicView(collection,obj.name,obj.options);dv._resultsdirty=obj._resultsdirty;dv._filterPipeline=obj._filterPipeline;dv._resultdata=[];dv._sortCriteria=obj._sortCriteria;dv._sortByScoring=obj._sortByScoring;dv._sortDirty=obj._sortDirty;dv._resultset.filteredrows=obj._resultset.filteredrows;dv._resultset.filterInitialized=obj._resultset.filterInitialized;dv._rematerialize({removeWhereFilters:true});return dv}removeFilters({queueSortPhase:queueSortPhase=false}={}){this._rebuildPending=false;this._resultset.reset();this._resultdata=[];this._resultsdirty=true;this._cachedresultset=null;this._filterPipeline=[];this._sortFunction=null;this._sortCriteria=null;this._sortByScoring=null;this._sortDirty=false;if(queueSortPhase===true){this._queueSortPhase()}}applySort(comparefun){this._sortFunction=comparefun;this._sortCriteria=null;this._sortByScoring=null;this._queueSortPhase();return this}applySortByScoring(ascending=false){this._sortFunction=null;this._sortCriteria=null;this._sortByScoring=ascending;this._queueSortPhase();return this}applySimpleSort(propname,isdesc){this._sortCriteria=[[propname,isdesc||false]];this._sortFunction=null;this._sortByScoring=null;this._queueSortPhase();return this}applySortCriteria(criteria){this._sortCriteria=criteria;this._sortFunction=null;this._sortByScoring=null;this._queueSortPhase();return this}startTransaction(){this._cachedresultset=this._resultset.copy();return this}commit(){this._cachedresultset=null;return this}rollback(){this._resultset=this._cachedresultset;if(this._persistent){this._resultdata=this._resultset.data();this.emit("rebuild",this)}return this}_indexOfFilterWithId(uid){if(typeof uid==="string"||typeof uid==="number"){for(let idx=0,len=this._filterPipeline.length;idx<len;idx+=1){if(uid===this._filterPipeline[idx].uid){return idx}}}return-1}_addFilter(filter){this._filterPipeline.push(filter);this._resultset[filter.type](filter.val)}reapplyFilters(){this._resultset.reset();this._cachedresultset=null;if(this._persistent){this._resultdata=[];this._resultsdirty=true}const filters=this._filterPipeline;this._filterPipeline=[];for(let idx=0,len=filters.length;idx<len;idx+=1){this._addFilter(filters[idx])}if(this._sortFunction||this._sortCriteria||this._sortByScoring!==null){this._queueSortPhase()}else{this._queueRebuildEvent()}return this}applyFilter(filter){const idx=this._indexOfFilterWithId(filter.uid);if(idx>=0){this._filterPipeline[idx]=filter;return this.reapplyFilters()}this._cachedresultset=null;if(this._persistent){this._resultdata=[];this._resultsdirty=true}this._addFilter(filter);if(this._sortFunction||this._sortCriteria||this._sortByScoring!==null){this._queueSortPhase()}else{this._queueRebuildEvent()}return this}applyFind(query,uid=""){this.applyFilter({type:"find",val:query,uid:uid});return this}applyWhere(fun,uid){this.applyFilter({type:"where",val:fun,uid:uid});return this}removeFilter(uid){const idx=this._indexOfFilterWithId(uid);if(idx<0){throw new Error("Dynamic view does not contain a filter with ID: "+uid)}this._filterPipeline.splice(idx,1);this.reapplyFilters();return this}count(){if(this._resultsdirty){this._resultdata=this._resultset.data()}return this._resultset.count()}data(options={}){if(this._sortDirty||this._resultsdirty){this._performSortPhase({suppressRebuildEvent:true})}return this._persistent?this._resultdata:this._resultset.data(options)}_queueRebuildEvent(){if(this._rebuildPending){return}this._rebuildPending=true;setTimeout(()=>{if(this._rebuildPending){this._rebuildPending=false;this.emit("rebuild",this)}},this._minRebuildInterval)}_queueSortPhase(){if(this._sortDirty){return}this._sortDirty=true;if(this._sortPriority===DynamicView.SortPriority.ACTIVE){setTimeout(()=>{this._performSortPhase()},this._minRebuildInterval)}else{this._queueRebuildEvent()}}_performSortPhase(options={}){if(!this._sortDirty&&!this._resultsdirty){return}if(this._sortDirty){if(this._sortFunction){this._resultset.sort(this._sortFunction)}else if(this._sortCriteria){this._resultset.compoundsort(this._sortCriteria)}else if(this._sortByScoring!==null){this._resultset.sortByScoring(this._sortByScoring)}this._sortDirty=false}if(this._persistent){this._resultdata=this._resultset.data();this._resultsdirty=false}if(!options.suppressRebuildEvent){this.emit("rebuild",this)}}_evaluateDocument(objIndex,isNew){if(!this._resultset.filterInitialized){if(this._persistent){this._resultdata=this._resultset.data()}if(this._sortFunction||this._sortCriteria){this._queueSortPhase()}else{this._queueRebuildEvent()}return}const ofr=this._resultset.filteredrows;const oldPos=isNew?-1:ofr.indexOf(+objIndex);const oldlen=ofr.length;const evalResultset=new __WEBPACK_IMPORTED_MODULE_1__resultset__["a"](this._collection);evalResultset.filteredrows=[objIndex];evalResultset.filterInitialized=true;let filter;for(let idx=0,len=this._filterPipeline.length;idx<len;idx++){filter=this._filterPipeline[idx];evalResultset[filter.type](filter.val)}const newPos=evalResultset.filteredrows.length===0?-1:0;if(oldPos===-1&&newPos===-1)return;if(oldPos===-1&&newPos!==-1){ofr.push(objIndex);if(this._persistent){this._resultdata.push(this._collection.data[objIndex])}if(this._sortFunction||this._sortCriteria){this._queueSortPhase()}else{this._queueRebuildEvent()}return}if(oldPos!==-1&&newPos===-1){if(oldPos<oldlen-1){ofr.splice(oldPos,1);if(this._persistent){this._resultdata.splice(oldPos,1)}}else{ofr.length=oldlen-1;if(this._persistent){this._resultdata.length=oldlen-1}}if(this._sortFunction||this._sortCriteria){this._queueSortPhase()}else{this._queueRebuildEvent()}return}if(oldPos!==-1&&newPos!==-1){if(this._persistent){this._resultdata[oldPos]=this._collection.data[objIndex]}if(this._sortFunction||this._sortCriteria){this._queueSortPhase()}else{this._queueRebuildEvent()}}}_removeDocument(objIndex){if(!this._resultset.filterInitialized){if(this._persistent){this._resultdata=this._resultset.data()}if(this._sortFunction||this._sortCriteria){this._queueSortPhase()}else{this._queueRebuildEvent()}return}const ofr=this._resultset.filteredrows;const oldPos=ofr.indexOf(+objIndex);let oldlen=ofr.length;let idx;if(oldPos!==-1){if(oldPos<oldlen-1){ofr[oldPos]=ofr[oldlen-1];ofr.length=oldlen-1;if(this._persistent){this._resultdata[oldPos]=this._resultdata[oldlen-1];this._resultdata.length=oldlen-1}}else{ofr.length=oldlen-1;if(this._persistent){this._resultdata.length=oldlen-1}}if(this._sortFunction||this._sortCriteria){this._queueSortPhase()}else{this._queueRebuildEvent()}}oldlen=ofr.length;for(idx=0;idx<oldlen;idx++){if(ofr[idx]>objIndex){ofr[idx]--}}}mapReduce(mapFunction,reduceFunction){try{return reduceFunction(this.data().map(mapFunction))}catch(err){throw err}}}__webpack_exports__["a"]=DynamicView;(function(DynamicView){let SortPriority;(function(SortPriority){SortPriority[SortPriority["PASSIVE"]=0]="PASSIVE";SortPriority[SortPriority["ACTIVE"]=1]="ACTIVE"})(SortPriority=DynamicView.SortPriority||(DynamicView.SortPriority={}))})(DynamicView||(DynamicView={}))},function(module,__webpack_exports__,__webpack_require__){"use strict";var __WEBPACK_IMPORTED_MODULE_0__inverted_index__=__webpack_require__(7);var __WEBPACK_IMPORTED_MODULE_1__index_searcher__=__webpack_require__(14);var __WEBPACK_IMPORTED_MODULE_2__common_plugin__=__webpack_require__(3);class FullTextSearch{constructor(fields=[],id="$loki"){this._invIdxs={};for(let i=0;i<fields.length;i++){let field=fields[i];this._invIdxs[field.name]=new __WEBPACK_IMPORTED_MODULE_0__inverted_index__["a"](field)}this._id=id;this._docs=new Set;this._idxSearcher=new __WEBPACK_IMPORTED_MODULE_1__index_searcher__["a"](this._invIdxs,this._docs)}static register(){__WEBPACK_IMPORTED_MODULE_2__common_plugin__["a"]["FullTextSearch"]=FullTextSearch}addDocument(doc,id=doc[this._id]){let fieldNames=Object.keys(doc);for(let i=0,fieldName;i<fieldNames.length,fieldName=fieldNames[i];i++){if(this._invIdxs[fieldName]!==undefined){this._invIdxs[fieldName].insert(doc[fieldName],id)}}this._docs.add(id);this.setDirty()}removeDocument(doc,id=doc[this._id]){let fieldNames=Object.keys(this._invIdxs);for(let i=0;i<fieldNames.length;i++){this._invIdxs[fieldNames[i]].remove(id)}this._docs.delete(id);this.setDirty()}updateDocument(doc,id=doc[this._id]){this.removeDocument(doc,id);this.addDocument(doc,id)}clear(){for(let id of this._docs){this.removeDocument(null,id)}}search(query){return this._idxSearcher.search(query)}toJSON(){let serialized={};let fieldNames=Object.keys(this._invIdxs);for(let i=0,fieldName;i<fieldNames.length,fieldName=fieldNames[i];i++){serialized[fieldName]=this._invIdxs[fieldName].toJSON()}return serialized}static fromJSONObject(serialized,tokenizers=[]){let fts=new FullTextSearch;let fieldNames=Object.keys(serialized);for(let i=0,fieldName;i<fieldNames.length,fieldName=fieldNames[i];i++){fts._invIdxs[fieldName]=__WEBPACK_IMPORTED_MODULE_0__inverted_index__["a"].fromJSONObject(serialized[fieldName],tokenizers[fieldName])}return fts}setDirty(){this._idxSearcher.setDirty()}}__webpack_exports__["a"]=FullTextSearch;var _unused_webpack_default_export=FullTextSearch},function(module,__webpack_exports__,__webpack_require__){"use strict";function defaultSplitter(str){let tokens=str.split(/[^\w]+/);for(let i=0;i<tokens.length;i++){tokens[i]=tokens[i].toLowerCase()}return tokens}class Tokenizer{constructor(){this._queue=[];this._symbol=Symbol("label");this.reset()}setSplitter(label,func){if(label===""){throw Error("Label cannot be empty.")}func[this._symbol]=label;this._splitter=func}getSplitter(){return[this._splitter[this._symbol],this._splitter]}resetSplitter(){this._splitter=defaultSplitter}has(labelFunc){return this._getPosition(labelFunc)!==-1}get(labelFunc){let pos=this._getPosition(labelFunc);if(pos===-1){throw Error("Cannot find existing function.")}return[this._queue[pos][this._symbol],this._queue[pos]]}add(label,func){this._addFunction(label,func,this._queue.length)}addBefore(labelFunc,label,func){let pos=this._getPosition(labelFunc);if(pos===-1){throw Error("Cannot find existing function.")}this._addFunction(label,func,pos)}addAfter(labelFunc,label,func){let pos=this._getPosition(labelFunc);if(pos===-1){throw Error("Cannot find existing function.")}this._addFunction(label,func,pos+1)}remove(labelFunc){let pos=this._getPosition(labelFunc);if(pos===-1){throw Error("Cannot find existing function.")}this._queue.splice(pos,1)}reset(){this._splitter=defaultSplitter;this._queue=[]}tokenize(str){let tokens=this._splitter(str);for(let i=0;i<this._queue.length;i++){let newTokens=[];for(let j=0;j<tokens.length;j++){let token=this._queue[i](tokens[j]);if(token){newTokens.push(token)}}tokens=newTokens}return tokens}toJSON(){let serialized={tokenizers:[]};if(this._splitter!==defaultSplitter){serialized.splitter=this._splitter[this._symbol]}for(let i=0;i<this._queue.length;i++){serialized.tokenizers.push(this._queue[i][this._symbol])}return serialized}static fromJSONObject(serialized,funcTok=undefined){let tkz=new Tokenizer;if(funcTok!==undefined&&funcTok instanceof Tokenizer){if(serialized.splitter!==undefined){let splitter=funcTok.getSplitter();if(serialized.splitter!==splitter[0]){throw Error("Splitter function not found.")}tkz.setSplitter(splitter[0],splitter[1])}for(let i=0;i<serialized.tokenizers.length;i++){if(!funcTok.has(serialized.tokenizers[i])){throw Error("Tokenizer function not found.")}let labelFunc=funcTok.get(serialized.tokenizers[i]);tkz.add(labelFunc[0],labelFunc[1])}}else{if(serialized.splitter!==undefined){if(funcTok.splitters[serialized.splitter]===undefined){throw Error("Splitter function not found.")}tkz.setSplitter(serialized.splitter,funcTok.splitters[serialized.splitter])}for(let i=0;i<serialized.tokenizers.length;i++){if(funcTok.tokenizers[serialized.tokenizers[i]]===undefined){throw Error("Tokenizer function not found.")}tkz.add(serialized.tokenizers[i],funcTok.tokenizers[serialized.tokenizers[i]])}}return tkz}_getPosition(labelFunc){if(labelFunc instanceof Function){return this._queue.indexOf(labelFunc)}else{for(let i=0;i<this._queue.length;i++){if(this._queue[i][this._symbol]===labelFunc){return i}}}return-1}_addFunction(label,func,pos){if(label===""){throw Error("Label cannot be empty.")}func[this._symbol]=label;this._queue.splice(pos,0,func)}}__webpack_exports__["a"]=Tokenizer},function(module,__webpack_exports__,__webpack_require__){"use strict";var __WEBPACK_IMPORTED_MODULE_0__scorer__=__webpack_require__(15);var __WEBPACK_IMPORTED_MODULE_1__inverted_index__=__webpack_require__(7);var __WEBPACK_IMPORTED_MODULE_2__query_builder__=__webpack_require__(16);class IndexSearcher{constructor(invIdxs,docs){this._invIdxs=invIdxs;this._docs=docs;this._scorer=new __WEBPACK_IMPORTED_MODULE_0__scorer__["a"](this._invIdxs)}search(query){let docResults=this._recursive(query.query,true);let finalScoring=query.final_scoring!==undefined?query.final_scoring:true;if(finalScoring){return this._scorer.finalScore(query,docResults)}return docResults}setDirty(){this._scorer.setDirty()}_recursive(query,doScoring){let docResults={};let boost=query.boost!==undefined?query.boost:1;let fieldName=query.field!==undefined?query.field:null;let enableScoring=query.enable_scoring!==undefined?query.enable_scoring:false;let root=null;let tokenizer=null;if(this._invIdxs[fieldName]!==undefined){root=this._invIdxs[fieldName].root;tokenizer=this._invIdxs[fieldName].tokenizer}switch(query.type){case"bool":{docResults=null;if(query.must!==undefined){docResults=this._getUnique(query.must.values,doScoring,docResults)}if(query.filter!==undefined){docResults=this._getUnique(query.filter.values,false,docResults)}if(query.should!==undefined){let shouldDocs=this._getAll(query.should.values,doScoring);let empty=false;if(docResults===null){docResults={};empty=true}let msm=1;if(query.minimum_should_match!==undefined){msm=query.minimum_should_match;let shouldLength=query.should.values.length;if(msm<=-1){msm=shouldLength+msm}else if(msm<0){msm=shouldLength-Math.floor(shouldLength*-msm)}else if(msm<1){msm=Math.floor(shouldLength*msm)}}let docs=Object.keys(shouldDocs);for(let i=0,docId;i<docs.length,docId=docs[i];i++){if(shouldDocs[docId].length>=msm){if(docResults[docId]!==undefined){docResults[docId].push(...shouldDocs[docId])}else if(empty){docResults[docId]=shouldDocs[docId]}else{delete docResults[docId]}}}}if(query.not!==undefined){let notDocs=this._getAll(query.not.values,false);let docs=Object.keys(notDocs);for(let i=0,docId;i<docs.length,docId=docs[i];i++){if(docResults[docId]!==undefined){delete docResults[docId]}}}break}case"term":{let termIdx=__WEBPACK_IMPORTED_MODULE_1__inverted_index__["a"].getTermIndex(query.value,root);this._scorer.prepare(fieldName,boost,termIdx,doScoring,docResults,query.value);break}case"terms":{for(let i=0;i<query.value.length;i++){let termIdx=__WEBPACK_IMPORTED_MODULE_1__inverted_index__["a"].getTermIndex(query.value[i],root);this._scorer.prepare(fieldName,boost,termIdx,doScoring,docResults,query.value[i])}break}case"fuzzy":{let f=fuzzySearch(query,root);for(let i=0;i<f.length;i++){this._scorer.prepare(fieldName,boost*f[i].boost,f[i].index,doScoring,docResults,f[i].term)}break}case"wildcard":{let w=wildcardSearch(query,root);for(let i=0;i<w.length;i++){this._scorer.prepare(fieldName,boost,w[i].index,doScoring&&enableScoring,docResults,w[i].term)}break}case"match_all":{for(let docId of this._docs){this._scorer.scoreConstant(boost,docId,docResults)}break}case"constant_score":{let tmpDocResults=this._getAll(query.filter.values,false);let docs=Object.keys(tmpDocResults);for(let i=0;i<docs.length;i++){this._scorer.scoreConstant(boost,docs[i],docResults)}break}case"prefix":{let termIdx=__WEBPACK_IMPORTED_MODULE_1__inverted_index__["a"].getTermIndex(query.value,root);if(termIdx!==null){const termIdxs=__WEBPACK_IMPORTED_MODULE_1__inverted_index__["a"].extendTermIndex(termIdx);for(let i=0;i<termIdxs.length;i++){this._scorer.prepare(fieldName,boost,termIdxs[i].index,doScoring&&enableScoring,docResults,query.value+termIdxs[i].term)}}break}case"exists":{if(root!==null){let docs=Object.keys(this._invIdxs[fieldName].documentStore);for(let i=0;i<docs.length;i++){this._scorer.scoreConstant(boost,docs[i],docResults)}}break}case"match":{let terms=tokenizer.tokenize(query.value);let operator=query.operator!==undefined?query.operator:"or";let tmpQuery=(new __WEBPACK_IMPORTED_MODULE_2__query_builder__["a"]).bool();if(operator==="or"){if(query.minimum_should_match!==undefined){tmpQuery=tmpQuery.minimumShouldMatch(query.minimum_should_match)}tmpQuery=tmpQuery.beginShould()}else{tmpQuery=tmpQuery.beginMust()}tmpQuery=tmpQuery.boost(boost);if(query.fuzziness!==undefined){let prefixLength=query.prefix_length!==undefined?query.prefix_length:2;let extended=query.extended!==undefined?query.extended:false;for(let i=0;i<terms.length;i++){tmpQuery=tmpQuery.fuzzy(fieldName,terms[i]).fuzziness(query.fuzziness).prefixLength(prefixLength).extended(extended)}}else{for(let i=0;i<terms.length;i++){tmpQuery=tmpQuery.term(fieldName,terms[i])}}if(operator==="or"){tmpQuery=tmpQuery.endShould()}else{tmpQuery=tmpQuery.endMust()}docResults=this._recursive(tmpQuery.build().query,doScoring);break}default:break}return docResults}_getUnique(values,doScoring,docResults){if(values.length===0){return docResults}for(let i=0;i<values.length;i++){let currDocs=this._recursive(values[i],doScoring);if(docResults===null){docResults=this._recursive(values[0],doScoring);continue}let docs=Object.keys(docResults);for(let j=0,docId;j<docs.length,docId=docs[j];j++){if(currDocs[docId]===undefined){delete docResults[docId]}else{docResults[docId].push(...currDocs[docId])}}}return docResults}_getAll(values,doScoring){let docResults={};for(let i=0;i<values.length;i++){let currDocs=this._recursive(values[i],doScoring);let docs=Object.keys(currDocs);for(let j=0,docId;j<docs.length,docId=docs[j];j++){if(docResults[docId]===undefined){docResults[docId]=currDocs[docId]}else{docResults[docId].push(...currDocs[docId])}}}return docResults}}__webpack_exports__["a"]=IndexSearcher;function levenshteinDistance(a,b){if(a.length===0)return b.length;if(b.length===0)return a.length;let tmp;let i;let j;let prev;let val;if(a.length>b.length){tmp=a;a=b;b=tmp}const row=Array(a.length+1);for(i=0;i<=a.length;i++){row[i]=i}for(i=1;i<=b.length;i++){prev=i;for(j=1;j<=a.length;j++){if(b[i-1]===a[j-1]){val=row[j-1]}else{val=Math.min(row[j-1]+1,Math.min(prev+1,row[j]+1));if(i>1&&j>1&&b[i-2]===a[j-1]&&a[j-2]===b[i-1]){val=Math.min(val,row[j-1]-(a[j-1]===b[i-1]?1:0))}}row[j-1]=prev;prev=val}row[a.length]=prev}return row[a.length]}function fuzzySearch(query,root){let value=query.value;let fuzziness=query.fuzziness!==undefined?query.fuzziness:"AUTO";if(fuzziness==="AUTO"){if(value.length<=2){fuzziness=0}else if(value.length<=5){fuzziness=1}else{fuzziness=2}}let prefixLength=query.prefix_length!==undefined?query.prefix_length:2;let extended=query.extended!==undefined?query.extended:false;let start=root;let pre=value.slice(0,prefixLength);let fuzzy=value;if(prefixLength!==0){start=__WEBPACK_IMPORTED_MODULE_1__inverted_index__["a"].getTermIndex(pre,start);fuzzy=fuzzy.slice(prefixLength)}if(start===null){return[]}if(fuzzy.length===0){return[{term:"",index:start,boost:1}]}let extend_fuzzy=1e10;let similarTokens=[];let stack=[start];let treeStack=[""];do{let index=stack.pop();let treeTerms=treeStack.pop();if(extended){if(treeTerms.length===fuzzy.length){extend_fuzzy=levenshteinDistance(fuzzy,treeTerms)}else{extend_fuzzy=extend_fuzzy<=fuzziness&&treeTerms.length>=fuzzy.length?extend_fuzzy:1e10}}if(index.df!==undefined){let matched=false;if(Math.abs(fuzzy.length-treeTerms.length)<=fuzziness){const distance=levenshteinDistance(fuzzy,treeTerms);if(distance<=fuzziness){let term=pre+treeTerms;let boost=1-distance/Math.min(term.length,value.length);similarTokens.push({term:term,index:index,boost:boost});matched=true}}if(extend_fuzzy<=fuzziness&&!matched){let term=pre+treeTerms;let boost=1-(extend_fuzzy+treeTerms.length-fuzzy.length)/Math.min(term.length,value.length);similarTokens.push({term:term,index:index,boost:boost})}}if(treeTerms.length-fuzzy.length<=fuzziness||extend_fuzzy<=fuzziness){let keys=Object.keys(index);for(let i=0;i<keys.length;i++){if(keys[i].length===1){stack.push(index[keys[i]]);treeStack.push(treeTerms+keys[i])}}}}while(stack.length!==0);return similarTokens}function wildcardSearch(query,root){let wildcard=query.value;let result=[];function recursive(index,idx=0,term="",escaped=false){if(index===null){return}if(idx===wildcard.length){if(index.df!==undefined){result.push({index:index,term:term})}return}if(!escaped&&wildcard[idx]==="\\"){recursive(index,idx+1,term,true)}else if(!escaped&&wildcard[idx]==="?"){let others=__WEBPACK_IMPORTED_MODULE_1__inverted_index__["a"].getNextTermIndex(index);for(let i=0;i<others.length;i++){recursive(others[i].index,idx+1,term+others[i].term)}}else if(!escaped&&wildcard[idx]==="*"){if(idx+1===wildcard.length){const all=__WEBPACK_IMPORTED_MODULE_1__inverted_index__["a"].extendTermIndex(index);for(let i=0;i<all.length;i++){recursive(all[i].index,idx+1,term+all[i].term)}return}recursive(index,idx+1,term);const indices=[{index:index,term:""}];do{const index=indices.pop();let others=__WEBPACK_IMPORTED_MODULE_1__inverted_index__["a"].getNextTermIndex(index.index);for(let i=0;i<others.length;i++){recursive(others[i].index,idx+1,term+index.term+others[i].term);indices.push({index:others[i].index,term:index.term+others[i].term})}}while(indices.length!==0)}else{recursive(__WEBPACK_IMPORTED_MODULE_1__inverted_index__["a"].getTermIndex(wildcard[idx],index),idx+1,term+wildcard[idx])}}recursive(root);return result}},function(module,__webpack_exports__,__webpack_require__){"use strict";class Scorer{constructor(invIdxs){this._cache={};this._invIdxs=invIdxs}setDirty(){this._cache={}}prepare(fieldName,boost,termIdx,doScoring,docResults={},term=null){if(termIdx===null||termIdx.dc===undefined){return null}const idf=this._idf(fieldName,termIdx.df);const docIds=Object.keys(termIdx.dc);for(let j=0;j<docIds.length;j++){const docId=docIds[j];if(docResults[docId]===undefined){docResults[docId]=[]}if(doScoring){const tf=termIdx.dc[docId];docResults[docId].push({type:"BM25",tf:tf,idf:idf,boost:boost,fieldName:fieldName,term:term})}else{docResults[docId]=[{type:"constant",value:1,boost:boost,fieldName:fieldName}]}}return docResults}scoreConstant(boost,docId,docResults={}){if(docResults[docId]===undefined){docResults[docId]=[]}docResults[docId].push({type:"constant",value:1,boost:boost});return docResults}finalScore(query,docResults={}){const result={};const k1=query.scoring.k1;const b=query.scoring.b;const docs=Object.keys(docResults);for(let i=0,docId;i<docs.length,docId=docs[i];i++){let docScore=0;for(let j=0;j<docResults[docId].length;j++){const docResult=docResults[docId][j];let res=0;switch(docResult.type){case"BM25":{const tf=docResult.tf;const fieldLength=Scorer._calculateFieldLength(this._invIdxs[docResult.fieldName].documentStore[docId].fieldLength);const avgFieldLength=this._avgFieldLength(docResult.fieldName);const tfNorm=tf*(k1+1)/(tf+k1*(1-b+b*(fieldLength/avgFieldLength)));res=docResult.idf*tfNorm*docResult.boost;break}case"constant":res=docResult.value*docResult.boost;break}docScore+=res}result[docId]=docScore}return result}static _calculateFieldLength(fieldLength){return fieldLength}_getCache(fieldName){if(this._cache[fieldName]===undefined){const avgFieldLength=this._invIdxs[fieldName].totalFieldLength/this._invIdxs[fieldName].documentCount;this._cache[fieldName]={idfs:{},avgFieldLength:avgFieldLength}}return this._cache[fieldName]}_idf(fieldName,docFreq){const cache=this._getCache(fieldName);if(cache.idfs[docFreq]!==undefined){return cache.idfs[docFreq]}return cache.idfs[docFreq]=Math.log(1+(this._invIdxs[fieldName].documentCount-docFreq+.5)/(docFreq+.5))}_avgFieldLength(fieldName){return this._getCache(fieldName).avgFieldLength}}__webpack_exports__["a"]=Scorer},function(module,__webpack_exports__,__webpack_require__){"use strict";class BaseQuery{constructor(type,data={}){this._data=data;this._data.type=type}boost(value){if(value<0){throw TypeError("Boost must be a positive number.")}this._data.boost=value;return this}build(){return this._data}}class TermQuery extends BaseQuery{constructor(field,term,data={}){super("term",data);this._data.field=field;this._data.value=term}}class TermsQuery extends BaseQuery{constructor(field,terms,data={}){super("terms",data);this._data.field=field;this._data.value=terms}}class WildcardQuery extends BaseQuery{constructor(field,wildcard,data={}){super("wildcard",data);this._data.field=field;this._data.value=wildcard}enableScoring(enable){this._data.enable_scoring=enable;return this}}class FuzzyQuery extends BaseQuery{constructor(field,fuzzy,data={}){super("fuzzy",data);this._data.field=field;this._data.value=fuzzy}fuzziness(fuzziness){if(fuzziness!=="AUTO"&&fuzziness<0){throw TypeError("Fuzziness must be a positive number or AUTO.")}this._data.fuzziness=fuzziness;return this}prefixLength(prefixLength){if(prefixLength<0){throw TypeError("Prefix length must be a positive number.")}this._data.prefix_length=prefixLength;return this}extended(extended){this._data.extended=extended;return this}}class PrefixQuery extends BaseQuery{constructor(field,prefix,data={}){super("prefix",data);this._data.field=field;this._data.value=prefix}enableScoring(enable){this._data.enable_scoring=enable;return this}}class ExistsQuery extends BaseQuery{constructor(field,data={}){super("exists",data);this._data.field=field}}class MatchQuery extends BaseQuery{constructor(field,query,data={}){super("match",data);this._data.field=field;this._data.value=query}minimumShouldMatch(minShouldMatch){if(this._data.operator!==undefined&&this._data.operator==="and"){throw SyntaxError('Match query with "and" operator does not support minimum should match.')}this._data.minimum_should_match=minShouldMatch;return this}operator(op){if(op!=="and"&&op!=="or"){throw SyntaxError("Unknown operator.")}this._data.operator=op;if(this._data.minimum_should_match!==undefined&&this._data.operator==="and"){throw SyntaxError('Match query with "and" operator does not support minimum should match.')}return this}fuzziness(fuzziness){if(fuzziness!=="AUTO"&&fuzziness<0){throw TypeError("Fuzziness must be a positive number or AUTO.")}this._data.fuzziness=fuzziness;return this}prefixLength(prefixLength){if(prefixLength<0){throw TypeError("Prefix length must be a positive number.")}this._data.prefix_length=prefixLength;return this}extended(extended){this._data.extended=extended;return this}}class MatchAllQuery extends BaseQuery{constructor(data={}){super("match_all",data)}}class ArrayQuery extends BaseQuery{constructor(callbackName,callback,data={}){super("array",data);this._data.values=[];this._callbackName=callbackName;this[callbackName]=callback;this._prepare=((queryType,...args)=>{const data={};const query=new queryType(...args,data);this._data.values.push(data);query.bool=this.bool;query.constantScore=this.constantScore;query.term=this.term;query.terms=this.terms;query.wildcard=this.wildcard;query.fuzzy=this.fuzzy;query.match=this.match;query.matchAll=this.matchAll;query.prefix=this.prefix;query.exists=this.exists;query._prepare=this._prepare;query[this._callbackName]=this[this._callbackName];return query})}bool(){return this._prepare(BoolQuery)}constantScore(){return this._prepare(ConstantScoreQuery)}term(field,term){return this._prepare(TermQuery,field,term)}terms(field,terms){return this._prepare(TermsQuery,field,terms)}wildcard(field,wildcard){return this._prepare(WildcardQuery,field,wildcard)}fuzzy(field,fuzzy){return this._prepare(FuzzyQuery,field,fuzzy)}match(field,query){return this._prepare(MatchQuery,field,query)}matchAll(){return this._prepare(MatchAllQuery)}prefix(field,prefix){return this._prepare(PrefixQuery,field,prefix)}exists(field){return this._prepare(ExistsQuery,field)}}class ConstantScoreQuery extends BaseQuery{constructor(data={}){super("constant_score",data)}beginFilter(){this._data.filter={};return new ArrayQuery("endFilter",()=>{return this},this._data.filter)}}class BoolQuery extends BaseQuery{constructor(data={}){super("bool",data)}beginMust(){this._data.must={};return new ArrayQuery("endMust",()=>{return this},this._data.must)}beginFilter(){this._data.filter={};return new ArrayQuery("endFilter",()=>{return this},this._data.filter)}beginShould(){this._data.should={};return new ArrayQuery("endShould",()=>{return this},this._data.should)}beginNot(){this._data.not={};return new ArrayQuery("endNot",()=>{return this},this._data.not)}minimumShouldMatch(minShouldMatch){this._data.minimum_should_match=minShouldMatch;return this}}class QueryBuilder{constructor(){this._data={query:{}};this.useBM25()}enableFinalScoring(enable){this._data.final_scoring=enable;return this}useBM25(k1=1.2,b=.75){if(k1<0){throw TypeError("BM25s k1 must be a positive number.")}if(b<0||b>1){throw TypeError("BM25s b must be a number between 0 and 1 inclusive.")}this._data.scoring={type:"BM25",k1:k1,b:b};return this}bool(){return this._prepare(BoolQuery)}constantScore(){return this._prepare(ConstantScoreQuery)}term(field,term){return this._prepare(TermQuery,field,term)}terms(field,terms){return this._prepare(TermsQuery,field,terms)}wildcard(field,wildcard){return this._prepare(WildcardQuery,field,wildcard)}fuzzy(field,fuzzy){return this._prepare(FuzzyQuery,field,fuzzy)}match(field,query){return this._prepare(MatchQuery,field,query)}matchAll(){return this._prepare(MatchAllQuery)}prefix(field,prefix){return this._prepare(PrefixQuery,field,prefix)}exists(field){return this._prepare(ExistsQuery,field)}_prepare(queryType,...args){this._child=new queryType(...args,this._data.query);this._child.build=(()=>{return this._data});return this._child}}__webpack_exports__["a"]=QueryBuilder}])});