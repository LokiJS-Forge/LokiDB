(function webpackUniversalModuleDefinition(root,factory){if(typeof exports==="object"&&typeof module==="object")module.exports=factory();else if(typeof define==="function"&&define.amd)define([],factory);else if(typeof exports==="object")exports["@lokijs/loki"]=factory();else{root["@lokijs/loki"]=factory();root["Loki"]=root["@lokijs/loki"].default}})(typeof self!=="undefined"?self:this,function(){return function(modules){var installedModules={};function __webpack_require__(moduleId){if(installedModules[moduleId]){return installedModules[moduleId].exports}var module=installedModules[moduleId]={i:moduleId,l:false,exports:{}};modules[moduleId].call(module.exports,module,module.exports,__webpack_require__);module.l=true;return module.exports}__webpack_require__.m=modules;__webpack_require__.c=installedModules;__webpack_require__.d=function(exports,name,getter){if(!__webpack_require__.o(exports,name)){Object.defineProperty(exports,name,{configurable:false,enumerable:true,get:getter})}};__webpack_require__.n=function(module){var getter=module&&module.__esModule?function getDefault(){return module["default"]}:function getModuleExports(){return module};__webpack_require__.d(getter,"a",getter);return getter};__webpack_require__.o=function(object,property){return Object.prototype.hasOwnProperty.call(object,property)};__webpack_require__.p="";return __webpack_require__(__webpack_require__.s=7)}([function(module,__webpack_exports__,__webpack_require__){"use strict";class LokiEventEmitter{constructor(){this.events={};this.asyncListeners=false}on(eventName,listener){let event;if(Array.isArray(eventName)){eventName.forEach(currentEventName=>{this.on(currentEventName,listener)});return listener}event=this.events[eventName];if(!event){event=this.events[eventName]=[]}event.push(listener);return listener}emit(eventName,...data){if(eventName&&this.events[eventName]){this.events[eventName].forEach(listener=>{if(this.asyncListeners){setTimeout(()=>{listener(...data)},1)}else{listener(...data)}})}}addListener(eventName,listener){return this.on(eventName,listener)}removeListener(eventName,listener){if(Array.isArray(eventName)){eventName.forEach(currentEventName=>{this.removeListener(currentEventName,listener)})}if(this.events[eventName]){const listeners=this.events[eventName];listeners.splice(listeners.indexOf(listener),1)}}}__webpack_exports__["a"]=LokiEventEmitter},function(module,__webpack_exports__,__webpack_require__){"use strict";var __WEBPACK_IMPORTED_MODULE_0__event_emitter__=__webpack_require__(0);var __WEBPACK_IMPORTED_MODULE_1__unique_index__=__webpack_require__(9);var __WEBPACK_IMPORTED_MODULE_2__result_set__=__webpack_require__(3);var __WEBPACK_IMPORTED_MODULE_3__dynamic_view__=__webpack_require__(10);var __WEBPACK_IMPORTED_MODULE_4__helper__=__webpack_require__(5);var __WEBPACK_IMPORTED_MODULE_5__clone__=__webpack_require__(4);var __WEBPACK_IMPORTED_MODULE_6__common_plugin__=__webpack_require__(6);function isDeepProperty(field){return field.indexOf(".")!==-1}function average(array){return array.reduce((a,b)=>a+b,0)/array.length}function standardDeviation(values){const avg=average(values);const squareDiffs=values.map(value=>{const diff=value-avg;return diff*diff});const avgSquareDiff=average(squareDiffs);return Math.sqrt(avgSquareDiff)}function deepProperty(obj,property,isDeep){if(isDeep===false){return obj[property]}const pieces=property.split(".");let root=obj;while(pieces.length>0){root=root[pieces.shift()]}return root}class Collection extends __WEBPACK_IMPORTED_MODULE_0__event_emitter__["a"]{constructor(name,options={}){super();this.name=name;this._data=[];this.idIndex=[];this.binaryIndices={};this.constraints={unique:{}};this.transforms={};this.dirty=true;this.cachedIndex=null;this.cachedBinaryIndex=null;this.cachedData=null;if(options.unique!==undefined){if(!Array.isArray(options.unique)){options.unique=[options.unique]}options.unique.forEach(prop=>{this.constraints.unique[prop]=new __WEBPACK_IMPORTED_MODULE_1__unique_index__["a"](prop)})}if(__WEBPACK_IMPORTED_MODULE_6__common_plugin__["a"]["FullTextSearch"]!==undefined){this._fullTextSearch=options.fullTextSearch!==undefined?new __WEBPACK_IMPORTED_MODULE_6__common_plugin__["a"]["FullTextSearch"](options.fullTextSearch):null}else{this._fullTextSearch=null}this.adaptiveBinaryIndices=options.adaptiveBinaryIndices!==undefined?options.adaptiveBinaryIndices:true;this.transactional=options.transactional!==undefined?options.transactional:false;this.cloneObjects=options.clone!==undefined?options.clone:false;this.asyncListeners=options.asyncListeners!==undefined?options.asyncListeners:false;this.disableChangesApi=options.disableChangesApi!==undefined?options.disableChangesApi:true;this.disableDeltaChangesApi=options.disableDeltaChangesApi!==undefined?options.disableDeltaChangesApi:true;this.cloneMethod=options.cloneMethod!==undefined?options.cloneMethod:"deep";if(this.disableChangesApi){this.disableDeltaChangesApi=true}this.serializableIndices=options.serializableIndices!==undefined?options.serializableIndices:true;this.ttl={age:null,ttlInterval:null,daemon:null};this.setTTL(options.ttl||-1,options.ttlInterval);this.maxId=0;this._dynamicViews=[];this.events={insert:[],update:[],"pre-insert":[],"pre-update":[],close:[],flushbuffer:[],error:[],delete:[],warning:[]};this.changes=[];this._ensureId();let indices=options.indices?options.indices:[];for(let idx=0;idx<indices.length;idx++){this.ensureIndex(options.indices[idx])}this.setChangesApi(this.disableChangesApi,this.disableDeltaChangesApi);this.on("insert",obj=>{this.insertHandler(obj)});this.on("update",(obj,old)=>{this.updateHandler(obj,old)});this.on("delete",obj=>{if(!this.disableChangesApi){this._createChange(this.name,"R",obj)}});this.on("warning",warning=>{this.console.warn(warning)});this.flushChanges();this.console={log(){},warn(){},error(){}};this.stages={};this.commitLog=[]}toJSON(){return{name:this.name,_dynamicViews:this._dynamicViews,uniqueNames:Object.keys(this.constraints.unique),transforms:this.transforms,binaryIndices:this.binaryIndices,_data:this._data,idIndex:this.idIndex,maxId:this.maxId,dirty:this.dirty,adaptiveBinaryIndices:this.adaptiveBinaryIndices,transactional:this.transactional,asyncListeners:this.asyncListeners,disableChangesApi:this.disableChangesApi,disableDeltaChangesApi:this.disableDeltaChangesApi,cloneObjects:this.cloneObjects,cloneMethod:this.cloneMethod,changes:this.changes,_fullTextSearch:this._fullTextSearch}}static fromJSONObject(obj,options){let coll=new Collection(obj.name,{disableChangesApi:obj.disableChangesApi,disableDeltaChangesApi:obj.disableDeltaChangesApi});coll.adaptiveBinaryIndices=obj.adaptiveBinaryIndices!==undefined?obj.adaptiveBinaryIndices===true:false;coll.transactional=obj.transactional;coll.asyncListeners=obj.asyncListeners;coll.disableChangesApi=obj.disableChangesApi;coll.cloneObjects=obj.cloneObjects;coll.cloneMethod=obj.cloneMethod||"deep";coll.changes=obj.changes;coll.dirty=options&&options.retainDirtyFlags===true?obj.dirty:false;function makeLoader(coll){const collOptions=options[coll.name];if(collOptions.proto){const inflater=collOptions.inflate||((src,dest)=>{for(let prop in src){dest[prop]=src[prop]}});return data=>{const collObj=new collOptions.proto;inflater(data,collObj);return collObj}}return collOptions.inflate}if(options&&options[obj.name]!==undefined){let loader=makeLoader(obj);for(let j=0;j<obj._data.length;j++){coll._data[j]=loader(obj._data[j])}}else{for(let j=0;j<obj._data.length;j++){coll._data[j]=obj._data[j]}}coll.maxId=obj.maxId===undefined?0:obj.maxId;coll.idIndex=obj.idIndex;if(obj.binaryIndices!==undefined){coll.binaryIndices=obj.binaryIndices}if(obj.transforms!==undefined){coll.transforms=obj.transforms}coll._ensureId();if(obj.uniqueNames!==undefined){for(let j=0;j<obj.uniqueNames.length;j++){coll.ensureUniqueIndex(obj.uniqueNames[j])}}if(obj._dynamicViews!==undefined){for(let idx=0;idx<obj._dynamicViews.length;idx++){coll._dynamicViews.push(__WEBPACK_IMPORTED_MODULE_3__dynamic_view__["a"].fromJSONObject(coll,obj._dynamicViews[idx]))}}if(obj._fullTextSearch){coll._fullTextSearch=__WEBPACK_IMPORTED_MODULE_6__common_plugin__["a"]["FullTextSearch"].fromJSONObject(obj._fullTextSearch,options.fullTextSearch)}return coll}addTransform(name,transform){if(this.transforms[name]!==undefined){throw new Error("a transform by that name already exists")}this.transforms[name]=transform}getTransform(name){return this.transforms[name]}setTransform(name,transform){this.transforms[name]=transform}removeTransform(name){delete this.transforms[name]}setTTL(age,interval){if(age<0){clearInterval(this.ttl.daemon)}else{this.ttl.age=age;this.ttl.ttlInterval=interval;this.ttl.daemon=setInterval(()=>{const now=Date.now();const toRemove=this.chain().where(member=>{const timestamp=member.meta.updated||member.meta.created;const diff=now-timestamp;return this.ttl.age<diff});toRemove.remove()},interval)}}_prepareFullDocIndex(){const indexes=new Array(this._data.length);for(let i=0;i<indexes.length;i++){indexes[i]=i}return indexes}ensureIndex(property,force=false){if(property===null||property===undefined){throw new Error("Attempting to set index without an associated property")}if(this.binaryIndices[property]&&!force){if(!this.binaryIndices[property].dirty)return}if(this.adaptiveBinaryIndices===true&&this.binaryIndices[property]!==undefined&&!force){return}const index={name:property,dirty:true,values:this._prepareFullDocIndex()};this.binaryIndices[property]=index;const data=this._data;const wrappedComparer=(a,b)=>{let val1,val2;if(~property.indexOf(".")){const arr=property.split(".");val1=arr.reduce(function(obj,i){return obj&&obj[i]||undefined},data[a]);val2=arr.reduce(function(obj,i){return obj&&obj[i]||undefined},data[b])}else{val1=data[a][property];val2=data[b][property]}if(val1!==val2){if(Object(__WEBPACK_IMPORTED_MODULE_4__helper__["c"])(val1,val2,false))return-1;if(Object(__WEBPACK_IMPORTED_MODULE_4__helper__["b"])(val1,val2,false))return 1}return 0};index.values.sort(wrappedComparer);index.dirty=false;this.dirty=true}getSequencedIndexValues(property){let idx;const idxvals=this.binaryIndices[property].values;let result="";for(idx=0;idx<idxvals.length;idx++){result+=" ["+idx+"] "+this._data[idxvals[idx]][property]}return result}ensureUniqueIndex(field){let index=new __WEBPACK_IMPORTED_MODULE_1__unique_index__["a"](field);this.constraints.unique[field]=index;for(let i=0;i<this._data.length;i++){index.set(this._data[i],i)}return index}ensureAllIndexes(force=false){const bIndices=this.binaryIndices;for(const key in bIndices){if(bIndices[key]!==undefined){this.ensureIndex(key,force)}}}flagBinaryIndexesDirty(){let key;const bIndices=this.binaryIndices;for(key in bIndices){if(bIndices[key]!==undefined){bIndices[key].dirty=true}}}flagBinaryIndexDirty(index){if(this.binaryIndices[index])this.binaryIndices[index].dirty=true}count(query){if(!query){return this._data.length}return this.chain().find(query)._filteredRows.length}_ensureId(){this.idIndex=[];for(let i=0;i<this._data.length;i++){this.idIndex.push(this._data[i].$loki)}}addDynamicView(name,options){const dv=new __WEBPACK_IMPORTED_MODULE_3__dynamic_view__["a"](this,name,options);this._dynamicViews.push(dv);return dv}removeDynamicView(name){for(let idx=0;idx<this._dynamicViews.length;idx++){if(this._dynamicViews[idx].name===name){this._dynamicViews.splice(idx,1)}}}getDynamicView(name){for(let idx=0;idx<this._dynamicViews.length;idx++){if(this._dynamicViews[idx].name===name){return this._dynamicViews[idx]}}return null}findAndUpdate(filterObject,updateFunction){if(typeof filterObject==="function"){this.updateWhere(filterObject,updateFunction)}else{this.chain().find(filterObject).update(updateFunction)}}findAndRemove(filterObject){this.chain().find(filterObject).remove()}insert(doc){if(!Array.isArray(doc)){return this.insertOne(doc)}let obj;let results=[];this.emit("pre-insert",doc);for(let i=0;i<doc.length;i++){obj=this.insertOne(doc[i],true);if(!obj){return undefined}results.push(obj)}this.emit("insert",results);results=this.cloneObjects?Object(__WEBPACK_IMPORTED_MODULE_5__clone__["a"])(results,this.cloneMethod):results;return results.length===1?results[0]:results}insertOne(doc,bulkInsert=false){let err=null;let returnObj;if(typeof doc!=="object"){err=new TypeError("Document needs to be an object")}else if(doc===null){err=new TypeError("Object cannot be null")}if(err!==null){this.emit("error",err);throw err}const obj=this.cloneObjects?Object(__WEBPACK_IMPORTED_MODULE_5__clone__["a"])(doc,this.cloneMethod):doc;if(obj.meta===undefined){obj.meta={revision:0,created:0}}if(!bulkInsert){this.emit("pre-insert",obj)}if(!this.add(obj)){return undefined}returnObj=obj;if(!bulkInsert){this.emit("insert",obj);returnObj=this.cloneObjects?Object(__WEBPACK_IMPORTED_MODULE_5__clone__["a"])(obj,this.cloneMethod):obj}return returnObj}clear({removeIndices:removeIndices=false}={}){this._data=[];this.idIndex=[];this.cachedIndex=null;this.cachedBinaryIndex=null;this.cachedData=null;this.maxId=0;this._dynamicViews=[];this.dirty=true;if(removeIndices===true){this.binaryIndices={};this.constraints={unique:{}}}else{const keys=Object.keys(this.binaryIndices);keys.forEach(biname=>{this.binaryIndices[biname].dirty=false;this.binaryIndices[biname].values=[]});const uniqueNames=Object.keys(this.constraints.unique);for(let i=0;i<uniqueNames.length;i++){this.constraints.unique[uniqueNames[i]].clear()}}if(this._fullTextSearch!==null){this._fullTextSearch.clear()}}update(doc){if(Array.isArray(doc)){let k=0;const len=doc.length;for(k;k<len;k++){this.update(doc[k])}return}if(doc.$loki===undefined){throw new Error("Trying to update unsynced document. Please save the document first by using insert() or addMany()")}try{this.startTransaction();const arr=this.get(doc.$loki,true);if(!arr){throw new Error("Trying to update a document not in collection.")}let oldInternal=arr[0];let position=arr[1];let newInternal=this.cloneObjects||!this.disableDeltaChangesApi?Object(__WEBPACK_IMPORTED_MODULE_5__clone__["a"])(doc,this.cloneMethod):doc;this.emit("pre-update",doc);Object.keys(this.constraints.unique).forEach(key=>{this.constraints.unique[key].update(newInternal,position)});this._data[position]=newInternal;for(let idx=0;idx<this._dynamicViews.length;idx++){this._dynamicViews[idx]._evaluateDocument(position,false)}if(this.adaptiveBinaryIndices){const bIndices=this.binaryIndices;for(const key in bIndices){this.adaptiveBinaryIndexUpdate(position,key)}}else{this.flagBinaryIndexesDirty()}this.idIndex[position]=newInternal.$loki;if(this._fullTextSearch!==null){this._fullTextSearch.updateDocument(doc,position)}this.commit();this.dirty=true;this.emit("update",doc,this.cloneObjects||!this.disableDeltaChangesApi?Object(__WEBPACK_IMPORTED_MODULE_5__clone__["a"])(oldInternal,this.cloneMethod):null)}catch(err){this.rollback();this.console.error(err.message);this.emit("error",err);throw err}}add(obj){if("object"!==typeof obj){throw new TypeError("Object being added needs to be an object")}if(obj["$loki"]!==undefined){throw new Error("Document is already in collection, please use update()")}try{this.startTransaction();this.maxId++;if(isNaN(this.maxId)){this.maxId=this._data[this._data.length-1].$loki+1}const newDoc=obj;newDoc.$loki=this.maxId;newDoc.meta.version=0;const constrUnique=this.constraints.unique;for(const key in constrUnique){if(constrUnique[key]!==undefined){constrUnique[key].set(newDoc,this._data.length)}}this.idIndex.push(newDoc.$loki);this._data.push(newDoc);const addedPos=this._data.length-1;const dvlen=this._dynamicViews.length;for(let i=0;i<dvlen;i++){this._dynamicViews[i]._evaluateDocument(addedPos,true)}if(this.adaptiveBinaryIndices){for(const key in this.binaryIndices){this.adaptiveBinaryIndexInsert(addedPos,key)}}else{this.flagBinaryIndexesDirty()}if(this._fullTextSearch!==null){this._fullTextSearch.addDocument(newDoc,addedPos)}this.commit();this.dirty=true;return this.cloneObjects?Object(__WEBPACK_IMPORTED_MODULE_5__clone__["a"])(newDoc,this.cloneMethod):newDoc}catch(err){this.rollback();this.console.error(err.message);this.emit("error",err);throw err}}updateWhere(filterFunction,updateFunction){const results=this.where(filterFunction);try{for(let i=0;i<results.length;i++){this.update(updateFunction(results[i]))}}catch(err){this.rollback();this.console.error(err.message)}}removeWhere(query){if(typeof query==="function"){this.remove(this._data.filter(query))}else{this.chain().find(query).remove()}}removeDataOnly(){this.remove(this._data.slice())}remove(doc){if(typeof doc==="number"){doc=this.get(doc)}if(Array.isArray(doc)){let k=0;const len=doc.length;for(k;k<len;k++){this.remove(doc[k])}return}if(doc.$loki===undefined){throw new Error("Object is not a document stored in the collection")}try{this.startTransaction();const arr=this.get(doc.$loki,true);const position=arr[1];Object.keys(this.constraints.unique).forEach(key=>{if(doc[key]!==null&&doc[key]!==undefined){this.constraints.unique[key].remove(doc[key])}});for(let idx=0;idx<this._dynamicViews.length;idx++){this._dynamicViews[idx]._removeDocument(position)}if(this.adaptiveBinaryIndices){for(const key in this.binaryIndices){this.adaptiveBinaryIndexRemove(position,key)}}else{this.flagBinaryIndexesDirty()}this._data.splice(position,1);this.idIndex.splice(position,1);if(this._fullTextSearch!==null){this._fullTextSearch.removeDocument(doc,position)}this.commit();this.dirty=true;this.emit("delete",arr[0]);delete doc.$loki;delete doc.meta}catch(err){this.rollback();this.console.error(err.message);this.emit("error",err);return null}}getChanges(){return this.changes}setChangesApi(disableChangesApi,disableDeltaChangesApi=true){this.disableChangesApi=disableChangesApi;this.disableDeltaChangesApi=disableDeltaChangesApi;if(disableChangesApi){this.disableDeltaChangesApi=true}this.insertHandler=this.disableChangesApi?this._insertMeta:this._insertMetaWithChange;this.updateHandler=this.disableChangesApi?this._updateMeta:this._updateMetaWithChange}flushChanges(){this.changes=[]}_getObjectDelta(oldObject,newObject){const propertyNames=newObject!==null&&typeof newObject==="object"?Object.keys(newObject):null;if(propertyNames&&propertyNames.length&&["string","boolean","number"].indexOf(typeof newObject)<0){const delta={};for(let i=0;i<propertyNames.length;i++){const propertyName=propertyNames[i];if(newObject.hasOwnProperty(propertyName)){if(!oldObject.hasOwnProperty(propertyName)||this.constraints.unique[propertyName]!==undefined||propertyName==="$loki"||propertyName==="meta"){delta[propertyName]=newObject[propertyName]}else{const propertyDelta=this._getObjectDelta(oldObject[propertyName],newObject[propertyName]);if(propertyDelta!==undefined&&propertyDelta!=={}){delta[propertyName]=propertyDelta}}}}return Object.keys(delta).length===0?undefined:delta}else{return oldObject===newObject?undefined:newObject}}_getChangeDelta(obj,old){if(old){return this._getObjectDelta(old,obj)}else{return JSON.parse(JSON.stringify(obj))}}_createChange(name,op,obj,old){this.changes.push({name:name,operation:op,obj:op==="U"&&!this.disableDeltaChangesApi?this._getChangeDelta(obj,old):JSON.parse(JSON.stringify(obj))})}_createInsertChange(obj){this._createChange(this.name,"I",obj)}_insertMeta(obj){let len;let idx;if(!obj){return}if(Array.isArray(obj)){len=obj.length;for(idx=0;idx<len;idx++){if(obj[idx].meta===undefined){obj[idx].meta={}}obj[idx].meta.created=(new Date).getTime();obj[idx].meta.revision=0}return}if(!obj.meta){obj.meta={}}obj.meta.created=(new Date).getTime();obj.meta.revision=0}_updateMeta(obj){if(!obj){return}obj.meta.updated=(new Date).getTime();obj.meta.revision+=1}_createUpdateChange(obj,old){this._createChange(this.name,"U",obj,old)}_insertMetaWithChange(obj){this._insertMeta(obj);this._createInsertChange(obj)}_updateMetaWithChange(obj,old){this._updateMeta(obj);this._createUpdateChange(obj,old)}get(id,returnPosition=false){const data=this.idIndex;let max=data.length-1;let min=0;let mid=min+max>>1;id=typeof id==="number"?id:parseInt(id,10);if(isNaN(id)){throw new TypeError("Passed id is not an integer")}while(data[min]<data[max]){mid=min+max>>1;if(data[mid]<id){min=mid+1}else{max=mid}}if(max===min&&data[min]===id){if(returnPosition){return[this._data[min],min]}return this._data[min]}return null}getBinaryIndexPosition(dataPosition,binaryIndexName){const val=this._data[dataPosition][binaryIndexName];const index=this.binaryIndices[binaryIndexName].values;const range=this.calculateRange("$eq",binaryIndexName,val);if(range[0]===0&&range[1]===-1){return null}const min=range[0];const max=range[1];for(let idx=min;idx<=max;idx++){if(index[idx]===dataPosition)return idx}return null}adaptiveBinaryIndexInsert(dataPosition,binaryIndexName){const index=this.binaryIndices[binaryIndexName].values;let val=this._data[dataPosition][binaryIndexName];if(this.serializableIndices===true&&val instanceof Date){this._data[dataPosition][binaryIndexName]=val.getTime();val=this._data[dataPosition][binaryIndexName]}const idxPos=index.length===0?0:this._calculateRangeStart(binaryIndexName,val,true);this.binaryIndices[binaryIndexName].values.splice(idxPos,0,dataPosition)}adaptiveBinaryIndexUpdate(dataPosition,binaryIndexName){let idxPos;const index=this.binaryIndices[binaryIndexName].values;const len=index.length;for(idxPos=0;idxPos<len;idxPos++){if(index[idxPos]===dataPosition)break}this.binaryIndices[binaryIndexName].values.splice(idxPos,1);this.adaptiveBinaryIndexInsert(dataPosition,binaryIndexName)}adaptiveBinaryIndexRemove(dataPosition,binaryIndexName,removedFromIndexOnly=false){const idxPos=this.getBinaryIndexPosition(dataPosition,binaryIndexName);if(idxPos===null){return}this.binaryIndices[binaryIndexName].values.splice(idxPos,1);if(removedFromIndexOnly===true){return}const index=this.binaryIndices[binaryIndexName].values;for(let idx=0;idx<index.length;idx++){if(index[idx]>dataPosition){index[idx]--}}}_calculateRangeStart(prop,val,adaptive=false){const rcd=this._data;const index=this.binaryIndices[prop].values;let min=0;let max=index.length-1;let mid=0;if(index.length===0){return-1}while(min<max){mid=min+max>>1;if(Object(__WEBPACK_IMPORTED_MODULE_4__helper__["c"])(rcd[index[mid]][prop],val,false)){min=mid+1}else{max=mid}}const lbound=min;if(Object(__WEBPACK_IMPORTED_MODULE_4__helper__["a"])(val,rcd[index[lbound]][prop])){return lbound}if(Object(__WEBPACK_IMPORTED_MODULE_4__helper__["c"])(val,rcd[index[lbound]][prop],false)){return adaptive?lbound:lbound-1}return adaptive?lbound+1:lbound}_calculateRangeEnd(prop,val){const rcd=this._data;const index=this.binaryIndices[prop].values;let min=0;let max=index.length-1;let mid=0;if(index.length===0){return-1}while(min<max){mid=min+max>>1;if(Object(__WEBPACK_IMPORTED_MODULE_4__helper__["c"])(val,rcd[index[mid]][prop],false)){max=mid}else{min=mid+1}}const ubound=max;if(Object(__WEBPACK_IMPORTED_MODULE_4__helper__["a"])(val,rcd[index[ubound]][prop])){return ubound}if(Object(__WEBPACK_IMPORTED_MODULE_4__helper__["b"])(val,rcd[index[ubound]][prop],false)){return ubound+1}if(Object(__WEBPACK_IMPORTED_MODULE_4__helper__["a"])(val,rcd[index[ubound-1]][prop])){return ubound-1}return ubound}calculateRange(op,prop,val){const rcd=this._data;const index=this.binaryIndices[prop].values;const min=0;const max=index.length-1;let lbound;let lval;let ubound;if(rcd.length===0){return[0,-1]}const minVal=rcd[index[min]][prop];const maxVal=rcd[index[max]][prop];switch(op){case"$eq":case"$aeq":if(Object(__WEBPACK_IMPORTED_MODULE_4__helper__["c"])(val,minVal,false)||Object(__WEBPACK_IMPORTED_MODULE_4__helper__["b"])(val,maxVal,false)){return[0,-1]}break;case"$dteq":if(Object(__WEBPACK_IMPORTED_MODULE_4__helper__["c"])(val,minVal,false)||Object(__WEBPACK_IMPORTED_MODULE_4__helper__["b"])(val,maxVal,false)){return[0,-1]}break;case"$gt":if(Object(__WEBPACK_IMPORTED_MODULE_4__helper__["b"])(val,maxVal,true)){return[0,-1]}if(Object(__WEBPACK_IMPORTED_MODULE_4__helper__["b"])(minVal,val,false)){return[min,max]}break;case"$gte":if(Object(__WEBPACK_IMPORTED_MODULE_4__helper__["b"])(val,maxVal,false)){return[0,-1]}if(Object(__WEBPACK_IMPORTED_MODULE_4__helper__["b"])(minVal,val,true)){return[min,max]}break;case"$lt":if(Object(__WEBPACK_IMPORTED_MODULE_4__helper__["c"])(val,minVal,true)){return[0,-1]}if(Object(__WEBPACK_IMPORTED_MODULE_4__helper__["c"])(maxVal,val,false)){return[min,max]}break;case"$lte":if(Object(__WEBPACK_IMPORTED_MODULE_4__helper__["c"])(val,minVal,false)){return[0,-1]}if(Object(__WEBPACK_IMPORTED_MODULE_4__helper__["c"])(maxVal,val,true)){return[min,max]}break;case"$between":if(Object(__WEBPACK_IMPORTED_MODULE_4__helper__["b"])(val[0],maxVal,false)){return[0,-1]}if(Object(__WEBPACK_IMPORTED_MODULE_4__helper__["c"])(val[1],minVal,false)){return[0,-1]}lbound=this._calculateRangeStart(prop,val[0]);ubound=this._calculateRangeEnd(prop,val[1]);if(lbound<0)lbound++;if(ubound>max)ubound--;if(!Object(__WEBPACK_IMPORTED_MODULE_4__helper__["b"])(rcd[index[lbound]][prop],val[0],true))lbound++;if(!Object(__WEBPACK_IMPORTED_MODULE_4__helper__["c"])(rcd[index[ubound]][prop],val[1],true))ubound--;if(ubound<lbound)return[0,-1];return[lbound,ubound]}switch(op){case"$eq":case"$aeq":case"$dteq":case"$gte":case"$lt":lbound=this._calculateRangeStart(prop,val);lval=rcd[index[lbound]][prop];break;default:break}switch(op){case"$eq":case"$aeq":case"$dteq":case"$lte":case"$gt":ubound=this._calculateRangeEnd(prop,val);break;default:break}switch(op){case"$eq":case"$aeq":case"$dteq":if(!Object(__WEBPACK_IMPORTED_MODULE_4__helper__["a"])(lval,val)){return[0,-1]}return[lbound,ubound];case"$gt":if(!Object(__WEBPACK_IMPORTED_MODULE_4__helper__["a"])(rcd[index[ubound]][prop],val)){return[ubound,max]}return[ubound+1,max];case"$gte":if(!Object(__WEBPACK_IMPORTED_MODULE_4__helper__["a"])(rcd[index[lbound]][prop],val)){return[lbound+1,max]}return[lbound,max];case"$lt":if(!Object(__WEBPACK_IMPORTED_MODULE_4__helper__["a"])(rcd[index[lbound]][prop],val)){return[min,lbound]}return[min,lbound-1];case"$lte":if(!Object(__WEBPACK_IMPORTED_MODULE_4__helper__["a"])(rcd[index[ubound]][prop],val)){return[min,ubound-1]}return[min,ubound];default:return[0,rcd.length-1]}}by(field,value){return this.findOne({[field]:value})}findOne(query){query=query||{};const result=this.chain().find(query,true).data();if(Array.isArray(result)&&result.length===0){return null}else{if(!this.cloneObjects){return result[0]}else{return Object(__WEBPACK_IMPORTED_MODULE_5__clone__["a"])(result[0],this.cloneMethod)}}}chain(transform,parameters){const rs=new __WEBPACK_IMPORTED_MODULE_2__result_set__["a"](this);if(transform===undefined){return rs}return rs.transform(transform,parameters)}find(query){return this.chain().find(query).data()}findOneUnindexed(prop,value){let i=this._data.length;let doc;while(i--){if(this._data[i][prop]===value){doc=this._data[i];return doc}}return null}startTransaction(){if(this.transactional){this.cachedData=Object(__WEBPACK_IMPORTED_MODULE_5__clone__["a"])(this._data,this.cloneMethod);this.cachedIndex=this.idIndex;this.cachedBinaryIndex=this.binaryIndices;for(let idx=0;idx<this._dynamicViews.length;idx++){this._dynamicViews[idx].startTransaction()}}}commit(){if(this.transactional){this.cachedData=null;this.cachedIndex=null;this.cachedBinaryIndex=null;for(let idx=0;idx<this._dynamicViews.length;idx++){this._dynamicViews[idx].commit()}}}rollback(){if(this.transactional){if(this.cachedData!==null&&this.cachedIndex!==null){this._data=this.cachedData;this.idIndex=this.cachedIndex;this.binaryIndices=this.cachedBinaryIndex}for(let idx=0;idx<this._dynamicViews.length;idx++){this._dynamicViews[idx].rollback()}}}where(fun){return this.chain().where(fun).data()}mapReduce(mapFunction,reduceFunction){return reduceFunction(this._data.map(mapFunction))}eqJoin(joinData,leftJoinProp,rightJoinProp,mapFun,dataOptions){return new __WEBPACK_IMPORTED_MODULE_2__result_set__["a"](this).eqJoin(joinData,leftJoinProp,rightJoinProp,mapFun,dataOptions)}getStage(name){if(!this.stages[name]){this.stages[name]={}}return this.stages[name]}stage(stageName,obj){const copy=JSON.parse(JSON.stringify(obj));this.getStage(stageName)[obj.$loki]=copy;return copy}commitStage(stageName,message){const stage=this.getStage(stageName);const timestamp=(new Date).getTime();for(const prop in stage){this.update(stage[prop]);this.commitLog.push({timestamp:timestamp,message:message,data:JSON.parse(JSON.stringify(stage[prop]))})}this.stages[stageName]={}}extract(field){const isDotNotation=isDeepProperty(field);const result=[];for(let i=0;i<this._data.length;i++){result.push(deepProperty(this._data[i],field,isDotNotation))}return result}max(field){return Math.max.apply(null,this.extract(field))}min(field){return Math.min.apply(null,this.extract(field))}maxRecord(field){const deep=isDeepProperty(field);const result={index:0,value:0};let max;for(let i=0;i<this._data.length;i++){if(max!==undefined){if(max<deepProperty(this._data[i],field,deep)){max=deepProperty(this._data[i],field,deep);result.index=this._data[i].$loki}}else{max=deepProperty(this._data[i],field,deep);result.index=this._data[i].$loki}}result.value=max;return result}minRecord(field){const deep=isDeepProperty(field);const result={index:0,value:0};let min;for(let i=0;i<this._data.length;i++){if(min!==undefined){if(min>deepProperty(this._data[i],field,deep)){min=deepProperty(this._data[i],field,deep);result.index=this._data[i].$loki}}else{min=deepProperty(this._data[i],field,deep);result.index=this._data[i].$loki}}result.value=min;return result}extractNumerical(field){return this.extract(field).map(parseFloat).filter(Number).filter(n=>!isNaN(n))}avg(field){return average(this.extractNumerical(field))}stdDev(field){return standardDeviation(this.extractNumerical(field))}mode(field){const dict={};const data=this.extract(field);data.forEach(obj=>{if(dict[obj]){dict[obj]+=1}else{dict[obj]=1}});let max;let prop;let mode;for(prop in dict){if(max){if(max<dict[prop]){mode=prop}}else{mode=prop;max=dict[prop]}}return mode}median(field){const values=this.extractNumerical(field);values.sort((a,b)=>a-b);const half=Math.floor(values.length/2);if(values.length%2){return values[half]}else{return(values[half-1]+values[half])/2}}}__webpack_exports__["a"]=Collection},function(module,exports){var g;g=function(){return this}();try{g=g||Function("return this")()||(1,eval)("this")}catch(e){if(typeof window==="object")g=window}module.exports=g},function(module,__webpack_exports__,__webpack_require__){"use strict";var __WEBPACK_IMPORTED_MODULE_0__collection__=__webpack_require__(1);var __WEBPACK_IMPORTED_MODULE_1__clone__=__webpack_require__(4);var __WEBPACK_IMPORTED_MODULE_2__helper__=__webpack_require__(5);function resolveTransformObject(subObj,params,depth=0){if(++depth>=10){return subObj}for(const prop in subObj){if(typeof subObj[prop]==="string"&&subObj[prop].indexOf("[%lktxp]")===0){const pname=subObj[prop].substring(8);if(params[pname]!==undefined){subObj[prop]=params[pname]}}else if(typeof subObj[prop]==="object"){subObj[prop]=resolveTransformObject(subObj[prop],params,depth)}}return subObj}function resolveTransformParams(transform,params){if(params===undefined){return transform}const resolvedTransform=[];for(let idx=0;idx<transform.length;idx++){const clonedStep=Object(__WEBPACK_IMPORTED_MODULE_1__clone__["a"])(transform[idx],"shallow-recurse-objects");resolvedTransform.push(resolveTransformObject(clonedStep,params))}return resolvedTransform}function containsCheckFn(a){if(typeof a==="string"||Array.isArray(a)){return b=>a.indexOf(b)!==-1}else if(typeof a==="object"&&a!==null){return b=>Object.hasOwnProperty.call(a,b)}return null}function doQueryOp(val,op){for(let p in op){if(Object.hasOwnProperty.call(op,p)){return LokiOps[p](val,op[p])}}return false}const LokiOps={$eq(a,b){return a===b},$aeq(a,b){return a==b},$ne(a,b){if(b!==b){return a===a}return a!==b},$dteq(a,b){return Object(__WEBPACK_IMPORTED_MODULE_2__helper__["a"])(a,b)},$gt(a,b){return Object(__WEBPACK_IMPORTED_MODULE_2__helper__["b"])(a,b,false)},$gte(a,b){return Object(__WEBPACK_IMPORTED_MODULE_2__helper__["b"])(a,b,true)},$lt(a,b){return Object(__WEBPACK_IMPORTED_MODULE_2__helper__["c"])(a,b,false)},$lte(a,b){return Object(__WEBPACK_IMPORTED_MODULE_2__helper__["c"])(a,b,true)},$between(a,range){if(a===undefined||a===null)return false;return Object(__WEBPACK_IMPORTED_MODULE_2__helper__["b"])(a,range[0],true)&&Object(__WEBPACK_IMPORTED_MODULE_2__helper__["c"])(a,range[1],true)},$in(a,b){return b.indexOf(a)!==-1},$nin(a,b){return b.indexOf(a)===-1},$keyin(a,b){return a in b},$nkeyin(a,b){return!(a in b)},$definedin(a,b){return b[a]!==undefined},$undefinedin(a,b){return b[a]===undefined},$regex(a,b){return b.test(a)},$containsString(a,b){return typeof a==="string"&&a.indexOf(b)!==-1},$containsNone(a,b){return!LokiOps.$containsAny(a,b)},$containsAny(a,b){const checkFn=containsCheckFn(a);if(checkFn!==null){return Array.isArray(b)?b.some(checkFn):checkFn(b)}return false},$contains(a,b){const checkFn=containsCheckFn(a);if(checkFn!==null){return Array.isArray(b)?b.every(checkFn):checkFn(b)}return false},$type(a,b){let type=typeof a;if(type==="object"){if(Array.isArray(a)){type="array"}else if(a instanceof Date){type="date"}}return typeof b!=="object"?type===b:doQueryOp(type,b)},$finite(a,b){return b===isFinite(a)},$size(a,b){if(Array.isArray(a)){return typeof b!=="object"?a.length===b:doQueryOp(a.length,b)}return false},$len(a,b){if(typeof a==="string"){return typeof b!=="object"?a.length===b:doQueryOp(a.length,b)}return false},$where(a,b){return b(a)===true},$not(a,b){return!doQueryOp(a,b)},$and(a,b){for(let idx=0,len=b.length;idx<len;idx++){if(!doQueryOp(a,b[idx])){return false}}return true},$or(a,b){for(let idx=0,len=b.length;idx<len;idx++){if(doQueryOp(a,b[idx])){return true}}return false}};const indexedOps={$eq:LokiOps.$eq,$aeq:true,$dteq:true,$gt:true,$gte:true,$lt:true,$lte:true,$in:true,$between:true};function dotSubScan(root,paths,fun,value,pathOffset=0){const path=paths[pathOffset];if(root===undefined||root===null||root[path]===undefined){return false}let valueFound=false;const element=root[path];if(pathOffset+1>=paths.length){valueFound=fun(element,value)}else if(Array.isArray(element)){for(let index=0,len=element.length;index<len;index++){valueFound=dotSubScan(element[index],paths,fun,value,pathOffset+1);if(valueFound===true){break}}}else{valueFound=dotSubScan(element,paths,fun,value,pathOffset+1)}return valueFound}class ResultSet{constructor(collection){this._collection=collection;this._filteredRows=[];this._filterInitialized=false;this._scoring=null}reset(){if(this._filteredRows.length>0){this._filteredRows=[]}this._filterInitialized=false;return this}toJSON(){const copy=this.copy();copy._collection=null;return copy}limit(qty){if(!this._filterInitialized&&this._filteredRows.length===0){this._filteredRows=this._collection._prepareFullDocIndex()}this._filteredRows=this._filteredRows.slice(0,qty);this._filterInitialized=true;return this}offset(pos){if(!this._filterInitialized&&this._filteredRows.length===0){this._filteredRows=this._collection._prepareFullDocIndex()}this._filteredRows=this._filteredRows.slice(pos);this._filterInitialized=true;return this}copy(){const result=new ResultSet(this._collection);result._filteredRows=this._filteredRows.slice();result._filterInitialized=this._filterInitialized;return result}branch(){return this.copy()}transform(transform,parameters){if(typeof transform==="string"){transform=this._collection.transforms[transform]}if(parameters!==undefined){transform=resolveTransformParams(transform,parameters)}let rs=this;for(let idx=0;idx<transform.length;idx++){const step=transform[idx];switch(step.type){case"find":rs.find(step.value);break;case"where":rs.where(step.value);break;case"simplesort":rs.simplesort(step.property,step.desc);break;case"compoundsort":rs.compoundsort(step.value);break;case"sort":rs.sort(step.value);break;case"sortByScoring":rs.sortByScoring(step.desc);break;case"limit":rs=rs.limit(step.value);break;case"offset":rs=rs.offset(step.value);break;case"map":rs=rs.map(step.value,step.dataOptions);break;case"eqJoin":rs=rs.eqJoin(step.joinData,step.leftJoinKey,step.rightJoinKey,step.mapFun,step.dataOptions);break;case"mapReduce":rs=rs.mapReduce(step.mapFunction,step.reduceFunction);break;case"update":rs.update(step.value);break;case"remove":rs.remove();break;default:break}}return rs}sort(comparefun){if(!this._filterInitialized&&this._filteredRows.length===0){this._filteredRows=this._collection._prepareFullDocIndex()}const data=this._collection._data;const wrappedComparer=(a,b)=>comparefun(data[a],data[b]);this._filteredRows.sort(wrappedComparer);return this}simplesort(propname,descending=false){if(!this._filterInitialized&&this._filteredRows.length===0){if(this._collection.binaryIndices[propname]!==undefined){this._collection.ensureIndex(propname);this._filteredRows=this._collection.binaryIndices[propname].values.slice(0);if(descending){this._filteredRows.reverse()}return this}else{this._filteredRows=this._collection._prepareFullDocIndex()}}const data=this._collection._data;const wrappedComparer=(a,b)=>{let val1,val2;if(~propname.indexOf(".")){const arr=propname.split(".");val1=arr.reduce(function(obj,i){return obj&&obj[i]||undefined},data[a]);val2=arr.reduce(function(obj,i){return obj&&obj[i]||undefined},data[b])}else{val1=data[a][propname];val2=data[b][propname]}return Object(__WEBPACK_IMPORTED_MODULE_2__helper__["d"])(val1,val2,descending)};this._filteredRows.sort(wrappedComparer);return this}compoundsort(properties){if(properties.length===0){throw new Error("Invalid call to compoundsort, need at least one property")}if(properties.length===1){const prop=properties[0];if(typeof prop==="string"){return this.simplesort(prop,false)}else{return this.simplesort(prop[0],prop[1])}}for(let i=0,len=properties.length;i<len;i++){const prop=properties[i];if(typeof prop==="string"){properties[i]=[prop,false]}}if(!this._filterInitialized&&this._filteredRows.length===0){this._filteredRows=this._collection._prepareFullDocIndex()}const data=this._collection._data;const wrappedComparer=(a,b)=>this._compoundeval(properties,data[a],data[b]);this._filteredRows.sort(wrappedComparer);return this}_compoundeval(properties,obj1,obj2){for(let i=0,len=properties.length;i<len;i++){const prop=properties[i];const field=prop[0];let val1,val2,arr;if(~field.indexOf(".")){arr=field.split(".");val1=arr.reduce((obj,i)=>{return obj&&obj[i]||undefined},obj1);val2=arr.reduce((obj,i)=>{return obj&&obj[i]||undefined},obj2)}else{val1=obj1[field];val2=obj2[field]}const res=Object(__WEBPACK_IMPORTED_MODULE_2__helper__["d"])(val1,val2,prop[1]);if(res!==0){return res}}return 0}sortByScoring(ascending=false){if(this._scoring===null){throw new Error("No scoring available")}if(ascending){this._filteredRows.sort((a,b)=>this._scoring[a].score-this._scoring[b].score)}else{this._filteredRows.sort((a,b)=>this._scoring[b].score-this._scoring[a].score)}return this}getScoring(){if(this._scoring===null){throw new Error("No scoring available")}return this._scoring}findOr(expressionArray){const docset=[];const idxset=[];const origCount=this.count();for(let ei=0,elen=expressionArray.length;ei<elen;ei++){const fr=this.branch().find(expressionArray[ei])._filteredRows;const frlen=fr.length;if(frlen===origCount){return this}for(let fri=0;fri<frlen;fri++){const idx=fr[fri];if(idxset[idx]===undefined){idxset[idx]=true;docset.push(idx)}}}this._filteredRows=docset;this._filterInitialized=true;return this}$or(expressionArray){return this.findOr(expressionArray)}findAnd(expressionArray){for(let i=0,len=expressionArray.length;i<len;i++){if(this.count()===0){return this}this.find(expressionArray[i])}return this}$and(expressionArray){return this.findAnd(expressionArray)}find(query,firstOnly=false){if(this._collection._data.length===0){this._filteredRows=[];this._filterInitialized=true;return this}const queryObject=query||"getAll";let property;let queryObjectOp;let value;if(typeof queryObject==="object"){let filters=[];for(let p in queryObject){let obj={};obj[p]=queryObject[p];filters.push(obj);if(queryObject[p]!==undefined){property=p;queryObjectOp=queryObject[p]}}if(filters.length>1){return this.find({$and:filters},firstOnly)}}if(!property||queryObject==="getAll"){if(firstOnly){this._filteredRows=this._collection._data.length>0?[0]:[];this._filterInitialized=true}return this}if(property==="$and"||property==="$or"){this[property](queryObjectOp);if(firstOnly&&this._filteredRows.length>1){this._filteredRows=this._filteredRows.slice(0,1)}return this}let operator;if(queryObjectOp===null||(typeof queryObjectOp!=="object"||queryObjectOp instanceof Date)){operator="$eq";value=queryObjectOp}else if(typeof queryObjectOp==="object"){for(let key in queryObjectOp){if(queryObjectOp[key]!==undefined){operator=key;value=queryObjectOp[key];break}}}else{throw new Error("Do not know what you want to do.")}if(operator==="$regex"){if(Array.isArray(value)){value=new RegExp(value[0],value[1])}else if(!(value instanceof RegExp)){value=new RegExp(value)}}const usingDotNotation=property.indexOf(".")!==-1;const doIndexCheck=!usingDotNotation&&!this._filterInitialized;let searchByIndex=false;if(doIndexCheck&&this._collection.binaryIndices[property]&&indexedOps[operator]){if(this._collection.adaptiveBinaryIndices!==true){this._collection.ensureIndex(property)}searchByIndex=true}const fun=LokiOps[operator];const data=this._collection._data;let result=[];if(this._filterInitialized){let filter=this._filteredRows;if(usingDotNotation){property=property.split(".");for(let i=0;i<filter.length;i++){let rowIdx=filter[i];if(dotSubScan(data[rowIdx],property,fun,value)){result.push(rowIdx)}}}else if(property==="$fts"){this._scoring=this._collection._fullTextSearch.search(query.$fts);let keys=Object.keys(this._scoring);for(let i=0;i<keys.length;i++){if(filter.indexOf(+keys[i])!==-1){result.push(+keys[i])}}}else if(this._collection.constraints.unique[property]!==undefined&&operator==="$eq"){let row=this._collection.constraints.unique[property].get(value);if(filter.indexOf(row)!==-1){result.push(row)}}else{for(let i=0;i<filter.length;i++){let rowIdx=filter[i];if(fun(data[rowIdx][property],value)){result.push(rowIdx)}}}this._filteredRows=result;this._filterInitialized=true;return this}this._filteredRows=result;this._filterInitialized=true;if(property==="$fts"){this._scoring=this._collection._fullTextSearch.search(query.$fts);let keys=Object.keys(this._scoring);for(let i=0;i<keys.length;i++){result.push(+keys[i])}return this}if(this._collection.constraints.unique[property]!==undefined&&operator==="$eq"){result.push(this._collection.constraints.unique[property].get(value));return this}if(!searchByIndex){if(usingDotNotation){property=property.split(".");for(let i=0;i<data.length;i++){if(dotSubScan(data[i],property,fun,value)){result.push(i);if(firstOnly){return this}}}}else{for(let i=0;i<data.length;i++){if(fun(data[i][property],value)){result.push(i);if(firstOnly){return this}}}}return this}let index=this._collection.binaryIndices[property];if(operator!=="$in"){const segm=this._collection.calculateRange(operator,property,value);for(let i=segm[0];i<=segm[1];i++){if(indexedOps[operator]!==true){if(indexedOps[operator](data[index.values[i]][property],value)){result.push(index.values[i]);if(firstOnly){return this}}}else{result.push(index.values[i]);if(firstOnly){return this}}}}else{const idxset=[];for(let j=0,len=value.length;j<len;j++){const segm=this._collection.calculateRange("$eq",property,value[j]);for(let i=segm[0];i<=segm[1];i++){if(idxset[i]===undefined){idxset[i]=true;result.push(index.values[i])}if(firstOnly){return this}}}}return this}where(fun){let viewFunction;let result=[];if("function"===typeof fun){viewFunction=fun}else{throw new TypeError("Argument is not a stored view or a function")}try{if(this._filterInitialized){let j=this._filteredRows.length;while(j--){if(viewFunction(this._collection._data[this._filteredRows[j]])===true){result.push(this._filteredRows[j])}}this._filteredRows=result;return this}else{let k=this._collection._data.length;while(k--){if(viewFunction(this._collection._data[k])===true){result.push(k)}}this._filteredRows=result;this._filterInitialized=true;return this}}catch(err){throw err}}count(){if(this._filterInitialized){return this._filteredRows.length}return this._collection.count()}data(options={}){let forceClones;let forceCloneMethod;let removeMeta;({forceClones:forceClones,forceCloneMethod:forceCloneMethod=this._collection.cloneMethod,removeMeta:removeMeta=false}=options);let result=[];let data=this._collection._data;let obj;let len;let i;let method;if(removeMeta&&!forceClones){forceClones=true;forceCloneMethod="shallow"}if(!this._collection.disableDeltaChangesApi){forceClones=true;forceCloneMethod="deep"}if(!this._filterInitialized){if(this._filteredRows.length===0){if(this._collection.cloneObjects||forceClones){len=data.length;method=forceCloneMethod;for(i=0;i<len;i++){obj=Object(__WEBPACK_IMPORTED_MODULE_1__clone__["a"])(data[i],method);if(removeMeta){delete obj.$loki;delete obj.meta}result.push(obj)}return result}else{return data.slice()}}else{this._filterInitialized=true}}const fr=this._filteredRows;len=fr.length;if(this._collection.cloneObjects||forceClones){method=forceCloneMethod;for(i=0;i<len;i++){obj=Object(__WEBPACK_IMPORTED_MODULE_1__clone__["a"])(data[fr[i]],method);if(removeMeta){delete obj.$loki;delete obj.meta}result.push(obj)}}else{for(i=0;i<len;i++){result.push(data[fr[i]])}}return result}update(updateFunction){if(!this._filterInitialized&&this._filteredRows.length===0){this._filteredRows=this._collection._prepareFullDocIndex()}const len=this._filteredRows.length;const rcd=this._collection._data;for(let idx=0;idx<len;idx++){updateFunction(rcd[this._filteredRows[idx]]);this._collection.update(rcd[this._filteredRows[idx]])}return this}remove(){if(!this._filterInitialized&&this._filteredRows.length===0){this._filteredRows=this._collection._prepareFullDocIndex()}this._collection.remove(this.data());this._filteredRows=[];return this}mapReduce(mapFunction,reduceFunction){try{return reduceFunction(this.data().map(mapFunction))}catch(err){throw err}}eqJoin(joinData,leftJoinKey,rightJoinKey,mapFun,dataOptions){let rightData=[];let rightDataLength;let key;let result=[];let leftKeyisFunction=typeof leftJoinKey==="function";let rightKeyisFunction=typeof rightJoinKey==="function";let joinMap={};let leftData=this.data(dataOptions);let leftDataLength=leftData.length;if(joinData instanceof __WEBPACK_IMPORTED_MODULE_0__collection__["a"]){rightData=joinData.chain().data(dataOptions)}else if(joinData instanceof ResultSet){rightData=joinData.data(dataOptions)}else if(Array.isArray(joinData)){rightData=joinData}else{throw new TypeError("joinData needs to be an array or result set")}rightDataLength=rightData.length;for(let i=0;i<rightDataLength;i++){key=rightKeyisFunction?rightJoinKey(rightData[i]):rightData[i][rightJoinKey];joinMap[key]=rightData[i]}if(!mapFun){mapFun=((left,right)=>({left:left,right:right}))}for(let j=0;j<leftDataLength;j++){key=leftKeyisFunction?leftJoinKey(leftData[j]):leftData[j][leftJoinKey];result.push(mapFun(leftData[j],joinMap[key]||{}))}this._collection=new __WEBPACK_IMPORTED_MODULE_0__collection__["a"]("joinData");this._collection.insert(result);this._filteredRows=[];this._filterInitialized=false;return this}map(mapFun,dataOptions){const data=this.data(dataOptions).map(mapFun);this._collection=new __WEBPACK_IMPORTED_MODULE_0__collection__["a"]("mappedData");this._collection.insert(data);this._filteredRows=[];this._filterInitialized=false;return this}}__webpack_exports__["a"]=ResultSet},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_exports__["a"]=clone;function add(copy,key,value){if(copy instanceof Array){copy.push(value);return copy[copy.length-1]}else if(copy instanceof Object){copy[key]=value;return copy[key]}}function walk(target,copy){for(let key in target){let obj=target[key];if(obj instanceof Date){let value=new Date(obj.getTime());add(copy,key,value)}else if(obj instanceof Function){let value=obj;add(copy,key,value)}else if(obj instanceof Array){let value=[];let last=add(copy,key,value);walk(obj,last)}else if(obj instanceof Object){let value={};let last=add(copy,key,value);walk(obj,last)}else{let value=obj;add(copy,key,value)}}}function deepCopy(target){if(/number|string|boolean/.test(typeof target)){return target}if(target instanceof Date){return new Date(target.getTime())}const copy=target instanceof Array?[]:{};walk(target,copy);return copy}function clone(data,method="parse-stringify"){if(data===null||data===undefined){return null}let cloned;switch(method){case"parse-stringify":cloned=JSON.parse(JSON.stringify(data));break;case"deep":cloned=deepCopy(data);break;case"shallow":cloned=Object.create(data.constructor.prototype);Object.assign(cloned,data);break;case"shallow-recurse-objects":cloned=clone(data,"shallow");const keys=Object.keys(data);for(let i=0;i<keys.length;i++){const key=keys[i];if(typeof data[key]==="object"&&data[key].constructor.name==="Object"){cloned[key]=clone(data[key],"shallow-recurse-objects")}}break;default:break}return cloned}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_exports__["a"]=aeqHelper;__webpack_exports__["c"]=ltHelper;__webpack_exports__["b"]=gtHelper;__webpack_exports__["d"]=sortHelper;function aeqHelper(prop1,prop2){if(prop1===prop2)return true;if(!prop1||!prop2||prop1===true||prop2===true||prop1!==prop1||prop2!==prop2){let t1;let t2;switch(prop1){case undefined:t1=1;break;case null:t1=1;break;case false:t1=3;break;case true:t1=4;break;case"":t1=5;break;default:t1=prop1===prop1?9:0;break}switch(prop2){case undefined:t2=1;break;case null:t2=1;break;case false:t2=3;break;case true:t2=4;break;case"":t2=5;break;default:t2=prop2===prop2?9:0;break}if(t1!==9||t2!==9){return t1===t2}}let cv1=Number(prop1);let cv2=Number(prop2);if(cv1===cv1||cv2===cv2){return cv1===cv2}cv1=prop1.toString();cv2=prop2.toString();return cv1==cv2}function ltHelper(prop1,prop2,equal){if(!prop1||!prop2||prop1===true||prop2===true||prop1!==prop1||prop2!==prop2){let t1;let t2;switch(prop1){case undefined:t1=1;break;case null:t1=1;break;case false:t1=3;break;case true:t1=4;break;case"":t1=5;break;default:t1=prop1===prop1?9:0;break}switch(prop2){case undefined:t2=1;break;case null:t2=1;break;case false:t2=3;break;case true:t2=4;break;case"":t2=5;break;default:t2=prop2===prop2?9:0;break}if(t1!==9||t2!==9){return t1===t2?equal:t1<t2}}let cv1=Number(prop1);let cv2=Number(prop2);if(cv1===cv1&&cv2===cv2){if(cv1<cv2)return true;if(cv1>cv2)return false;return equal}if(cv1===cv1&&cv2!==cv2){return true}if(cv2===cv2&&cv1!==cv1){return false}if(prop1<prop2)return true;if(prop1>prop2)return false;if(prop1==prop2)return equal;cv1=prop1.toString();cv2=prop2.toString();if(cv1<cv2){return true}if(cv1==cv2){return equal}return false}function gtHelper(prop1,prop2,equal){if(!prop1||!prop2||prop1===true||prop2===true||prop1!==prop1||prop2!==prop2){let t1;let t2;switch(prop1){case undefined:t1=1;break;case null:t1=1;break;case false:t1=3;break;case true:t1=4;break;case"":t1=5;break;default:t1=prop1===prop1?9:0;break}switch(prop2){case undefined:t2=1;break;case null:t2=1;break;case false:t2=3;break;case true:t2=4;break;case"":t2=5;break;default:t2=prop2===prop2?9:0;break}if(t1!==9||t2!==9){return t1===t2?equal:t1>t2}}let cv1=Number(prop1);let cv2=Number(prop2);if(cv1===cv1&&cv2===cv2){if(cv1>cv2)return true;if(cv1<cv2)return false;return equal}if(cv1===cv1&&cv2!==cv2){return false}if(cv2===cv2&&cv1!==cv1){return true}if(prop1>prop2)return true;if(prop1<prop2)return false;if(prop1==prop2)return equal;cv1=prop1.toString();cv2=prop2.toString();if(cv1>cv2){return true}if(cv1==cv2){return equal}return false}function sortHelper(prop1,prop2,descending){if(aeqHelper(prop1,prop2)){return 0}if(ltHelper(prop1,prop2,false)){return descending?1:-1}if(gtHelper(prop1,prop2,false)){return descending?-1:1}return 0}},function(module,__webpack_exports__,__webpack_require__){"use strict";(function(global){function getGlobal(){let glob;(function(global){glob=global})(global!==undefined&&global||this);return glob}function create(){const global=getGlobal();const sym=Symbol.for("LOKI");if(global[sym]===undefined){global[sym]={}}return global[sym]}const PLUGINS=create();__webpack_exports__["a"]=PLUGINS}).call(__webpack_exports__,__webpack_require__(2))},function(module,__webpack_exports__,__webpack_require__){"use strict";Object.defineProperty(__webpack_exports__,"__esModule",{value:true});var __WEBPACK_IMPORTED_MODULE_0__loki__=__webpack_require__(8);var __WEBPACK_IMPORTED_MODULE_1__collection__=__webpack_require__(1);__webpack_require__.d(__webpack_exports__,"Loki",function(){return __WEBPACK_IMPORTED_MODULE_0__loki__["a"]});__webpack_require__.d(__webpack_exports__,"Collection",function(){return __WEBPACK_IMPORTED_MODULE_1__collection__["a"]});__WEBPACK_IMPORTED_MODULE_0__loki__["a"]["Collection"]=__WEBPACK_IMPORTED_MODULE_1__collection__["a"];__webpack_exports__["default"]=__WEBPACK_IMPORTED_MODULE_0__loki__["a"]},function(module,__webpack_exports__,__webpack_require__){"use strict";(function(global){var __WEBPACK_IMPORTED_MODULE_0__event_emitter__=__webpack_require__(0);var __WEBPACK_IMPORTED_MODULE_1__collection__=__webpack_require__(1);var __WEBPACK_IMPORTED_MODULE_2__common_plugin__=__webpack_require__(6);function getENV(){if(global!==undefined&&(global["android"]||global["NSObject"])){return"NATIVESCRIPT"}const isNode=global!==undefined&&{}.toString.call(global)==="[object global]";if(isNode){if(global["window"]){return"NODEJS"}else{return"NODEJS"}}const isBrowser=window!==undefined&&{}.toString.call(window)==="[object Window]";if(document!==undefined){if(document.URL.indexOf("http://")===-1&&document.URL.indexOf("https://")===-1){return"CORDOVA"}return"BROWSER"}if(!isBrowser){throw SyntaxError("Unknown environment...")}}class Loki extends __WEBPACK_IMPORTED_MODULE_0__event_emitter__["a"]{constructor(filename="loki.db",options={}){super();this.filename=filename;this._collections=[];({serializationMethod:this._serializationMethod="normal",destructureDelimiter:this._destructureDelimiter="$<\n",verbose:this._verbose=false,env:this._env=getENV()}=options);this.databaseVersion=1.5;this.engineVersion=1.5;this._autosave=false;this._autosaveInterval=5e3;this._autosaveHandle=null;this._throttledSaves=true;this._persistenceMethod=null;this._persistenceAdapter=null;this._throttledSaveRunning=null;this._throttledSavePending=null;this.events={init:[],loaded:[],flushChanges:[],close:[],changes:[],warning:[]};this.on("init",this.clearChanges)}initializePersistence(options={}){({autosave:this._autosave=false,autosaveInterval:this._autosaveInterval=5e3,persistenceMethod:this._persistenceMethod,throttledSaves:this._throttledSaves=true}=options);const DEFAULT_PERSISTENCE={NODEJS:["fs-storage"],BROWSER:["local-storage","indexed-storage"],CORDOVA:["local-storage","indexed-storage"],MEMORY:["memory-storage"]};const PERSISTENCE_METHODS={"fs-storage":__WEBPACK_IMPORTED_MODULE_2__common_plugin__["a"]["FSStorage"],"local-storage":__WEBPACK_IMPORTED_MODULE_2__common_plugin__["a"]["LocalStorage"],"indexed-storage":__WEBPACK_IMPORTED_MODULE_2__common_plugin__["a"]["IndexedStorage"],"memory-storage":__WEBPACK_IMPORTED_MODULE_2__common_plugin__["a"]["MemoryStorage"]};if(this._persistenceMethod!==undefined){if(typeof PERSISTENCE_METHODS[this._persistenceMethod]==="function"){this._persistenceAdapter=new PERSISTENCE_METHODS[this._persistenceMethod]}else{throw Error("Unknown persistence method.")}}if(options.adapter!==undefined){this._persistenceMethod="adapter";this._persistenceAdapter=options.adapter}if(this._persistenceAdapter===null){let possiblePersistenceMethods=DEFAULT_PERSISTENCE[this._env];if(possiblePersistenceMethods){for(let i=0;i<possiblePersistenceMethods.length;i++){if(PERSISTENCE_METHODS[possiblePersistenceMethods[i]]){this._persistenceMethod=possiblePersistenceMethods[i];this._persistenceAdapter=new PERSISTENCE_METHODS[possiblePersistenceMethods[i]];break}}}}this.autosaveDisable();let loaded;if(options.autoload){loaded=this.loadDatabase(options.inflate)}else{loaded=Promise.resolve()}return loaded.then(()=>{if(this._autosave){this.autosaveEnable()}})}copy(options={}){const databaseCopy=new Loki(this.filename,{env:this._env});databaseCopy.loadJSONObject(this,{retainDirtyFlags:true});if(options.removeNonSerializable){databaseCopy._autosaveHandle=null;databaseCopy._persistenceAdapter=null;for(let idx=0;idx<databaseCopy._collections.length;idx++){databaseCopy._collections[idx].constraints=null;databaseCopy._collections[idx].ttl=null}}return databaseCopy}addCollection(name,options={}){const collection=new __WEBPACK_IMPORTED_MODULE_1__collection__["a"](name,options);this._collections.push(collection);if(this._verbose){collection.console=console}return collection}loadCollection(collection){if(!collection.name){throw new Error("Collection must have a name property to be loaded")}this._collections.push(collection)}getCollection(collectionName){let i;const len=this._collections.length;for(i=0;i<len;i++){if(this._collections[i].name===collectionName){return this._collections[i]}}this.emit("warning","collection "+collectionName+" not found");return null}renameCollection(oldName,newName){const c=this.getCollection(oldName);if(c){c.name=newName}return c}listCollections(){const colls=[];for(let i=0;i<this._collections.length;i++){colls.push({name:this._collections[i].name,count:this._collections[i].count()})}return colls}removeCollection(collectionName){for(let i=0;i<this._collections.length;i++){if(this._collections[i].name===collectionName){const tmpcol=new __WEBPACK_IMPORTED_MODULE_1__collection__["a"](collectionName,{});const curcol=this._collections[i];for(const prop in curcol){if(curcol[prop]!==undefined&&tmpcol[prop]!==undefined){curcol[prop]=tmpcol[prop]}}this._collections.splice(i,1);return}}}getName(){return this.filename}serialize(options={}){if(options.serializationMethod===undefined){options.serializationMethod=this._serializationMethod}switch(options.serializationMethod){case"normal":return JSON.stringify(this);case"pretty":return JSON.stringify(this,null,2);case"destructured":return this.serializeDestructured();default:return JSON.stringify(this)}}toJSON(){return{_env:this._env,_serializationMethod:this._serializationMethod,_autosave:this._autosave,_autosaveInterval:this._autosaveInterval,_collections:this._collections,databaseVersion:this.databaseVersion,engineVersion:this.engineVersion,filename:this.filename,_persistenceAdapter:this._persistenceAdapter,_persistenceMethod:this._persistenceMethod,_throttledSaves:this._throttledSaves,_verbose:this._verbose}}serializeDestructured(options={}){if(options.partitioned===undefined){options.partitioned=false}if(options.delimited===undefined){options.delimited=true}if(options.delimiter===undefined){options.delimiter=this._destructureDelimiter}if(options.partitioned===true&&options.partition!==undefined&&options.partition>=0){return this.serializeCollection({delimited:options.delimited,delimiter:options.delimiter,collectionIndex:options.partition})}let dbcopy=new Loki(this.filename);dbcopy.loadJSONObject(this);for(let idx=0;idx<dbcopy._collections.length;idx++){dbcopy._collections[idx]._data=[]}if(options.partitioned===true&&options.partition===-1){return dbcopy.serialize({serializationMethod:"normal"})}const reconstruct=[];reconstruct.push(dbcopy.serialize({serializationMethod:"normal"}));dbcopy=null;for(let idx=0;idx<this._collections.length;idx++){let result=this.serializeCollection({delimited:options.delimited,delimiter:options.delimiter,collectionIndex:idx});if(options.partitioned===false&&options.delimited===false){if(!Array.isArray(result)){throw new Error("a nondelimited, non partitioned collection serialization did not return an expected array")}for(let sidx=0;sidx<result.length;sidx++){reconstruct.push(result[sidx]);result[sidx]=null}reconstruct.push("")}else{reconstruct.push(result)}}if(options.partitioned){if(options.delimited){return reconstruct}else{return reconstruct}}else{if(options.delimited){reconstruct.push("");return reconstruct.join(options.delimiter)}else{reconstruct.push("");return reconstruct}}}serializeCollection(options={}){if(options.delimited===undefined){options.delimited=true}if(options.collectionIndex===undefined){throw new Error("serializeCollection called without 'collectionIndex' option")}const doccount=this._collections[options.collectionIndex].count();let resultlines=[];for(let docidx=0;docidx<doccount;docidx++){resultlines.push(JSON.stringify(this._collections[options.collectionIndex]._data[docidx]))}if(options.delimited){resultlines.push("");return resultlines.join(options.delimiter)}else{return resultlines}}deserializeDestructured(destructuredSource,options={}){if(options.partitioned===undefined){options.partitioned=false}if(options.delimited===undefined){options.delimited=true}if(options.delimiter===undefined){options.delimiter=this._destructureDelimiter}if(options.partitioned){if(options.partition!==undefined){if(options.partition===-1){return JSON.parse(destructuredSource[0])}return this.deserializeCollection(destructuredSource[options.partition+1],options)}const cdb=JSON.parse(destructuredSource[0]);const collCount=cdb._collections.length;for(let collIndex=0;collIndex<collCount;collIndex++){cdb._collections[collIndex]._data=this.deserializeCollection(destructuredSource[collIndex+1],options)}return cdb}let workarray=[];if(options.delimited){workarray=destructuredSource.split(options.delimiter);destructuredSource=null;if(workarray.length===0){return null}}else{workarray=destructuredSource}const cdb=JSON.parse(workarray[0]);const collCount=cdb._collections.length;workarray[0]=null;let collIndex=0;let lineIndex=1;let done=false;while(!done){if(workarray[lineIndex]===""){if(++collIndex>collCount){done=true}}else{cdb._collections[collIndex]._data.push(JSON.parse(workarray[lineIndex]))}workarray[lineIndex++]=null}return cdb}deserializeCollection(destructuredSource,options={}){if(options.partitioned===undefined){options.partitioned=false}if(options.delimited===undefined){options.delimited=true}if(options.delimiter===undefined){options.delimiter=this._destructureDelimiter}let workarray=[];if(options.delimited){workarray=destructuredSource.split(options.delimiter);workarray.pop()}else{workarray=destructuredSource}for(let idx=0;idx<workarray.length;idx++){workarray[idx]=JSON.parse(workarray[idx])}return workarray}loadJSON(serializedDb,options){let dbObject;if(serializedDb.length===0){dbObject={}}else{switch(this._serializationMethod){case"normal":case"pretty":dbObject=JSON.parse(serializedDb);break;case"destructured":dbObject=this.deserializeDestructured(serializedDb);break;default:dbObject=JSON.parse(serializedDb);break}}this.loadJSONObject(dbObject,options)}loadJSONObject(dbObject,options={}){const len=dbObject._collections?dbObject._collections.length:0;this.filename=dbObject.filename;this._collections=[];for(let i=0;i<len;++i){this._collections.push(__WEBPACK_IMPORTED_MODULE_1__collection__["a"].fromJSONObject(dbObject._collections[i],options))}}close(){let saved;if(this._autosave){this.autosaveDisable();for(let idx=0;idx<this._collections.length;idx++){if(this._collections[idx].dirty){saved=this.saveDatabase();break}}}return Promise.resolve(saved).then(()=>{this.emit("close")})}generateChangesNotification(arrayOfCollectionNames){let changes=[];const selectedCollections=arrayOfCollectionNames||this._collections.map(coll=>coll.name);this._collections.forEach(coll=>{if(selectedCollections.indexOf(coll.name)!==-1){changes=changes.concat(coll.getChanges())}});return changes}serializeChanges(collectionNamesArray){return JSON.stringify(this.generateChangesNotification(collectionNamesArray))}clearChanges(){this._collections.forEach(coll=>{if(coll.flushChanges){coll.flushChanges()}})}throttledSaveDrain(options={}){const now=(new Date).getTime();if(!this._throttledSaves){return Promise.resolve()}if(options.recursiveWait===undefined){options.recursiveWait=true}if(options.recursiveWaitLimit===undefined){options.recursiveWaitLimit=false}if(options.recursiveWaitLimitDuration===undefined){options.recursiveWaitLimitDuration=2e3}if(options.started===undefined){options.started=new Date}if(this._throttledSaves&&this._throttledSaveRunning!==null){if(options.recursiveWait){return Promise.resolve(Promise.all([this._throttledSaveRunning,this._throttledSavePending])).then(()=>{if(this._throttledSaveRunning!==null||this._throttledSavePending!==null){if(options.recursiveWaitLimit&&now-options.started.getTime()>options.recursiveWaitLimitDuration){return Promise.reject({})}return this.throttledSaveDrain(options)}else{return Promise.resolve()}})}else{return Promise.resolve(this._throttledSaveRunning)}}else{return Promise.resolve()}}_loadDatabase(options={}){if(this._persistenceAdapter===null){return Promise.reject(new Error("persistenceAdapter not configured"))}return Promise.resolve(this._persistenceAdapter.loadDatabase(this.filename)).then(dbString=>{if(typeof dbString==="string"){this.loadJSON(dbString,options);this.emit("load",this)}else{dbString=dbString;if(typeof dbString==="object"&&dbString!==null&&!(dbString instanceof Error)){this.loadJSONObject(dbString,options);this.emit("load",this)}else{if(dbString instanceof Error)throw dbString;throw new TypeError("The persistence adapter did not load a serialized DB string or object.")}}})}loadDatabase(options={}){if(!this._throttledSaves){return this._loadDatabase(options)}return this.throttledSaveDrain(options).then(()=>{this._throttledSaveRunning=this._loadDatabase(options).then(()=>{this._throttledSaveRunning=null});return this._throttledSaveRunning},()=>{throw new Error("Unable to pause save throttling long enough to read database")})}_saveDatabase(){if(this._persistenceAdapter===null){return Promise.reject(new Error("persistenceAdapter not configured"))}let saved;if(this._persistenceAdapter.mode==="reference"&&typeof this._persistenceAdapter.exportDatabase==="function"){saved=this._persistenceAdapter.exportDatabase(this.filename,this.copy({removeNonSerializable:true}))}else{saved=this._persistenceAdapter.saveDatabase(this.filename,this.serialize())}return Promise.resolve(saved).then(()=>{for(let idx=0;idx<this._collections.length;idx++){this._collections[idx].dirty=false}this.emit("save")})}saveDatabase(){if(!this._throttledSaves){return this._saveDatabase()}if(this._throttledSaveRunning!==null&&this._throttledSavePending===null){this._throttledSavePending=Promise.resolve(this._throttledSaveRunning).then(()=>{this._throttledSaveRunning=null;this._throttledSavePending=null;return this.saveDatabase()})}if(this._throttledSavePending!==null){return this._throttledSavePending}this._throttledSaveRunning=this._saveDatabase().then(()=>{this._throttledSaveRunning=null});return this._throttledSaveRunning}deleteDatabase(){if(this._persistenceAdapter===null){return Promise.reject(new Error("persistenceAdapter not configured"))}return Promise.resolve(this._persistenceAdapter.deleteDatabase(this.filename))}autosaveEnable(){if(this._autosaveHandle){return}let running=true;this._autosave=true;this._autosaveHandle=(()=>{running=false;this._autosaveHandle=undefined});setTimeout(()=>{if(running){this.saveDatabase().then(this.saveDatabase,this.saveDatabase)}},this._autosaveInterval)}autosaveDisable(){this._autosave=false;if(this._autosaveHandle){this._autosaveHandle()}}}__webpack_exports__["a"]=Loki}).call(__webpack_exports__,__webpack_require__(2))},function(module,__webpack_exports__,__webpack_require__){"use strict";class UniqueIndex{constructor(propertyField){this._field=propertyField;this._keyMap={}}set(doc,row){const fieldValue=doc[this._field];if(fieldValue!==null&&fieldValue!==undefined){if(this._keyMap[fieldValue]!==undefined){throw new Error("Duplicate key for property "+this._field+": "+fieldValue)}else{this._keyMap[fieldValue]=row}}}get(index){return this._keyMap[index]}update(doc,row){const uniqueNames=Object.keys(this._keyMap);for(let i=0;i<uniqueNames.length;i++){if(row===this._keyMap[uniqueNames[i]]){delete this._keyMap[uniqueNames[i]];break}}this.set(doc,row)}remove(index){if(this._keyMap[index]!==undefined){delete this._keyMap[index]}else{throw new Error("Key is not in unique index: "+this._field)}}clear(){this._keyMap={}}}__webpack_exports__["a"]=UniqueIndex},function(module,__webpack_exports__,__webpack_require__){"use strict";var __WEBPACK_IMPORTED_MODULE_0__event_emitter__=__webpack_require__(0);var __WEBPACK_IMPORTED_MODULE_1__result_set__=__webpack_require__(3);class DynamicView extends __WEBPACK_IMPORTED_MODULE_0__event_emitter__["a"]{constructor(collection,name,options={}){super();({persistent:this._persistent=false,sortPriority:this._sortPriority="passive",minRebuildInterval:this._minRebuildInterval=1}=options);this._collection=collection;this.name=name;this._rebuildPending=false;this._resultSet=new __WEBPACK_IMPORTED_MODULE_1__result_set__["a"](collection);this._resultData=[];this._resultDirty=false;this._cachedResultSet=null;this._filterPipeline=[];this._sortFunction=null;this._sortCriteria=null;this._sortByScoring=null;this._sortDirty=false;this.events={rebuild:[]}}_rematerialize({removeWhereFilters:removeWhereFilters=false}){this._resultData=[];this._resultDirty=true;this._resultSet=new __WEBPACK_IMPORTED_MODULE_1__result_set__["a"](this._collection);if(this._sortFunction||this._sortCriteria||this._sortByScoring!==null){this._sortDirty=true}if(removeWhereFilters){let fpi=this._filterPipeline.length;while(fpi--){if(this._filterPipeline[fpi].type==="where"){if(fpi!==this._filterPipeline.length-1){this._filterPipeline[fpi]=this._filterPipeline[this._filterPipeline.length-1]}this._filterPipeline.length--}}}const ofp=this._filterPipeline;this._filterPipeline=[];for(let idx=0;idx<ofp.length;idx++){this.applyFind(ofp[idx].val)}this.data();this.emit("rebuild",this);return this}branchResultSet(transform,parameters){const rs=this._resultSet.branch();if(transform===undefined){return rs}return rs.transform(transform,parameters)}toJSON(){return{name:this.name,_persistent:this._persistent,_sortPriority:this._sortPriority,_minRebuildInterval:this._minRebuildInterval,_resultSet:this._resultSet,_filterPipeline:this._filterPipeline,_sortCriteria:this._sortCriteria,_sortByScoring:this._sortByScoring,_sortDirty:this._sortDirty}}static fromJSONObject(collection,obj){let dv=new DynamicView(collection,obj.name);dv._resultDirty=true;dv._filterPipeline=obj._filterPipeline;dv._resultData=[];dv._sortCriteria=obj._sortCriteria;dv._sortByScoring=obj._sortByScoring;dv._sortDirty=obj._sortDirty;dv._resultSet._filteredRows=obj._resultSet._filteredRows;dv._resultSet._filterInitialized=obj._resultSet._filterInitialized;dv._rematerialize({removeWhereFilters:true});return dv}removeFilters({queueSortPhase:queueSortPhase=false}={}){this._rebuildPending=false;this._resultSet.reset();this._resultData=[];this._resultDirty=true;this._cachedResultSet=null;this._filterPipeline=[];this._sortFunction=null;this._sortCriteria=null;this._sortByScoring=null;this._sortDirty=false;if(queueSortPhase===true){this._queueSortPhase()}}applySort(comparefun){this._sortFunction=comparefun;this._sortCriteria=null;this._sortByScoring=null;this._queueSortPhase();return this}applySimpleSort(propname,isdesc){this._sortCriteria=[[propname,isdesc||false]];this._sortFunction=null;this._sortByScoring=null;this._queueSortPhase();return this}applySortCriteria(criteria){this._sortCriteria=criteria;this._sortFunction=null;this._sortByScoring=null;this._queueSortPhase();return this}applySortByScoring(ascending=false){this._sortFunction=null;this._sortCriteria=null;this._sortByScoring=ascending;this._queueSortPhase();return this}getScoring(){return this._resultSet.getScoring()}startTransaction(){this._cachedResultSet=this._resultSet.copy();return this}commit(){this._cachedResultSet=null;return this}rollback(){this._resultSet=this._cachedResultSet;if(this._persistent){this._resultData=this._resultSet.data();this.emit("rebuild",this)}return this}_indexOfFilterWithId(uid){if(typeof uid==="string"||typeof uid==="number"){for(let idx=0,len=this._filterPipeline.length;idx<len;idx++){if(uid===this._filterPipeline[idx].uid){return idx}}}return-1}_addFilter(filter){this._filterPipeline.push(filter);this._resultSet[filter.type](filter.val)}reapplyFilters(){this._resultSet.reset();this._cachedResultSet=null;if(this._persistent){this._resultData=[];this._resultDirty=true}const filters=this._filterPipeline;this._filterPipeline=[];for(let idx=0,len=filters.length;idx<len;idx++){this._addFilter(filters[idx])}if(this._sortFunction||this._sortCriteria||this._sortByScoring!==null){this._queueSortPhase()}else{this._queueRebuildEvent()}return this}applyFilter(filter){const idx=this._indexOfFilterWithId(filter.uid);if(idx>=0){this._filterPipeline[idx]=filter;return this.reapplyFilters()}this._cachedResultSet=null;if(this._persistent){this._resultData=[];this._resultDirty=true}this._addFilter(filter);if(this._sortFunction||this._sortCriteria||this._sortByScoring!==null){this._queueSortPhase()}else{this._queueRebuildEvent()}return this}applyFind(query,uid=""){this.applyFilter({type:"find",val:query,uid:uid});return this}applyWhere(fun,uid){this.applyFilter({type:"where",val:fun,uid:uid});return this}removeFilter(uid){const idx=this._indexOfFilterWithId(uid);if(idx<0){throw new Error("Dynamic view does not contain a filter with ID: "+uid)}this._filterPipeline.splice(idx,1);this.reapplyFilters();return this}count(){if(this._resultDirty){this._resultData=this._resultSet.data()}return this._resultSet.count()}data(options={}){if(this._sortDirty||this._resultDirty){this._performSortPhase({suppressRebuildEvent:true})}return this._persistent?this._resultData:this._resultSet.data(options)}_queueRebuildEvent(){if(this._rebuildPending){return}this._rebuildPending=true;setTimeout(()=>{if(this._rebuildPending){this._rebuildPending=false;this.emit("rebuild",this)}},this._minRebuildInterval)}_queueSortPhase(){if(this._sortDirty){return}this._sortDirty=true;if(this._sortPriority==="active"){setTimeout(()=>{this._performSortPhase()},this._minRebuildInterval)}else{this._queueRebuildEvent()}}_performSortPhase(options={}){if(!this._sortDirty&&!this._resultDirty){return}if(this._sortDirty){if(this._sortFunction){this._resultSet.sort(this._sortFunction)}else if(this._sortCriteria){this._resultSet.compoundsort(this._sortCriteria)}else if(this._sortByScoring!==null){this._resultSet.sortByScoring(this._sortByScoring)}this._sortDirty=false}if(this._persistent){this._resultData=this._resultSet.data();this._resultDirty=false}if(!options.suppressRebuildEvent){this.emit("rebuild",this)}}_evaluateDocument(objIndex,isNew){if(!this._resultSet._filterInitialized){if(this._persistent){this._resultData=this._resultSet.data()}if(this._sortFunction||this._sortCriteria){this._queueSortPhase()}else{this._queueRebuildEvent()}return}const ofr=this._resultSet._filteredRows;const oldPos=isNew?-1:ofr.indexOf(+objIndex);const oldlen=ofr.length;const evalResultSet=new __WEBPACK_IMPORTED_MODULE_1__result_set__["a"](this._collection);evalResultSet._filteredRows=[objIndex];evalResultSet._filterInitialized=true;let filter;for(let idx=0,len=this._filterPipeline.length;idx<len;idx++){filter=this._filterPipeline[idx];evalResultSet[filter.type](filter.val)}const newPos=evalResultSet._filteredRows.length===0?-1:0;if(oldPos===-1&&newPos===-1)return;if(oldPos===-1&&newPos!==-1){ofr.push(objIndex);if(this._persistent){this._resultData.push(this._collection._data[objIndex])}if(this._sortFunction||this._sortCriteria){this._queueSortPhase()}else{this._queueRebuildEvent()}return}if(oldPos!==-1&&newPos===-1){if(oldPos<oldlen-1){ofr.splice(oldPos,1);if(this._persistent){this._resultData.splice(oldPos,1)}}else{ofr.length=oldlen-1;if(this._persistent){this._resultData.length=oldlen-1}}if(this._sortFunction||this._sortCriteria){this._queueSortPhase()}else{this._queueRebuildEvent()}return}if(oldPos!==-1&&newPos!==-1){if(this._persistent){this._resultData[oldPos]=this._collection._data[objIndex]}if(this._sortFunction||this._sortCriteria){this._queueSortPhase()}else{this._queueRebuildEvent()}}}_removeDocument(objIndex){if(!this._resultSet._filterInitialized){if(this._persistent){this._resultData=this._resultSet.data()}if(this._sortFunction||this._sortCriteria){this._queueSortPhase()}else{this._queueRebuildEvent()}return}const ofr=this._resultSet._filteredRows;const oldPos=ofr.indexOf(+objIndex);let oldlen=ofr.length;if(oldPos!==-1){if(oldPos<oldlen-1){ofr[oldPos]=ofr[oldlen-1];ofr.length=oldlen-1;if(this._persistent){this._resultData[oldPos]=this._resultData[oldlen-1];this._resultData.length=oldlen-1}}else{ofr.length=oldlen-1;if(this._persistent){this._resultData.length=oldlen-1}}if(this._sortFunction||this._sortCriteria){this._queueSortPhase()}else{this._queueRebuildEvent()}}oldlen=ofr.length;for(let idx=0;idx<oldlen;idx++){if(ofr[idx]>objIndex){ofr[idx]--}}}mapReduce(mapFunction,reduceFunction){try{return reduceFunction(this.data().map(mapFunction))}catch(err){throw err}}}__webpack_exports__["a"]=DynamicView}])});