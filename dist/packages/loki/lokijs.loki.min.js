(function webpackUniversalModuleDefinition(root,factory){if(typeof exports==="object"&&typeof module==="object")module.exports=factory();else if(typeof define==="function"&&define.amd)define([],factory);else if(typeof exports==="object")exports["@lokijs/loki"]=factory();else{root["@lokijs/loki"]=factory();root["Loki"]=root["@lokijs/loki"].default}})(this,function(){return function(modules){var installedModules={};function __webpack_require__(moduleId){if(installedModules[moduleId]){return installedModules[moduleId].exports}var module=installedModules[moduleId]={i:moduleId,l:false,exports:{}};modules[moduleId].call(module.exports,module,module.exports,__webpack_require__);module.l=true;return module.exports}__webpack_require__.m=modules;__webpack_require__.c=installedModules;__webpack_require__.d=function(exports,name,getter){if(!__webpack_require__.o(exports,name)){Object.defineProperty(exports,name,{configurable:false,enumerable:true,get:getter})}};__webpack_require__.n=function(module){var getter=module&&module.__esModule?function getDefault(){return module["default"]}:function getModuleExports(){return module};__webpack_require__.d(getter,"a",getter);return getter};__webpack_require__.o=function(object,property){return Object.prototype.hasOwnProperty.call(object,property)};__webpack_require__.p="";return __webpack_require__(__webpack_require__.s=1)}([function(module,__webpack_exports__,__webpack_require__){"use strict";class LokiEventEmitter{constructor(){this.events={};this.asyncListeners=false}on(eventName,listener){let event;if(Array.isArray(eventName)){eventName.forEach(currentEventName=>{this.on(currentEventName,listener)});return listener}event=this.events[eventName];if(!event){event=this.events[eventName]=[]}event.push(listener);return listener}emit(eventName,data){if(eventName&&this.events[eventName]){this.events[eventName].forEach(listener=>{if(this.asyncListeners){setTimeout(()=>{listener(data)},1)}else{listener(data)}})}}addListener(eventName,listener){return this.on(eventName,listener)}removeListener(eventName,listener){if(Array.isArray(eventName)){eventName.forEach(currentEventName=>{this.removeListener(currentEventName,listener)})}if(this.events[eventName]){const listeners=this.events[eventName];listeners.splice(listeners.indexOf(listener),1)}}}__webpack_exports__["a"]=LokiEventEmitter},function(module,__webpack_exports__,__webpack_require__){"use strict";Object.defineProperty(__webpack_exports__,"__esModule",{value:true});(function(global){var __WEBPACK_IMPORTED_MODULE_0__event_emitter__=__webpack_require__(0);var __WEBPACK_IMPORTED_MODULE_1__collection__=__webpack_require__(2);function getENV(){if(typeof global!=="undefined"&&(global.android||global.NSObject)){return"NATIVESCRIPT"}const isNode=typeof global!=="undefined"&&{}.toString.call(global)==="[object global]";if(isNode){if(global.window){return"NODEJS"}else{return"NODEJS"}}const isBrowser=typeof window!=="undefined"&&{}.toString.call(window)==="[object Window]";if(typeof document!=="undefined"){if(document.URL.indexOf("http://")===-1&&document.URL.indexOf("https://")===-1){return"CORDOVA"}return"BROWSER"}if(!isBrowser){throw SyntaxError("Unknown enviroment...")}}class Loki extends __WEBPACK_IMPORTED_MODULE_0__event_emitter__["a"]{constructor(filename,{serializationMethod:serializationMethod="normal",destructureDelimiter:destructureDelimiter="$<\n",verbose:verbose=false,env:env=getENV()}={}){super();this.filename=filename||"loki.db";this.collections=[];this.databaseVersion=1.5;this.engineVersion=1.5;this.autosave=false;this.autosaveInterval=5e3;this.autosaveHandle=null;this._throttledSaves=true;this.options={serializationMethod:serializationMethod,destructureDelimiter:destructureDelimiter};this.persistenceMethod=null;this.persistenceAdapter=null;this._throttledSaveRunning=null;this._throttledSavePending=null;this.verbose=verbose;this.events={init:[],loaded:[],flushChanges:[],close:[],changes:[],warning:[]};this.ENV=env;this.on("init",this.clearChanges)}initializePersistence({persistenceMethod:persistenceMethod,adapter:adapter,autosaveInterval:autosaveInterval,throttledSaves:throttledSaves,autosave:autosave,inflate:inflate,autoload:autoload}={}){const defaultPersistence={NODEJS:["fs"],BROWSER:["local-storage","indexed-db"],CORDOVA:["local-storage","indexed-db"],MEMORY:["memory"]};const persistenceMethods={fs:Loki["LokiFSStorage"],"local-storage":Loki["LokiLocalStorage"],"indexed-db":Loki["LokiIndexedStorage"]};this.options.persistenceMethod=persistenceMethod;if(this.options.persistenceMethod!==undefined){if(typeof persistenceMethods[this.options.persistenceMethod]==="function"){this.persistenceMethod=this.options.persistenceMethod;this.persistenceAdapter=new persistenceMethods[this.options.persistenceMethod]}}this.options.adapter=adapter;if(this.options.adapter!==undefined){this.persistenceMethod="adapter";this.persistenceAdapter=this.options.adapter}if(this.persistenceAdapter===null){let possiblePersistenceMethods=defaultPersistence[this.ENV];if(possiblePersistenceMethods){for(let i=0;i<possiblePersistenceMethods.length;i++){if(possiblePersistenceMethods[persistenceMethods]){this.persistenceMethod=possiblePersistenceMethods[persistenceMethods];this.persistenceAdapter=new persistenceMethods[this.persistenceMethod];break}}}}this.options.autosaveInterval=autosaveInterval;this.options.throttledSaves=throttledSaves;if(this.options.throttledSaves!==undefined){this._throttledSaves=this.options.throttledSaves}this.options.autosave=autosave;this.autosaveDisable();let loaded;this.options.autoload=autoload;this.options.inflate=inflate;if(this.options.autoload){loaded=this.loadDatabase(this.options.inflate)}else{loaded=Promise.resolve()}return loaded.then(()=>{if(this.options.autosave){this.autosaveEnable()}})}copy(options={}){const databaseCopy=new Loki(this.filename,{env:"NA"});let clen;let idx;databaseCopy.loadJSONObject(this,{retainDirtyFlags:true});if(options.removeNonSerializable!==undefined&&options.removeNonSerializable===true){databaseCopy.autosaveHandle=null;databaseCopy.persistenceAdapter=null;clen=databaseCopy.collections.length;for(idx=0;idx<clen;idx++){databaseCopy.collections[idx].constraints=null;databaseCopy.collections[idx].ttl=null}}return databaseCopy}addCollection(name,options){const collection=new __WEBPACK_IMPORTED_MODULE_1__collection__["a"](name,options);this.collections.push(collection);if(this.verbose)collection.console=console;return collection}loadCollection(collection){if(!collection.name){throw new Error("Collection must have a name property to be loaded")}this.collections.push(collection)}getCollection(collectionName){let i;const len=this.collections.length;for(i=0;i<len;i+=1){if(this.collections[i].name===collectionName){return this.collections[i]}}this.emit("warning","collection "+collectionName+" not found");return null}listCollections(){let i=this.collections.length;const colls=[];while(i--){colls.push({name:this.collections[i].name,type:this.collections[i].objType,count:this.collections[i].data.length})}return colls}removeCollection(collectionName){let i;const len=this.collections.length;for(i=0;i<len;i+=1){if(this.collections[i].name===collectionName){const tmpcol=new __WEBPACK_IMPORTED_MODULE_1__collection__["a"](collectionName,{});const curcol=this.collections[i];for(const prop in curcol){if(curcol[prop]!==undefined&&tmpcol[prop]!==undefined){curcol[prop]=tmpcol[prop]}}this.collections.splice(i,1);return}}}getName(){return this.name}serialize(options={}){if(options.serializationMethod===undefined){options.serializationMethod=this.options.serializationMethod}switch(options.serializationMethod){case"normal":return JSON.stringify(this);case"pretty":return JSON.stringify(this,null,2);case"destructured":return this.serializeDestructured();default:return JSON.stringify(this)}}toJSON(){return{ENV:this.ENV,serializationMethod:this.serializationMethod,autosave:this.autosave,autosaveInterval:this.autosaveInterval,collections:this.collections,databaseVersion:this.databaseVersion,engineVersion:this.engineVersion,filename:this.filename,options:this.options,persistenceAdapter:this.persistenceAdapter,persistenceMethod:this.persistenceMethod,_throttledSaves:this._throttledSaves,verbose:this.verbose}}serializeDestructured(options={}){let idx;let sidx;let result;let resultlen;const reconstruct=[];let dbcopy;if(options.partitioned===undefined){options.partitioned=false}if(options.delimited===undefined){options.delimited=true}if(options.delimiter===undefined){options.delimiter=this.options.destructureDelimiter}if(options.partitioned===true&&options.partition!==undefined&&options.partition>=0){return this.serializeCollection({delimited:options.delimited,delimiter:options.delimiter,collectionIndex:options.partition})}dbcopy=new Loki(this.filename);dbcopy.loadJSONObject(this);for(idx=0;idx<dbcopy.collections.length;idx++){dbcopy.collections[idx].data=[]}if(options.partitioned===true&&options.partition===-1){return dbcopy.serialize({serializationMethod:"normal"})}reconstruct.push(dbcopy.serialize({serializationMethod:"normal"}));dbcopy=null;for(idx=0;idx<this.collections.length;idx++){result=this.serializeCollection({delimited:options.delimited,delimiter:options.delimiter,collectionIndex:idx});if(options.partitioned===false&&options.delimited===false){if(!Array.isArray(result)){throw new Error("a nondelimited, non partitioned collection serialization did not return an expected array")}resultlen=result.length;for(sidx=0;sidx<resultlen;sidx++){reconstruct.push(result[sidx]);result[sidx]=null}reconstruct.push("")}else{reconstruct.push(result)}}if(options.partitioned){if(options.delimited){return reconstruct}else{return reconstruct}}else{if(options.delimited){reconstruct.push("");return reconstruct.join(options.delimiter)}else{reconstruct.push("");return reconstruct}}}serializeCollection(options={}){let doccount;let docidx;let resultlines=[];if(options.delimited===undefined){options.delimited=true}if(options.collectionIndex===undefined){throw new Error("serializeCollection called without 'collectionIndex' option")}doccount=this.collections[options.collectionIndex].data.length;resultlines=[];for(docidx=0;docidx<doccount;docidx++){resultlines.push(JSON.stringify(this.collections[options.collectionIndex].data[docidx]))}if(options.delimited){resultlines.push("");return resultlines.join(options.delimiter)}else{return resultlines}}deserializeDestructured(destructuredSource,options={}){let workarray=[];let len;let cdb;let collIndex=0;let collCount;let lineIndex=1;let done=false;let currObject;if(options.partitioned===undefined){options.partitioned=false}if(options.delimited===undefined){options.delimited=true}if(options.delimiter===undefined){options.delimiter=this.options.destructureDelimiter}if(options.partitioned){if(options.partition!==undefined){if(options.partition===-1){cdb=JSON.parse(destructuredSource[0]);return cdb}return this.deserializeCollection(destructuredSource[options.partition+1],options)}cdb=JSON.parse(destructuredSource[0]);collCount=cdb.collections.length;for(collIndex=0;collIndex<collCount;collIndex++){cdb.collections[collIndex].data=this.deserializeCollection(destructuredSource[collIndex+1],options)}return cdb}if(options.delimited){workarray=destructuredSource.split(options.delimiter);destructuredSource=null;len=workarray.length;if(len===0){return null}}else{workarray=destructuredSource}cdb=JSON.parse(workarray[0]);collCount=cdb.collections.length;workarray[0]=null;while(!done){if(workarray[lineIndex]===""){if(++collIndex>collCount){done=true}}else{currObject=JSON.parse(workarray[lineIndex]);cdb.collections[collIndex].data.push(currObject)}workarray[lineIndex++]=null}return cdb}deserializeCollection(destructuredSource,options={}){let workarray=[];let idx;let len;if(options.partitioned===undefined){options.partitioned=false}if(options.delimited===undefined){options.delimited=true}if(options.delimiter===undefined){options.delimiter=this.options.destructureDelimiter}if(options.delimited){workarray=destructuredSource.split(options.delimiter);workarray.pop()}else{workarray=destructuredSource}len=workarray.length;for(idx=0;idx<len;idx++){workarray[idx]=JSON.parse(workarray[idx])}return workarray}loadJSON(serializedDb,options){let dbObject;if(serializedDb.length===0){dbObject={}}else{switch(this.options.serializationMethod){case"normal":case"pretty":dbObject=JSON.parse(serializedDb);break;case"destructured":dbObject=this.deserializeDestructured(serializedDb);break;default:dbObject=JSON.parse(serializedDb);break}}this.loadJSONObject(dbObject,options)}loadJSONObject(dbObject,options={}){const len=dbObject.collections?dbObject.collections.length:0;this.name=dbObject.name;this.collections=[];for(let i=0;i<len;++i){this.collections.push(__WEBPACK_IMPORTED_MODULE_1__collection__["a"].fromJSONObject(dbObject.collections[i],options,dbObject.databaseVersion<1.5))}}close(){let saved;if(this.autosave){this.autosaveDisable();for(let idx=0;idx<this.collections.length;idx++){if(this.collections[idx].dirty){saved=this.saveDatabase();break}}}return Promise.resolve(saved).then(()=>{this.emit("close")})}generateChangesNotification(arrayOfCollectionNames){function getCollName(coll){return coll.name}let changes=[];const selectedCollections=arrayOfCollectionNames||this.collections.map(getCollName);this.collections.forEach(coll=>{if(selectedCollections.indexOf(getCollName(coll))!==-1){changes=changes.concat(coll.getChanges())}});return changes}serializeChanges(collectionNamesArray){return JSON.stringify(this.generateChangesNotification(collectionNamesArray))}clearChanges(){this.collections.forEach(coll=>{if(coll.flushChanges){coll.flushChanges()}})}throttledSaveDrain(options={}){const now=(new Date).getTime();if(!this._throttledSaves){return Promise.resolve()}if(options.recursiveWait===undefined){options.recursiveWait=true}if(options.recursiveWaitLimit===undefined){options.recursiveWaitLimit=false}if(options.recursiveWaitLimitDuration===undefined){options.recursiveWaitLimitDuration=2e3}if(options.started===undefined){options.started=(new Date).getTime()}if(this._throttledSaves&&this._throttledSaveRunning!==null){if(options.recursiveWait){return Promise.resolve(Promise.all([this._throttledSaveRunning,this._throttledSavePending])).then(()=>{if(this._throttledSaveRunning!==null||this._throttledSavePending!==null){if(options.recursiveWaitLimit&&now-options.started>options.recursiveWaitLimitDuration){return Promise.reject()}return this.throttledSaveDrain(options)}else{return Promise.resolve()}})}else{return Promise.resolve(this._throttledSaveRunning)}}else{return Promise.resolve()}}_loadDatabase(options={}){if(this.persistenceAdapter===null){return Promise.reject(new Error("persistenceAdapter not configured"))}return Promise.resolve(this.persistenceAdapter.loadDatabase(this.filename)).then(dbString=>{if(typeof dbString==="string"){this.loadJSON(dbString,options);this.emit("load",this)}else{if(typeof dbString==="object"&&dbString!==null&&!(dbString instanceof Error)){this.loadJSONObject(dbString,options);this.emit("load",this)}else{if(dbString instanceof Error)throw dbString;throw new TypeError("The persistence adapter did not load a serialized DB string or object.")}}})}loadDatabase(options){if(!this._throttledSaves){return this._loadDatabase(options)}return this.throttledSaveDrain(options).then(()=>{this._throttledSaveRunning=this._loadDatabase(options).then(()=>{this._throttledSaveRunning=null});return this._throttledSaveRunning},()=>{throw new Error("Unable to pause save throttling long enough to read database")})}_saveDatabase(){if(this.persistenceAdapter===null){return Promise.reject(new Error("persistenceAdapter not configured"))}let saved;if(this.persistenceAdapter.mode==="reference"&&typeof this.persistenceAdapter.exportDatabase==="function"){saved=this.persistenceAdapter.exportDatabase(this.filename,this.copy({removeNonSerializable:true}))}else{saved=this.persistenceAdapter.saveDatabase(this.filename,this.serialize())}return Promise.resolve(saved).then(()=>{for(let idx=0;idx<this.collections.length;idx++){this.collections[idx].dirty=false}this.emit("save")})}saveDatabase(){if(!this._throttledSaves){return this._saveDatabase()}if(this._throttledSaveRunning!==null&&this._throttledSavePending===null){this._throttledSavePending=Promise.resolve(this._throttledSaveRunning).then(()=>{this._throttledSaveRunning=null;this._throttledSavePending=null;return this.saveDatabase()})}if(this._throttledSavePending!==null){return this._throttledSavePending}this._throttledSaveRunning=this._saveDatabase().then(()=>{this._throttledSaveRunning=null});return this._throttledSaveRunning}deleteDatabase(){if(this.persistenceAdapter===null){return Promise.reject(new Error("persistenceAdapter not configured"))}return Promise.resolve(this.persistenceAdapter.deleteDatabase(this.filename))}autosaveEnable(){if(this.autosaveHandle){return}let running=true;this.autosave=true;this.autosaveHandle=(()=>{running=false;this.autosaveHandle=undefined});setTimeout(()=>{if(running){this.saveDatabase().then(this.saveDatabase,this.saveDatabase)}},this.autosaveInterval)}autosaveDisable(){this.autosave=false;if(this.autosaveHandle){this.autosaveHandle()}}}__webpack_exports__["Loki"]=Loki;__webpack_exports__["default"]=Loki}).call(__webpack_exports__,__webpack_require__(7))},function(module,__webpack_exports__,__webpack_require__){"use strict";var __WEBPACK_IMPORTED_MODULE_0__event_emitter__=__webpack_require__(0);var __WEBPACK_IMPORTED_MODULE_1__unique_index__=__webpack_require__(8);var __WEBPACK_IMPORTED_MODULE_2__exact_index__=__webpack_require__(9);var __WEBPACK_IMPORTED_MODULE_3__resultset__=__webpack_require__(3);var __WEBPACK_IMPORTED_MODULE_4__dynamic_view__=__webpack_require__(10);var __WEBPACK_IMPORTED_MODULE_5__clone__=__webpack_require__(4);var __WEBPACK_IMPORTED_MODULE_6__helper__=__webpack_require__(6);var __WEBPACK_IMPORTED_MODULE_7__loki__=__webpack_require__(1);var __WEBPACK_IMPORTED_MODULE_8__utils__=__webpack_require__(5);function isDeepProperty(field){return field.indexOf(".")!==-1}function parseBase10(num){return parseFloat(num,10)}function add(a,b){return a+b}function sub(a,b){return a-b}function average(array){return array.reduce(add,0)/array.length}function standardDeviation(values){const avg=average(values);const squareDiffs=values.map(value=>{const diff=value-avg;const sqrDiff=diff*diff;return sqrDiff});const avgSquareDiff=average(squareDiffs);const stdDev=Math.sqrt(avgSquareDiff);return stdDev}function deepProperty(obj,property,isDeep){if(isDeep===false){return obj[property]}const pieces=property.split(".");let root=obj;while(pieces.length>0){root=root[pieces.shift()]}return root}class Collection extends __WEBPACK_IMPORTED_MODULE_0__event_emitter__["a"]{constructor(name,options={}){super();this.name=name;this.data=[];this.idIndex=[];this.binaryIndices={};this.constraints={unique:{},exact:{}};this.uniqueNames=[];this.transforms={};this.objType=name;this.dirty=true;this.cachedIndex=null;this.cachedBinaryIndex=null;this.cachedData=null;if(options.unique!==undefined){if(!Array.isArray(options.unique)){options.unique=[options.unique]}options.unique.forEach(prop=>{this.uniqueNames.push(prop);this.constraints.unique[prop]=new __WEBPACK_IMPORTED_MODULE_1__unique_index__["a"](prop)})}if(options.exact!==undefined){options.exact.forEach(prop=>{this.constraints.exact[prop]=new __WEBPACK_IMPORTED_MODULE_2__exact_index__["a"](prop)})}this._fullTextSearch=null;if(__WEBPACK_IMPORTED_MODULE_7__loki__["Loki"].FullTextSearch!==undefined){this._fullTextSearch=options.fullTextSearch!==undefined?new __WEBPACK_IMPORTED_MODULE_7__loki__["Loki"].FullTextSearch.FullTextSearch(options.fullTextSearch):null}this.adaptiveBinaryIndices=options.adaptiveBinaryIndices!==undefined?options.adaptiveBinaryIndices:true;this.transactional=options.transactional!==undefined?options.transactional:false;this.cloneObjects=options.clone!==undefined?options.clone:false;this.cloneMethod=options.cloneMethod!==undefined?options.cloneMethod:"parse-stringify";this.asyncListeners=options.asyncListeners!==undefined?options.asyncListeners:false;this.disableChangesApi=options.disableChangesApi!==undefined?options.disableChangesApi:true;this.autoupdate=options.autoupdate!==undefined?options.autoupdate:false;this.serializableIndices=options.serializableIndices!==undefined?options.serializableIndices:true;this.ttl={age:null,ttlInterval:null,daemon:null};this.setTTL(options.ttl||-1,options.ttlInterval);this.maxId=0;this._dynamicViews=[];this.events={insert:[],update:[],"pre-insert":[],"pre-update":[],close:[],flushbuffer:[],error:[],delete:[],warning:[]};this.changes=[];this.ensureId();let indices=[];if(options&&options.indices){if(Object.prototype.toString.call(options.indices)==="[object Array]"){indices=options.indices}else if(typeof options.indices==="string"){indices=[options.indices]}else{throw new TypeError("Indices needs to be a string or an array of strings")}}for(let idx=0;idx<indices.length;idx++){this.ensureIndex(indices[idx])}function observerCallback(changes){const changedObjects=typeof Set==="function"?new Set:[];if(!changedObjects.add)changedObjects.add=function(object){if(this.indexOf(object)===-1)this.push(object);return this};changes.forEach(change=>{changedObjects.add(change.object)});changedObjects.forEach(object=>{if(object.$loki===undefined)return this.removeAutoUpdateObserver(object);try{this.update(object)}catch(err){}})}this.observerCallback=observerCallback;const self=this;function createChange(name,op,obj){self.changes.push({name:name,operation:op,obj:JSON.parse(JSON.stringify(obj))})}function flushChanges(){self.changes=[]}this.getChanges=(()=>this.changes);this.flushChanges=flushChanges;function insertMeta(obj){let len;let idx;if(!obj){return}if(Array.isArray(obj)){len=obj.length;for(idx=0;idx<len;idx++){if(obj[idx].meta===undefined){obj[idx].meta={}}obj[idx].meta.created=(new Date).getTime();obj[idx].meta.revision=0}return}if(!obj.meta){obj.meta={}}obj.meta.created=(new Date).getTime();obj.meta.revision=0}function updateMeta(obj){if(!obj){return}obj.meta.updated=(new Date).getTime();obj.meta.revision+=1}function createInsertChange(obj){createChange(self.name,"I",obj)}function createUpdateChange(obj){createChange(self.name,"U",obj)}function insertMetaWithChange(obj){insertMeta(obj);createInsertChange(obj)}function updateMetaWithChange(obj){updateMeta(obj);createUpdateChange(obj)}let insertHandler;let updateHandler;function setHandlers(){insertHandler=self.disableChangesApi?insertMeta:insertMetaWithChange;updateHandler=self.disableChangesApi?updateMeta:updateMetaWithChange}setHandlers();this.setChangesApi=(enabled=>{this.disableChangesApi=!enabled;setHandlers()});this.on("insert",obj=>{insertHandler(obj)});this.on("update",obj=>{updateHandler(obj)});this.on("delete",obj=>{if(!this.disableChangesApi){createChange(this.name,"R",obj)}});this.on("warning",warning=>{this.console.warn(warning)});flushChanges();this.console={log(){},warn(){},error(){}};this.stages={};this.commitLog=[]}toJSON(){return{name:this.name,_dynamicViews:this._dynamicViews,uniqueNames:this.uniqueNames,transforms:this.transforms,binaryIndices:this.binaryIndices,data:this.data,idIndex:this.idIndex,maxId:this.maxId,dirty:this.dirty,adaptiveBinaryIndices:this.adaptiveBinaryIndices,transactional:this.transactional,asyncListeners:this.asyncListeners,disableChangesApi:this.disableChangesApi,cloneObjects:this.cloneObjects,cloneMethod:this.cloneMethod,autoupdate:this.autoupdate,changes:this.changes}}static fromJSONObject(obj,options,forceRebuild){let coll=new Collection(obj.name,{disableChangesApi:obj.disableChangesApi});coll.adaptiveBinaryIndices=obj.adaptiveBinaryIndices!==undefined?obj.adaptiveBinaryIndices===true:false;coll.transactional=obj.transactional;coll.asyncListeners=obj.asyncListeners;coll.disableChangesApi=obj.disableChangesApi;coll.cloneObjects=obj.cloneObjects;coll.cloneMethod=obj.cloneMethod||"parse-stringify";coll.autoupdate=obj.autoupdate;coll.changes=obj.changes;coll.dirty=options.retainDirtyFlags===true?obj.dirty:false;function makeLoader(coll){const collOptions=options[coll.name];let inflater;if(collOptions.proto){inflater=collOptions.inflate||__WEBPACK_IMPORTED_MODULE_8__utils__["a"];return data=>{const collObj=new collOptions.proto;inflater(data,collObj);return collObj}}return collOptions.inflate}let clen=obj.data.length;let j=0;if(options&&options[obj.name]!==undefined){let loader=makeLoader(obj);for(j;j<clen;j++){let collObj=loader(obj.data[j]);coll.data[j]=collObj;coll.addAutoUpdateObserver(coll)}}else{for(j;j<clen;j++){coll.data[j]=obj.data[j];coll.addAutoUpdateObserver(coll.data[j])}}coll.maxId=typeof obj.maxId==="undefined"?0:obj.maxId;coll.idIndex=obj.idIndex;if(obj.binaryIndices!==undefined){coll.binaryIndices=obj.binaryIndices}if(obj.transforms!==undefined){coll.transforms=obj.transforms}coll.ensureId();coll.uniqueNames=[];if(obj.uniqueNames!==undefined){coll.uniqueNames=obj.uniqueNames;for(j=0;j<coll.uniqueNames.length;j++){coll.ensureUniqueIndex(coll.uniqueNames[j])}}if(obj._dynamicViews===undefined)return coll;for(let idx=0;idx<obj._dynamicViews.length;idx++){coll._dynamicViews.push(__WEBPACK_IMPORTED_MODULE_4__dynamic_view__["a"].fromJSONObject(coll,obj._dynamicViews[idx]))}if(forceRebuild){coll.ensureAllIndexes(true);coll.dirty=true}return coll}addAutoUpdateObserver(object){if(!this.autoupdate||typeof Object.observe!=="function")return;Object.observe(object,this.observerCallback,["add","update","delete","reconfigure","setPrototype"])}removeAutoUpdateObserver(object){if(!this.autoupdate||typeof Object.observe!=="function")return;Object.unobserve(object,this.observerCallback)}addTransform(name,transform){if(this.transforms[name]!==undefined){throw new Error("a transform by that name already exists")}this.transforms[name]=transform}setTransform(name,transform){this.transforms[name]=transform}removeTransform(name){delete this.transforms[name]}byExample(template){let k;let obj;let query;query=[];for(k in template){if(template[k]===undefined)continue;query.push((obj={},obj[k]=template[k],obj))}return{$and:query}}findObject(template){return this.findOne(this.byExample(template))}findObjects(template){return this.find(this.byExample(template))}ttlDaemonFuncGen(){const collection=this;const age=this.ttl.age;return function ttlDaemon(){const now=Date.now();const toRemove=collection.chain().where(function daemonFilter(member){const timestamp=member.meta.updated||member.meta.created;const diff=now-timestamp;return age<diff});toRemove.remove()}}setTTL(age,interval){if(age<0){clearInterval(this.ttl.daemon)}else{this.ttl.age=age;this.ttl.ttlInterval=interval;this.ttl.daemon=setInterval(this.ttlDaemonFuncGen(),interval)}}prepareFullDocIndex(){const len=this.data.length;const indexes=new Array(len);for(let i=0;i<len;i+=1){indexes[i]=i}return indexes}configureOptions(options){options=options||{};if(options.adaptiveBinaryIndices!==undefined){this.adaptiveBinaryIndices=options.adaptiveBinaryIndices;if(this.adaptiveBinaryIndices){this.ensureAllIndexes()}}}ensureIndex(property,force){if(typeof force==="undefined"){force=false}if(property===null||property===undefined){throw new Error("Attempting to set index without an associated property")}if(this.binaryIndices[property]&&!force){if(!this.binaryIndices[property].dirty)return}if(this.adaptiveBinaryIndices===true&&this.binaryIndices[property]!==undefined&&!force){return}const index={name:property,dirty:true,values:this.prepareFullDocIndex()};this.binaryIndices[property]=index;const wrappedComparer=((p,data)=>(a,b)=>{const objAp=data[a][p];const objBp=data[b][p];if(objAp!==objBp){if(Object(__WEBPACK_IMPORTED_MODULE_6__helper__["c"])(objAp,objBp,false))return-1;if(Object(__WEBPACK_IMPORTED_MODULE_6__helper__["b"])(objAp,objBp,false))return 1}return 0})(property,this.data);index.values.sort(wrappedComparer);index.dirty=false;this.dirty=true}getSequencedIndexValues(property){let idx;const idxvals=this.binaryIndices[property].values;let result="";for(idx=0;idx<idxvals.length;idx++){result+=" ["+idx+"] "+this.data[idxvals[idx]][property]}return result}ensureUniqueIndex(field){let index=this.constraints.unique[field];if(!index){if(this.uniqueNames.indexOf(field)==-1){this.uniqueNames.push(field)}}this.constraints.unique[field]=index=new __WEBPACK_IMPORTED_MODULE_1__unique_index__["a"](field);this.data.forEach(obj=>{index.set(obj)});return index}ensureAllIndexes(force){let key;const bIndices=this.binaryIndices;for(key in bIndices){if(bIndices[key]!==undefined){this.ensureIndex(key,force)}}}flagBinaryIndexesDirty(){let key;const bIndices=this.binaryIndices;for(key in bIndices){if(bIndices[key]!==undefined){bIndices[key].dirty=true}}}flagBinaryIndexDirty(index){if(this.binaryIndices[index])this.binaryIndices[index].dirty=true}count(query){if(!query){return this.data.length}return this.chain().find(query).filteredrows.length}ensureId(){const len=this.data.length;let i=0;this.idIndex=[];for(i;i<len;i+=1){this.idIndex.push(this.data[i].$loki)}}addDynamicView(name,options){const dv=new __WEBPACK_IMPORTED_MODULE_4__dynamic_view__["a"](this,name,options);this._dynamicViews.push(dv);return dv}removeDynamicView(name){for(let idx=0;idx<this._dynamicViews.length;idx++){if(this._dynamicViews[idx].name===name){this._dynamicViews.splice(idx,1)}}}getDynamicView(name){for(let idx=0;idx<this._dynamicViews.length;idx++){if(this._dynamicViews[idx].name===name){return this._dynamicViews[idx]}}return null}findAndUpdate(filterObject,updateFunction){if(typeof filterObject==="function"){this.updateWhere(filterObject,updateFunction)}else{this.chain().find(filterObject).update(updateFunction)}}findAndRemove(filterObject){this.chain().find(filterObject).remove()}insert(doc){if(!Array.isArray(doc)){return this.insertOne(doc)}let obj;let results=[];this.emit("pre-insert",doc);for(let i=0,len=doc.length;i<len;i++){obj=this.insertOne(doc[i],true);if(!obj){return undefined}results.push(obj)}this.emit("insert",results);results=this.cloneObjects?Object(__WEBPACK_IMPORTED_MODULE_5__clone__["a"])(results,this.cloneMethod):results;return results.length===1?results[0]:results}insertOne(doc,bulkInsert){let err=null;let returnObj;if(typeof doc!=="object"){err=new TypeError("Document needs to be an object")}else if(doc===null){err=new TypeError("Object cannot be null")}if(err!==null){this.emit("error",err);throw err}const obj=this.cloneObjects?Object(__WEBPACK_IMPORTED_MODULE_5__clone__["a"])(doc,this.cloneMethod):doc;if(typeof obj.meta==="undefined"){obj.meta={revision:0,created:0}}if(!bulkInsert){this.emit("pre-insert",obj)}if(!this.add(obj)){return undefined}if(this._fullTextSearch!==null){this._fullTextSearch.addDocument(doc)}returnObj=obj;if(!bulkInsert){this.emit("insert",obj);returnObj=this.cloneObjects?Object(__WEBPACK_IMPORTED_MODULE_5__clone__["a"])(obj,this.cloneMethod):obj}this.addAutoUpdateObserver(returnObj);return returnObj}clear(options){options=options||{};this.data=[];this.idIndex=[];this.cachedIndex=null;this.cachedBinaryIndex=null;this.cachedData=null;this.maxId=0;this._dynamicViews=[];this.dirty=true;if(options.removeIndices===true){this.binaryIndices={};this.constraints={unique:{},exact:{}};this.uniqueNames=[]}else{const keys=Object.keys(this.binaryIndices);keys.forEach(biname=>{this.binaryIndices[biname].dirty=false;this.binaryIndices[biname].values=[]});this.constraints={unique:{},exact:{}};this.uniqueNames.forEach(uiname=>{this.ensureUniqueIndex(uiname)})}}update(doc){if(Array.isArray(doc)){let k=0;const len=doc.length;for(k;k<len;k+=1){this.update(doc[k])}return}if(doc.$loki===undefined){throw new Error("Trying to update unsynced document. Please save the document first by using insert() or addMany()")}try{this.startTransaction();const arr=this.get(doc.$loki,true);let oldInternal;let newInternal;let position;if(!arr){throw new Error("Trying to update a document not in collection.")}oldInternal=arr[0];position=arr[1];newInternal=this.cloneObjects?Object(__WEBPACK_IMPORTED_MODULE_5__clone__["a"])(doc,this.cloneMethod):doc;this.emit("pre-update",doc);Object.keys(this.constraints.unique).forEach(key=>{this.constraints.unique[key].update(oldInternal,newInternal)});this.data[position]=newInternal;if(newInternal!==doc){this.addAutoUpdateObserver(doc)}for(let idx=0;idx<this._dynamicViews.length;idx++){this._dynamicViews[idx].evaluateDocument(position,false)}let key;if(this.adaptiveBinaryIndices){const bIndices=this.binaryIndices;for(key in bIndices){this.adaptiveBinaryIndexUpdate(position,key)}}else{this.flagBinaryIndexesDirty()}this.idIndex[position]=newInternal.$loki;if(this._fullTextSearch!==null){this._fullTextSearch.updateDocument(doc)}this.commit();this.dirty=true;this.emit("update",doc,this.cloneObjects?Object(__WEBPACK_IMPORTED_MODULE_5__clone__["a"])(oldInternal,this.cloneMethod):null);return doc}catch(err){this.rollback();this.console.error(err.message);this.emit("error",err);throw err}}add(obj){if("object"!==typeof obj){throw new TypeError("Object being added needs to be an object")}if(typeof obj.$loki!=="undefined"){throw new Error("Document is already in collection, please use update()")}try{this.startTransaction();this.maxId++;if(isNaN(this.maxId)){this.maxId=this.data[this.data.length-1].$loki+1}obj.$loki=this.maxId;obj.meta.version=0;let key;const constrUnique=this.constraints.unique;for(key in constrUnique){if(constrUnique[key]!==undefined){constrUnique[key].set(obj)}}this.idIndex.push(obj.$loki);this.data.push(obj);const addedPos=this.data.length-1;const dvlen=this._dynamicViews.length;for(let i=0;i<dvlen;i++){this._dynamicViews[i].evaluateDocument(addedPos,true)}if(this.adaptiveBinaryIndices){const bIndices=this.binaryIndices;for(key in bIndices){this.adaptiveBinaryIndexInsert(addedPos,key)}}else{this.flagBinaryIndexesDirty()}this.commit();this.dirty=true;return this.cloneObjects?Object(__WEBPACK_IMPORTED_MODULE_5__clone__["a"])(obj,this.cloneMethod):obj}catch(err){this.rollback();this.console.error(err.message);this.emit("error",err);throw err}}updateWhere(filterFunction,updateFunction){const results=this.where(filterFunction);let i=0;let obj;try{for(i;i<results.length;i++){obj=updateFunction(results[i]);this.update(obj)}}catch(err){this.rollback();this.console.error(err.message)}}removeWhere(query){let list;if(typeof query==="function"){list=this.data.filter(query);this.remove(list)}else{this.chain().find(query).remove()}}removeDataOnly(){this.remove(this.data.slice())}remove(doc){if(typeof doc==="number"){doc=this.get(doc)}if("object"!==typeof doc){throw new Error("Parameter is not an object")}if(Array.isArray(doc)){let k=0;const len=doc.length;for(k;k<len;k+=1){this.remove(doc[k])}return}if(doc.$loki===undefined){throw new Error("Object is not a document stored in the collection")}try{this.startTransaction();const arr=this.get(doc.$loki,true);const position=arr[1];Object.keys(this.constraints.unique).forEach(key=>{if(doc[key]!==null&&typeof doc[key]!=="undefined"){this.constraints.unique[key].remove(doc[key])}});for(let idx=0;idx<this._dynamicViews.length;idx++){this._dynamicViews[idx].removeDocument(position)}if(this.adaptiveBinaryIndices){let key;const bIndices=this.binaryIndices;for(key in bIndices){this.adaptiveBinaryIndexRemove(position,key)}}else{this.flagBinaryIndexesDirty()}this.data.splice(position,1);this.removeAutoUpdateObserver(doc);this.idIndex.splice(position,1);if(this._fullTextSearch!=null){this._fullTextSearch.removeDocument(doc)}this.commit();this.dirty=true;this.emit("delete",arr[0]);delete doc.$loki;delete doc.meta;return doc}catch(err){this.rollback();this.console.error(err.message);this.emit("error",err);return null}}get(id,returnPosition){const retpos=returnPosition||false;const data=this.idIndex;let max=data.length-1;let min=0;let mid=min+max>>1;id=typeof id==="number"?id:parseInt(id,10);if(isNaN(id)){throw new TypeError("Passed id is not an integer")}while(data[min]<data[max]){mid=min+max>>1;if(data[mid]<id){min=mid+1}else{max=mid}}if(max===min&&data[min]===id){if(retpos){return[this.data[min],min]}return this.data[min]}return null}getBinaryIndexPosition(dataPosition,binaryIndexName){const val=this.data[dataPosition][binaryIndexName];const index=this.binaryIndices[binaryIndexName].values;const range=this.calculateRange("$eq",binaryIndexName,val);if(range[0]===0&&range[1]===-1){return null}const min=range[0];const max=range[1];for(let idx=min;idx<=max;idx++){if(index[idx]===dataPosition)return idx}return null}adaptiveBinaryIndexInsert(dataPosition,binaryIndexName){const index=this.binaryIndices[binaryIndexName].values;let val=this.data[dataPosition][binaryIndexName];if(this.serializableIndices===true&&val instanceof Date){this.data[dataPosition][binaryIndexName]=val.getTime();val=this.data[dataPosition][binaryIndexName]}const idxPos=index.length===0?0:this.calculateRangeStart(binaryIndexName,val,true);this.binaryIndices[binaryIndexName].values.splice(idxPos,0,dataPosition)}adaptiveBinaryIndexUpdate(dataPosition,binaryIndexName){let idxPos;const index=this.binaryIndices[binaryIndexName].values;const len=index.length;for(idxPos=0;idxPos<len;idxPos++){if(index[idxPos]===dataPosition)break}this.binaryIndices[binaryIndexName].values.splice(idxPos,1);this.adaptiveBinaryIndexInsert(dataPosition,binaryIndexName)}adaptiveBinaryIndexRemove(dataPosition,binaryIndexName,removedFromIndexOnly){const idxPos=this.getBinaryIndexPosition(dataPosition,binaryIndexName);const index=this.binaryIndices[binaryIndexName].values;let len;let idx;if(idxPos===null){return null}this.binaryIndices[binaryIndexName].values.splice(idxPos,1);if(removedFromIndexOnly===true){return}len=index.length;for(idx=0;idx<len;idx++){if(index[idx]>dataPosition){index[idx]--}}}calculateRangeStart(prop,val,adaptive){const rcd=this.data;const index=this.binaryIndices[prop].values;let min=0;let max=index.length-1;let mid=0;if(index.length===0){return-1}while(min<max){mid=min+max>>1;if(Object(__WEBPACK_IMPORTED_MODULE_6__helper__["c"])(rcd[index[mid]][prop],val,false)){min=mid+1}else{max=mid}}const lbound=min;if(Object(__WEBPACK_IMPORTED_MODULE_6__helper__["a"])(val,rcd[index[lbound]][prop])){return lbound}if(Object(__WEBPACK_IMPORTED_MODULE_6__helper__["c"])(val,rcd[index[lbound]][prop],false)){return adaptive?lbound:lbound-1}return adaptive?lbound+1:lbound}calculateRangeEnd(prop,val){const rcd=this.data;const index=this.binaryIndices[prop].values;let min=0;let max=index.length-1;let mid=0;if(index.length===0){return-1}while(min<max){mid=min+max>>1;if(Object(__WEBPACK_IMPORTED_MODULE_6__helper__["c"])(val,rcd[index[mid]][prop],false)){max=mid}else{min=mid+1}}const ubound=max;if(Object(__WEBPACK_IMPORTED_MODULE_6__helper__["a"])(val,rcd[index[ubound]][prop])){return ubound}if(Object(__WEBPACK_IMPORTED_MODULE_6__helper__["b"])(val,rcd[index[ubound]][prop],false)){return ubound+1}if(Object(__WEBPACK_IMPORTED_MODULE_6__helper__["a"])(val,rcd[index[ubound-1]][prop])){return ubound-1}return ubound}calculateRange(op,prop,val){const rcd=this.data;const index=this.binaryIndices[prop].values;const min=0;const max=index.length-1;let lbound;let lval;let ubound;if(rcd.length===0){return[0,-1]}const minVal=rcd[index[min]][prop];const maxVal=rcd[index[max]][prop];switch(op){case"$eq":case"$aeq":if(Object(__WEBPACK_IMPORTED_MODULE_6__helper__["c"])(val,minVal,false)||Object(__WEBPACK_IMPORTED_MODULE_6__helper__["b"])(val,maxVal,false)){return[0,-1]}break;case"$dteq":if(Object(__WEBPACK_IMPORTED_MODULE_6__helper__["c"])(val,minVal,false)||Object(__WEBPACK_IMPORTED_MODULE_6__helper__["b"])(val,maxVal,false)){return[0,-1]}break;case"$gt":if(Object(__WEBPACK_IMPORTED_MODULE_6__helper__["b"])(val,maxVal,true)){return[0,-1]}if(Object(__WEBPACK_IMPORTED_MODULE_6__helper__["b"])(minVal,val,false)){return[min,max]}break;case"$gte":if(Object(__WEBPACK_IMPORTED_MODULE_6__helper__["b"])(val,maxVal,false)){return[0,-1]}if(Object(__WEBPACK_IMPORTED_MODULE_6__helper__["b"])(minVal,val,true)){return[min,max]}break;case"$lt":if(Object(__WEBPACK_IMPORTED_MODULE_6__helper__["c"])(val,minVal,true)){return[0,-1]}if(Object(__WEBPACK_IMPORTED_MODULE_6__helper__["c"])(maxVal,val,false)){return[min,max]}break;case"$lte":if(Object(__WEBPACK_IMPORTED_MODULE_6__helper__["c"])(val,minVal,false)){return[0,-1]}if(Object(__WEBPACK_IMPORTED_MODULE_6__helper__["c"])(maxVal,val,true)){return[min,max]}break;case"$between":if(Object(__WEBPACK_IMPORTED_MODULE_6__helper__["b"])(val[0],maxVal,false)){return[0,-1]}if(Object(__WEBPACK_IMPORTED_MODULE_6__helper__["c"])(val[1],minVal,false)){return[0,-1]}lbound=this.calculateRangeStart(prop,val[0]);ubound=this.calculateRangeEnd(prop,val[1]);if(lbound<0)lbound++;if(ubound>max)ubound--;if(!Object(__WEBPACK_IMPORTED_MODULE_6__helper__["b"])(rcd[index[lbound]][prop],val[0],true))lbound++;if(!Object(__WEBPACK_IMPORTED_MODULE_6__helper__["c"])(rcd[index[ubound]][prop],val[1],true))ubound--;if(ubound<lbound)return[0,-1];return[lbound,ubound];case"$in":{const idxset=[];const segResult=[];for(let j=0,len=val.length;j<len;j++){const seg=this.calculateRange("$eq",prop,val[j]);for(let i=seg[0];i<=seg[1];i++){if(idxset[i]===undefined){idxset[i]=true;segResult.push(i)}}}return segResult}}switch(op){case"$eq":case"$aeq":case"$dteq":case"$gte":case"$lt":lbound=this.calculateRangeStart(prop,val);lval=rcd[index[lbound]][prop];break;default:break}switch(op){case"$eq":case"$aeq":case"$dteq":case"$lte":case"$gt":ubound=this.calculateRangeEnd(prop,val);break;default:break}switch(op){case"$eq":case"$aeq":case"$dteq":if(!Object(__WEBPACK_IMPORTED_MODULE_6__helper__["a"])(lval,val)){return[0,-1]}return[lbound,ubound];case"$gt":if(!Object(__WEBPACK_IMPORTED_MODULE_6__helper__["a"])(rcd[index[ubound]][prop],val)){return[ubound,max]}return[ubound+1,max];case"$gte":if(!Object(__WEBPACK_IMPORTED_MODULE_6__helper__["a"])(rcd[index[lbound]][prop],val)){return[lbound+1,max]}return[lbound,max];case"$lt":if(!Object(__WEBPACK_IMPORTED_MODULE_6__helper__["a"])(rcd[index[lbound]][prop],val)){return[min,lbound]}return[min,lbound-1];case"$lte":if(!Object(__WEBPACK_IMPORTED_MODULE_6__helper__["a"])(rcd[index[ubound]][prop],val)){return[min,ubound-1]}return[min,ubound];default:return[0,rcd.length-1]}}by(field,value){if(value===undefined){return value=>this.by(field,value)}const result=this.constraints.unique[field].get(value);if(!this.cloneObjects){return result}else{return Object(__WEBPACK_IMPORTED_MODULE_5__clone__["a"])(result,this.cloneMethod)}}findOne(query){query=query||{};const result=this.chain().find(query,true).data();if(Array.isArray(result)&&result.length===0){return null}else{if(!this.cloneObjects){return result[0]}else{return Object(__WEBPACK_IMPORTED_MODULE_5__clone__["a"])(result[0],this.cloneMethod)}}}chain(transform,parameters){const rs=new __WEBPACK_IMPORTED_MODULE_3__resultset__["a"](this);if(typeof transform==="undefined"){return rs}return rs.transform(transform,parameters)}find(query){return this.chain().find(query).data()}findOneUnindexed(prop,value){let i=this.data.length;let doc;while(i--){if(this.data[i][prop]===value){doc=this.data[i];return doc}}return null}startTransaction(){if(this.transactional){this.cachedData=Object(__WEBPACK_IMPORTED_MODULE_5__clone__["a"])(this.data,this.cloneMethod);this.cachedIndex=this.idIndex;this.cachedBinaryIndex=this.binaryIndices;for(let idx=0;idx<this._dynamicViews.length;idx++){this._dynamicViews[idx].startTransaction()}}}commit(){if(this.transactional){this.cachedData=null;this.cachedIndex=null;this.cachedBinaryIndex=null;for(let idx=0;idx<this._dynamicViews.length;idx++){this._dynamicViews[idx].commit()}}}rollback(){if(this.transactional){if(this.cachedData!==null&&this.cachedIndex!==null){this.data=this.cachedData;this.idIndex=this.cachedIndex;this.binaryIndices=this.cachedBinaryIndex}for(let idx=0;idx<this._dynamicViews.length;idx++){this._dynamicViews[idx].rollback()}}}where(fun){return this.chain().where(fun).data()}mapReduce(mapFunction,reduceFunction){try{return reduceFunction(this.data.map(mapFunction))}catch(err){throw err}}eqJoin(joinData,leftJoinProp,rightJoinProp,mapFun){return new __WEBPACK_IMPORTED_MODULE_3__resultset__["a"](this).eqJoin(joinData,leftJoinProp,rightJoinProp,mapFun)}getStage(name){if(!this.stages[name]){this.stages[name]={}}return this.stages[name]}stage(stageName,obj){const copy=JSON.parse(JSON.stringify(obj));this.getStage(stageName)[obj.$loki]=copy;return copy}commitStage(stageName,message){const stage=this.getStage(stageName);let prop;const timestamp=(new Date).getTime();for(prop in stage){this.update(stage[prop]);this.commitLog.push({timestamp:timestamp,message:message,data:JSON.parse(JSON.stringify(stage[prop]))})}this.stages[stageName]={}}no_op(){return}extract(field){let i=0;const len=this.data.length;const isDotNotation=isDeepProperty(field);const result=[];for(i;i<len;i+=1){result.push(deepProperty(this.data[i],field,isDotNotation))}return result}max(field){return Math.max.apply(null,this.extract(field))}min(field){return Math.min.apply(null,this.extract(field))}maxRecord(field){let i=0;const len=this.data.length;const deep=isDeepProperty(field);const result={index:0,value:undefined};let max;for(i;i<len;i+=1){if(max!==undefined){if(max<deepProperty(this.data[i],field,deep)){max=deepProperty(this.data[i],field,deep);result.index=this.data[i].$loki}}else{max=deepProperty(this.data[i],field,deep);result.index=this.data[i].$loki}}result.value=max;return result}minRecord(field){let i=0;const len=this.data.length;const deep=isDeepProperty(field);const result={index:0,value:undefined};let min;for(i;i<len;i+=1){if(min!==undefined){if(min>deepProperty(this.data[i],field,deep)){min=deepProperty(this.data[i],field,deep);result.index=this.data[i].$loki}}else{min=deepProperty(this.data[i],field,deep);result.index=this.data[i].$loki}}result.value=min;return result}extractNumerical(field){return this.extract(field).map(parseBase10).filter(Number).filter(n=>!isNaN(n))}avg(field){return average(this.extractNumerical(field))}stdDev(field){return standardDeviation(this.extractNumerical(field))}mode(field){const dict={};const data=this.extract(field);data.forEach(obj=>{if(dict[obj]){dict[obj]+=1}else{dict[obj]=1}});let max;let prop;let mode;for(prop in dict){if(max){if(max<dict[prop]){mode=prop}}else{mode=prop;max=dict[prop]}}return mode}median(field){const values=this.extractNumerical(field);values.sort(sub);const half=Math.floor(values.length/2);if(values.length%2){return values[half]}else{return(values[half-1]+values[half])/2}}}__webpack_exports__["a"]=Collection},function(module,__webpack_exports__,__webpack_require__){"use strict";var __WEBPACK_IMPORTED_MODULE_0__clone__=__webpack_require__(4);var __WEBPACK_IMPORTED_MODULE_1__collection__=__webpack_require__(2);var __WEBPACK_IMPORTED_MODULE_2__utils__=__webpack_require__(5);var __WEBPACK_IMPORTED_MODULE_3__helper__=__webpack_require__(6);function containsCheckFn(a){if(typeof a==="string"||Array.isArray(a)){return b=>a.indexOf(b)!==-1}else if(typeof a==="object"&&a!==null){return b=>hasOwnProperty.call(a,b)}return null}function doQueryOp(val,op){for(let p in op){if(hasOwnProperty.call(op,p)){return LokiOps[p](val,op[p])}}return false}const LokiOps={$eq(a,b){return a===b},$aeq(a,b){return a==b},$ne(a,b){if(b!==b){return a===a}return a!==b},$dteq(a,b){return Object(__WEBPACK_IMPORTED_MODULE_3__helper__["a"])(a,b)},$gt(a,b){return Object(__WEBPACK_IMPORTED_MODULE_3__helper__["b"])(a,b,false)},$gte(a,b){return Object(__WEBPACK_IMPORTED_MODULE_3__helper__["b"])(a,b,true)},$lt(a,b){return Object(__WEBPACK_IMPORTED_MODULE_3__helper__["c"])(a,b,false)},$lte(a,b){return Object(__WEBPACK_IMPORTED_MODULE_3__helper__["c"])(a,b,true)},$between(a,vals){if(a===undefined||a===null)return false;return Object(__WEBPACK_IMPORTED_MODULE_3__helper__["b"])(a,vals[0],true)&&Object(__WEBPACK_IMPORTED_MODULE_3__helper__["c"])(a,vals[1],true)},$in(a,b){return b.indexOf(a)!==-1},$nin(a,b){return b.indexOf(a)===-1},$keyin(a,b){return a in b},$nkeyin(a,b){return!(a in b)},$definedin(a,b){return b[a]!==undefined},$undefinedin(a,b){return b[a]===undefined},$regex(a,b){return b.test(a)},$containsString(a,b){return typeof a==="string"&&a.indexOf(b)!==-1},$containsNone(a,b){return!LokiOps.$containsAny(a,b)},$containsAny(a,b){const checkFn=containsCheckFn(a);if(checkFn!==null){return Array.isArray(b)?b.some(checkFn):checkFn(b)}return false},$contains(a,b){const checkFn=containsCheckFn(a);if(checkFn!==null){return Array.isArray(b)?b.every(checkFn):checkFn(b)}return false},$type(a,b){let type=typeof a;if(type==="object"){if(Array.isArray(a)){type="array"}else if(a instanceof Date){type="date"}}return typeof b!=="object"?type===b:doQueryOp(type,b)},$finite(a,b){return b===isFinite(a)},$size(a,b){if(Array.isArray(a)){return typeof b!=="object"?a.length===b:doQueryOp(a.length,b)}return false},$len(a,b){if(typeof a==="string"){return typeof b!=="object"?a.length===b:doQueryOp(a.length,b)}return false},$where(a,b){return b(a)===true},$not(a,b){return!doQueryOp(a,b)},$and(a,b){for(let idx=0,len=b.length;idx<len;idx+=1){if(!doQueryOp(a,b[idx])){return false}}return true},$or(a,b){for(let idx=0,len=b.length;idx<len;idx+=1){if(doQueryOp(a,b[idx])){return true}}return false}};const indexedOps={$eq:LokiOps.$eq,$aeq:true,$dteq:true,$gt:true,$gte:true,$lt:true,$lte:true,$in:true,$between:true};function compoundeval(properties,obj1,obj2){let res=0;let prop;let field;for(let i=0,len=properties.length;i<len;i++){prop=properties[i];field=prop[0];res=Object(__WEBPACK_IMPORTED_MODULE_3__helper__["d"])(obj1[field],obj2[field],prop[1]);if(res!==0){return res}}return 0}function dotSubScan(root,paths,fun,value,poffset){const pathOffset=poffset||0;const path=paths[pathOffset];if(root===undefined||root===null||root[path]===undefined){return false}let valueFound=false;const element=root[path];if(pathOffset+1>=paths.length){valueFound=fun(element,value)}else if(Array.isArray(element)){for(let index=0,len=element.length;index<len;index+=1){valueFound=dotSubScan(element[index],paths,fun,value,pathOffset+1);if(valueFound===true){break}}}else{valueFound=dotSubScan(element,paths,fun,value,pathOffset+1)}return valueFound}class Resultset{constructor(collection){this.collection=collection;this.filteredrows=[];this.filterInitialized=false}reset(){if(this.filteredrows.length>0){this.filteredrows=[]}this.filterInitialized=false;return this}toJSON(){const copy=this.copy();copy.collection=null;return copy}limit(qty){if(!this.filterInitialized&&this.filteredrows.length===0){this.filteredrows=this.collection.prepareFullDocIndex()}this.filteredrows=this.filteredrows.slice(0,qty);this.filterInitialized=true;return this}offset(pos){if(!this.filterInitialized&&this.filteredrows.length===0){this.filteredrows=this.collection.prepareFullDocIndex()}this.filteredrows=this.filteredrows.slice(pos);this.filterInitialized=true;return this}copy(){const result=new Resultset(this.collection);if(this.filteredrows.length>0){result.filteredrows=this.filteredrows.slice()}result.filterInitialized=this.filterInitialized;return result}branch(){return this.copy()}transform(transform,parameters){let idx;let step;let rs=this;if(typeof transform==="string"){if(this.collection.transforms[transform]!==undefined){transform=this.collection.transforms[transform]}}if(typeof transform!=="object"||!Array.isArray(transform)){throw new Error("Invalid transform")}if(typeof parameters!=="undefined"){transform=Object(__WEBPACK_IMPORTED_MODULE_2__utils__["b"])(transform,parameters)}for(idx=0;idx<transform.length;idx++){step=transform[idx];switch(step.type){case"find":rs.find(step.value);break;case"where":rs.where(step.value);break;case"simplesort":rs.simplesort(step.property,step.desc);break;case"compoundsort":rs.compoundsort(step.value);break;case"sort":rs.sort(step.value);break;case"limit":rs=rs.limit(step.value);break;case"offset":rs=rs.offset(step.value);break;case"map":rs=rs.map(step.value);break;case"eqJoin":rs=rs.eqJoin(step.joinData,step.leftJoinKey,step.rightJoinKey,step.mapFun);break;case"mapReduce":rs=rs.mapReduce(step.mapFunction,step.reduceFunction);break;case"update":rs.update(step.value);break;case"remove":rs.remove();break;default:break}}return rs}sort(comparefun){if(!this.filterInitialized&&this.filteredrows.length===0){this.filteredrows=this.collection.prepareFullDocIndex()}const wrappedComparer=((userComparer,data)=>(a,b)=>userComparer(data[a],data[b]))(comparefun,this.collection.data);this.filteredrows.sort(wrappedComparer);return this}simplesort(propname,isdesc){if(typeof isdesc==="undefined"){isdesc=false}if(!this.filterInitialized&&this.filteredrows.length===0){if(this.collection.binaryIndices[propname]!==undefined){this.collection.ensureIndex(propname);this.filteredrows=this.collection.binaryIndices[propname].values.slice(0);if(isdesc){this.filteredrows.reverse()}return this}else{this.filteredrows=this.collection.prepareFullDocIndex()}}const wrappedComparer=((prop,desc,data)=>(a,b)=>Object(__WEBPACK_IMPORTED_MODULE_3__helper__["d"])(data[a][prop],data[b][prop],desc))(propname,isdesc,this.collection.data);this.filteredrows.sort(wrappedComparer);return this}compoundsort(properties){if(properties.length===0){throw new Error("Invalid call to compoundsort, need at least one property")}let prop;if(properties.length===1){prop=properties[0];if(Array.isArray(prop)){return this.simplesort(prop[0],prop[1])}return this.simplesort(prop,false)}for(let i=0,len=properties.length;i<len;i+=1){prop=properties[i];if(!Array.isArray(prop)){properties[i]=[prop,false]}}if(!this.filterInitialized&&this.filteredrows.length===0){this.filteredrows=this.collection.prepareFullDocIndex()}const wrappedComparer=((props,data)=>(a,b)=>compoundeval(props,data[a],data[b]))(properties,this.collection.data);this.filteredrows.sort(wrappedComparer);return this}findOr(expressionArray){let fr=null;let fri=0;let frlen=0;const docset=[];const idxset=[];let idx=0;const origCount=this.count();for(let ei=0,elen=expressionArray.length;ei<elen;ei++){fr=this.branch().find(expressionArray[ei]).filteredrows;frlen=fr.length;if(frlen===origCount){return this}for(fri=0;fri<frlen;fri++){idx=fr[fri];if(idxset[idx]===undefined){idxset[idx]=true;docset.push(idx)}}}this.filteredrows=docset;this.filterInitialized=true;return this}$or(...args){return this.findOr(...args)}findAnd(expressionArray){for(let i=0,len=expressionArray.length;i<len;i++){if(this.count()===0){return this}this.find(expressionArray[i])}return this}$and(...args){return this.findAnd(...args)}find(query,firstOnly){if(this.collection.data.length===0){this.filteredrows=[];this.filterInitialized=true;return this}const queryObject=query||"getAll";let p;let property;let queryObjectOp;let obj;let operator;let value;let key;let searchByIndex=false;let result=[];let filters=[];let index=null;firstOnly=firstOnly||false;if(typeof queryObject==="object"){for(p in queryObject){obj={};obj[p]=queryObject[p];filters.push(obj);if(queryObject[p]!==undefined){property=p;queryObjectOp=queryObject[p]}}if(filters.length>1){return this.find({$and:filters},firstOnly)}}if(!property||queryObject==="getAll"){if(firstOnly){this.filteredrows=this.collection.data.length>0?[0]:[];this.filterInitialized=true}return this}if(property==="$and"||property==="$or"){this[property](queryObjectOp);if(firstOnly&&this.filteredrows.length>1){this.filteredrows=this.filteredrows.slice(0,1)}return this}if(queryObjectOp===null||(typeof queryObjectOp!=="object"||queryObjectOp instanceof Date)){operator="$eq";value=queryObjectOp}else if(typeof queryObjectOp==="object"){for(key in queryObjectOp){if(queryObjectOp[key]!==undefined){operator=key;value=queryObjectOp[key];break}}}else{throw new Error("Do not know what you want to do.")}if(operator==="$regex"){if(Array.isArray(value)){value=new RegExp(value[0],value[1])}else if(!(value instanceof RegExp)){value=new RegExp(value)}}if(query.query){let res=this.collection._fullTextSearch.search(query);let docIds=Object.keys(res);let results=[];for(let i=0;i<docIds.length;i++){let docId=parseInt(docIds[i]);for(let j=0;j<this.collection.data.length;j++){if(this.collection.data[j].$loki===docId){results.push(this.collection.data[j])}}}return results}const usingDotNotation=property.indexOf(".")!==-1;var doIndexCheck=!usingDotNotation&&!this.filterInitialized;if(doIndexCheck&&this.collection.binaryIndices[property]&&indexedOps[operator]){if(this.collection.adaptiveBinaryIndices!==true){this.collection.ensureIndex(property)}searchByIndex=true;index=this.collection.binaryIndices[property]}const fun=LokiOps[operator];const t=this.collection.data;let i=0;let len=0;let filter;let rowIdx=0;if(this.filterInitialized){filter=this.filteredrows;len=filter.length;if(usingDotNotation){property=property.split(".");for(i=0;i<len;i++){rowIdx=filter[i];if(dotSubScan(t[rowIdx],property,fun,value)){result.push(rowIdx)}}}else{for(i=0;i<len;i++){rowIdx=filter[i];if(fun(t[rowIdx][property],value)){result.push(rowIdx)}}}}else{if(!searchByIndex){len=t.length;if(usingDotNotation){property=property.split(".");for(i=0;i<len;i++){if(dotSubScan(t[i],property,fun,value)){result.push(i);if(firstOnly){this.filteredrows=result;this.filterInitialized=true;return this}}}}else{for(i=0;i<len;i++){if(fun(t[i][property],value)){result.push(i);if(firstOnly){this.filteredrows=result;this.filterInitialized=true;return this}}}}}else{const segm=this.collection.calculateRange(operator,property,value);if(operator!=="$in"){for(i=segm[0];i<=segm[1];i++){if(indexedOps[operator]!==true){if(indexedOps[operator](t[index.values[i]][property],value)){result.push(index.values[i]);if(firstOnly){this.filteredrows=result;this.filterInitialized=true;return this}}}else{result.push(index.values[i]);if(firstOnly){this.filteredrows=result;this.filterInitialized=true;return this}}}}else{for(i=0,len=segm.length;i<len;i++){result.push(index.values[segm[i]]);if(firstOnly){this.filteredrows=result;this.filterInitialized=true;return this}}}}}this.filteredrows=result;this.filterInitialized=true;return this}where(fun){let viewFunction;let result=[];if("function"===typeof fun){viewFunction=fun}else{throw new TypeError("Argument is not a stored view or a function")}try{if(this.filterInitialized){let j=this.filteredrows.length;while(j--){if(viewFunction(this.collection.data[this.filteredrows[j]])===true){result.push(this.filteredrows[j])}}this.filteredrows=result;return this}else{let k=this.collection.data.length;while(k--){if(viewFunction(this.collection.data[k])===true){result.push(k)}}this.filteredrows=result;this.filterInitialized=true;return this}}catch(err){throw err}}count(){if(this.filterInitialized){return this.filteredrows.length}return this.collection.count()}data({forceClones:forceClones,forceCloneMethod:forceCloneMethod=this.collection.cloneMethod,removeMeta:removeMeta=false}={}){let result=[];let data=this.collection.data;let obj;let len;let i;let method;if(removeMeta&&!forceClones){forceClones=true;forceCloneMethod="shallow"}if(!this.filterInitialized){if(this.filteredrows.length===0){if(this.collection.cloneObjects||forceClones){len=data.length;method=forceCloneMethod;for(i=0;i<len;i++){obj=Object(__WEBPACK_IMPORTED_MODULE_0__clone__["a"])(data[i],method);if(removeMeta){delete obj.$loki;delete obj.meta}result.push(obj)}return result}else{return data.slice()}}else{this.filterInitialized=true}}const fr=this.filteredrows;len=fr.length;if(this.collection.cloneObjects||forceClones){method=forceCloneMethod;for(i=0;i<len;i++){obj=Object(__WEBPACK_IMPORTED_MODULE_0__clone__["a"])(data[fr[i]],method);if(removeMeta){delete obj.$loki;delete obj.meta}result.push(obj)}}else{for(i=0;i<len;i++){result.push(data[fr[i]])}}return result}update(updateFunction){if(typeof updateFunction!=="function"){throw new TypeError("Argument is not a function")}if(!this.filterInitialized&&this.filteredrows.length===0){this.filteredrows=this.collection.prepareFullDocIndex()}const len=this.filteredrows.length;const rcd=this.collection.data;for(let idx=0;idx<len;idx++){updateFunction(rcd[this.filteredrows[idx]]);this.collection.update(rcd[this.filteredrows[idx]])}return this}remove(){if(!this.filterInitialized&&this.filteredrows.length===0){this.filteredrows=this.collection.prepareFullDocIndex()}this.collection.remove(this.data());this.filteredrows=[];return this}mapReduce(mapFunction,reduceFunction){try{return reduceFunction(this.data().map(mapFunction))}catch(err){throw err}}eqJoin(joinData,leftJoinKey,rightJoinKey,mapFun){let leftData=[];let leftDataLength;let rightData=[];let rightDataLength;let key;let result=[];let leftKeyisFunction=typeof leftJoinKey==="function";let rightKeyisFunction=typeof rightJoinKey==="function";let joinMap={};leftData=this.data();leftDataLength=leftData.length;if(joinData instanceof Resultset){rightData=joinData.data()}else if(Array.isArray(joinData)){rightData=joinData}else{throw new TypeError("joinData needs to be an array or result set")}rightDataLength=rightData.length;for(let i=0;i<rightDataLength;i++){key=rightKeyisFunction?rightJoinKey(rightData[i]):rightData[i][rightJoinKey];joinMap[key]=rightData[i]}if(!mapFun){mapFun=((left,right)=>({left:left,right:right}))}for(let j=0;j<leftDataLength;j++){key=leftKeyisFunction?leftJoinKey(leftData[j]):leftData[j][leftJoinKey];result.push(mapFun(leftData[j],joinMap[key]||{}))}this.collection=new __WEBPACK_IMPORTED_MODULE_1__collection__["a"]("joinData");this.collection.insert(result);this.filteredrows=[];this.filterInitialized=false;return this}map(mapFun){let data=this.data().map(mapFun);this.collection=new __WEBPACK_IMPORTED_MODULE_1__collection__["a"]("mappedData");this.collection.insert(data);this.filteredrows=[];this.filterInitialized=false;return this}}__webpack_exports__["a"]=Resultset},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_exports__["a"]=clone;function clone(data,method){if(data===null||data===undefined){return null}const cloneMethod=method||"parse-stringify";let cloned;switch(cloneMethod){case"parse-stringify":cloned=JSON.parse(JSON.stringify(data));break;case"jquery-extend-deep":cloned=jQuery.extend(true,{},data);break;case"shallow":cloned=data.prototype?Object.create(data.prototype):{};Object.keys(data).map(i=>{cloned[i]=data[i]});break;case"shallow-assign":cloned=data.prototype?Object.create(data.prototype):{};Object.assign(cloned,data);break;default:break}return cloned}function cloneObjectArray(objarray,method){let i;const result=[];if(method==="parse-stringify"){return clone(objarray,method)}i=objarray.length-1;for(;i<=0;i--){result.push(clone(objarray[i],method))}return result}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_exports__["a"]=copyProperties;__webpack_exports__["b"]=resolveTransformParams;function copyProperties(src,dest){let prop;for(prop in src){dest[prop]=src[prop]}}function resolveTransformObject(subObj,params,depth){let prop;let pname;if(typeof depth!=="number"){depth=0}if(++depth>=10)return subObj;for(prop in subObj){if(typeof subObj[prop]==="string"&&subObj[prop].indexOf("[%lktxp]")===0){pname=subObj[prop].substring(8);if(params[pname]!==undefined){subObj[prop]=params[pname]}}else if(typeof subObj[prop]==="object"){subObj[prop]=resolveTransformObject(subObj[prop],params,depth)}}return subObj}function resolveTransformParams(transform,params){let idx;let clonedStep;const resolvedTransform=[];if(typeof params==="undefined")return transform;for(idx=0;idx<transform.length;idx++){clonedStep=JSON.parse(JSON.stringify(transform[idx]));resolvedTransform.push(resolveTransformObject(clonedStep,params))}return resolvedTransform}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_exports__["a"]=aeqHelper;__webpack_exports__["c"]=ltHelper;__webpack_exports__["b"]=gtHelper;__webpack_exports__["d"]=sortHelper;function aeqHelper(prop1,prop2){let cv1;let cv2;let t1;let t2;if(prop1===prop2)return true;if(!prop1||!prop2||prop1===true||prop2===true||prop1!==prop1||prop2!==prop2){switch(prop1){case undefined:t1=1;break;case null:t1=1;break;case false:t1=3;break;case true:t1=4;break;case"":t1=5;break;default:t1=prop1===prop1?9:0;break}switch(prop2){case undefined:t2=1;break;case null:t2=1;break;case false:t2=3;break;case true:t2=4;break;case"":t2=5;break;default:t2=prop2===prop2?9:0;break}if(t1!==9||t2!==9){return t1===t2}}cv1=Number(prop1);cv2=Number(prop2);if(cv1===cv1||cv2===cv2){return cv1===cv2}cv1=prop1.toString();cv2=prop2.toString();return cv1==cv2}function ltHelper(prop1,prop2,equal){let cv1;let cv2;let t1;let t2;if(!prop1||!prop2||prop1===true||prop2===true||prop1!==prop1||prop2!==prop2){switch(prop1){case undefined:t1=1;break;case null:t1=1;break;case false:t1=3;break;case true:t1=4;break;case"":t1=5;break;default:t1=prop1===prop1?9:0;break}switch(prop2){case undefined:t2=1;break;case null:t2=1;break;case false:t2=3;break;case true:t2=4;break;case"":t2=5;break;default:t2=prop2===prop2?9:0;break}if(t1!==9||t2!==9){return t1===t2?equal:t1<t2}}cv1=Number(prop1);cv2=Number(prop2);if(cv1===cv1&&cv2===cv2){if(cv1<cv2)return true;if(cv1>cv2)return false;return equal}if(cv1===cv1&&cv2!==cv2){return true}if(cv2===cv2&&cv1!==cv1){return false}if(prop1<prop2)return true;if(prop1>prop2)return false;if(prop1==prop2)return equal;cv1=prop1.toString();cv2=prop2.toString();if(cv1<cv2){return true}if(cv1==cv2){return equal}return false}function gtHelper(prop1,prop2,equal){let cv1;let cv2;let t1;let t2;if(!prop1||!prop2||prop1===true||prop2===true||prop1!==prop1||prop2!==prop2){switch(prop1){case undefined:t1=1;break;case null:t1=1;break;case false:t1=3;break;case true:t1=4;break;case"":t1=5;break;default:t1=prop1===prop1?9:0;break}switch(prop2){case undefined:t2=1;break;case null:t2=1;break;case false:t2=3;break;case true:t2=4;break;case"":t2=5;break;default:t2=prop2===prop2?9:0;break}if(t1!==9||t2!==9){return t1===t2?equal:t1>t2}}cv1=Number(prop1);cv2=Number(prop2);if(cv1===cv1&&cv2===cv2){if(cv1>cv2)return true;if(cv1<cv2)return false;return equal}if(cv1===cv1&&cv2!==cv2){return false}if(cv2===cv2&&cv1!==cv1){return true}if(prop1>prop2)return true;if(prop1<prop2)return false;if(prop1==prop2)return equal;cv1=prop1.toString();cv2=prop2.toString();if(cv1>cv2){return true}if(cv1==cv2){return equal}return false}function sortHelper(prop1,prop2,desc){if(aeqHelper(prop1,prop2))return 0;if(ltHelper(prop1,prop2,false)){return desc?1:-1}if(gtHelper(prop1,prop2,false)){return desc?-1:1}return 0}},function(module,exports){var g;g=function(){return this}();try{g=g||Function("return this")()||(1,eval)("this")}catch(e){if(typeof window==="object")g=window}module.exports=g},function(module,__webpack_exports__,__webpack_require__){"use strict";class UniqueIndex{constructor(uniqueField){this.field=uniqueField;this.keyMap={};this.lokiMap={}}set(obj){const fieldValue=obj[this.field];if(fieldValue!==null&&typeof fieldValue!=="undefined"){if(this.keyMap[fieldValue]){throw new Error("Duplicate key for property "+this.field+": "+fieldValue)}else{this.keyMap[fieldValue]=obj;this.lokiMap[obj.$loki]=fieldValue}}}get(key){return this.keyMap[key]}byId(id){return this.keyMap[this.lokiMap[id]]}update(obj,doc){if(this.lokiMap[obj.$loki]!==doc[this.field]){const old=this.lokiMap[obj.$loki];this.set(doc);this.keyMap[old]=undefined}else{this.keyMap[obj[this.field]]=doc}}remove(key){const obj=this.keyMap[key];if(obj!==null&&typeof obj!=="undefined"){this.keyMap[key]=undefined;this.lokiMap[obj.$loki]=undefined}else{throw new Error("Key is not in unique index: "+this.field)}}clear(){this.keyMap={};this.lokiMap={}}}__webpack_exports__["a"]=UniqueIndex},function(module,__webpack_exports__,__webpack_require__){"use strict";class ExactIndex{constructor(exactField){this.index={};this.field=exactField}set(key,val){if(this.index[key]){this.index[key].push(val)}else{this.index[key]=[val]}}remove(key,val){const idxSet=this.index[key];for(const i in idxSet){if(idxSet[i]===val){idxSet.splice(i,1)}}if(idxSet.length<1){this.index[key]=undefined}}get(key){return this.index[key]}clear(){this.index={}}}__webpack_exports__["a"]=ExactIndex},function(module,__webpack_exports__,__webpack_require__){"use strict";var __WEBPACK_IMPORTED_MODULE_0__event_emitter__=__webpack_require__(0);var __WEBPACK_IMPORTED_MODULE_1__resultset__=__webpack_require__(3);class DynamicView extends __WEBPACK_IMPORTED_MODULE_0__event_emitter__["a"]{constructor(collection,name,{persistent:persistent=false,sortPriority:sortPriority="passive",minRebuildInterval:minRebuildInterval=1}={}){super();this._collection=collection;this.name=name;this._rebuildPending=false;this._persistent=persistent;this._sortPriority=sortPriority;this._minRebuildInterval=minRebuildInterval;this._resultset=new __WEBPACK_IMPORTED_MODULE_1__resultset__["a"](collection);this._resultsdata=[];this._resultsdirty=false;this.cachedresultset=null;this._filterPipeline=[];this._sortFunction=null;this._sortCriteria=null;this._sortDirty=false;this.events={rebuild:[]}}rematerialize({removeWhereFilters:removeWhereFilters=undefined}){let fpl;let fpi;let idx;this._resultdata=[];this._resultsdirty=true;this._resultset=new __WEBPACK_IMPORTED_MODULE_1__resultset__["a"](this._collection);if(this._sortFunction||this._sortCriteria){this._sortDirty=true}if(removeWhereFilters!==undefined){fpl=this._filterPipeline.length;fpi=fpl;while(fpi--){if(this._filterPipeline[fpi].type==="where"){if(fpi!==this._filterPipeline.length-1){this._filterPipeline[fpi]=this._filterPipeline[this._filterPipeline.length-1]}this._filterPipeline.length--}}}const ofp=this._filterPipeline;this._filterPipeline=[];fpl=ofp.length;for(idx=0;idx<fpl;idx++){this.applyFind(ofp[idx].val)}this.data();this.emit("rebuild",this);return this}branchResultset(transform,parameters){const rs=this._resultset.branch();if(typeof transform==="undefined"){return rs}return rs.transform(transform,parameters)}toJSON(){return{name:this.name,_persistent:this._persistent,_sortPriority:this._sortPriority,_minRebuildInterval:this._minRebuildInterval,_resultset:this._resultset,_resultsdirty:true,_filterPipeline:this._filterPipeline,_sortCriteria:this._sortCriteria,_sortDirty:this._sortDirty}}static fromJSONObject(collection,obj){let dv=new DynamicView(collection,obj.name,obj.options);dv._resultsdirty=obj._resultsdirty;dv._filterPipeline=obj._filterPipeline;dv.resultdata=[];dv._sortCriteria=obj._sortCriteria;dv._sortDirty=obj._sortDirty;dv._resultset.filteredrows=obj._resultset.filteredrows;dv._resultset.filterInitialized=obj._resultset.filterInitialized;dv.rematerialize({removeWhereFilters:true});return dv}removeFilters({queueSortPhase:queueSortPhase=false}={}){this._rebuildPending=false;this._resultset.reset();this._resultdata=[];this._resultsdirty=true;this.cachedresultset=null;this._filterPipeline=[];this._sortFunction=null;this._sortCriteria=null;this._sortDirty=false;if(queueSortPhase===true){this.queueSortPhase()}}applySort(comparefun){this._sortFunction=comparefun;this._sortCriteria=null;this.queueSortPhase();return this}applySimpleSort(propname,isdesc){this._sortCriteria=[[propname,isdesc||false]];this._sortFunction=null;this.queueSortPhase();return this}applySortCriteria(criteria){this._sortCriteria=criteria;this._sortFunction=null;this.queueSortPhase();return this}startTransaction(){this.cachedresultset=this._resultset.copy();return this}commit(){this.cachedresultset=null;return this}rollback(){this._resultset=this.cachedresultset;if(this._persistent){this._resultdata=this._resultset.data();this.emit("rebuild",this)}return this}_indexOfFilterWithId(uid){if(typeof uid==="string"||typeof uid==="number"){for(let idx=0,len=this._filterPipeline.length;idx<len;idx+=1){if(uid===this._filterPipeline[idx].uid){return idx}}}return-1}_addFilter(filter){this._filterPipeline.push(filter);this._resultset[filter.type](filter.val)}reapplyFilters(){this._resultset.reset();this.cachedresultset=null;if(this._persistent){this._resultdata=[];this._resultsdirty=true}const filters=this._filterPipeline;this._filterPipeline=[];for(let idx=0,len=filters.length;idx<len;idx+=1){this._addFilter(filters[idx])}if(this._sortFunction||this._sortCriteria){this.queueSortPhase()}else{this.queueRebuildEvent()}return this}applyFilter(filter){const idx=this._indexOfFilterWithId(filter.uid);if(idx>=0){this._filterPipeline[idx]=filter;return this.reapplyFilters()}this.cachedresultset=null;if(this._persistent){this._resultdata=[];this._resultsdirty=true}this._addFilter(filter);if(this._sortFunction||this._sortCriteria){this.queueSortPhase()}else{this.queueRebuildEvent()}return this}applyFind(query,uid){this.applyFilter({type:"find",val:query,uid:uid});return this}applyWhere(fun,uid){this.applyFilter({type:"where",val:fun,uid:uid});return this}removeFilter(uid){const idx=this._indexOfFilterWithId(uid);if(idx<0){throw new Error("Dynamic view does not contain a filter with ID: "+uid)}this._filterPipeline.splice(idx,1);this.reapplyFilters();return this}count(){if(this._resultsdirty){this._resultdata=this._resultset.data()}return this._resultset.count()}data(){if(this._sortDirty||this._resultsdirty){this.performSortPhase({suppressRebuildEvent:true})}return this._persistent?this._resultdata:this._resultset.data()}queueRebuildEvent(){if(this._rebuildPending){return}this._rebuildPending=true;setTimeout(()=>{if(this._rebuildPending){this._rebuildPending=false;this.emit("rebuild",this)}},this._minRebuildInterval)}queueSortPhase(){if(this._sortDirty){return}this._sortDirty=true;if(this._sortPriority==="active"){setTimeout(()=>{this.performSortPhase()},this._minRebuildInterval)}else{this.queueRebuildEvent()}}performSortPhase(options){if(!this._sortDirty&&!this._resultsdirty){return}options=options||{};if(this._sortDirty){if(this._sortFunction){this._resultset.sort(this._sortFunction)}else if(this._sortCriteria){this._resultset.compoundsort(this._sortCriteria)}this._sortDirty=false}if(this._persistent){this._resultdata=this._resultset.data();this._resultsdirty=false}if(!options.suppressRebuildEvent){this.emit("rebuild",this)}}evaluateDocument(objIndex,isNew){if(!this._resultset.filterInitialized){if(this._persistent){this._resultdata=this._resultset.data()}if(this._sortFunction||this._sortCriteria){this.queueSortPhase()}else{this.queueRebuildEvent()}return}const ofr=this._resultset.filteredrows;const oldPos=isNew?-1:ofr.indexOf(+objIndex);const oldlen=ofr.length;const evalResultset=new __WEBPACK_IMPORTED_MODULE_1__resultset__["a"](this._collection);evalResultset.filteredrows=[objIndex];evalResultset.filterInitialized=true;let filter;for(let idx=0,len=this._filterPipeline.length;idx<len;idx++){filter=this._filterPipeline[idx];evalResultset[filter.type](filter.val)}const newPos=evalResultset.filteredrows.length===0?-1:0;if(oldPos===-1&&newPos===-1)return;if(oldPos===-1&&newPos!==-1){ofr.push(objIndex);if(this._persistent){this._resultdata.push(this._collection.data[objIndex])}if(this._sortFunction||this._sortCriteria){this.queueSortPhase()}else{this.queueRebuildEvent()}return}if(oldPos!==-1&&newPos===-1){if(oldPos<oldlen-1){ofr.splice(oldPos,1);if(this._persistent){this._resultdata.splice(oldPos,1)}}else{ofr.length=oldlen-1;if(this._persistent){this._resultdata.length=oldlen-1}}if(this._sortFunction||this._sortCriteria){this.queueSortPhase()}else{this.queueRebuildEvent()}return}if(oldPos!==-1&&newPos!==-1){if(this._persistent){this._resultdata[oldPos]=this._collection.data[objIndex]}if(this._sortFunction||this._sortCriteria){this.queueSortPhase()}else{this.queueRebuildEvent()}}}removeDocument(objIndex){if(!this._resultset.filterInitialized){if(this._persistent){this._resultdata=this._resultset.data()}if(this._sortFunction||this._sortCriteria){this.queueSortPhase()}else{this.queueRebuildEvent()}return}const ofr=this._resultset.filteredrows;const oldPos=ofr.indexOf(+objIndex);let oldlen=ofr.length;let idx;if(oldPos!==-1){if(oldPos<oldlen-1){ofr[oldPos]=ofr[oldlen-1];ofr.length=oldlen-1;if(this._persistent){this._resultdata[oldPos]=this._resultdata[oldlen-1];this._resultdata.length=oldlen-1}}else{ofr.length=oldlen-1;if(this._persistent){this._resultdata.length=oldlen-1}}if(this._sortFunction||this._sortCriteria){this.queueSortPhase()}else{this.queueRebuildEvent()}}oldlen=ofr.length;for(idx=0;idx<oldlen;idx++){if(ofr[idx]>objIndex){ofr[idx]--}}}mapReduce(mapFunction,reduceFunction){try{return reduceFunction(this.data().map(mapFunction))}catch(err){throw err}}}__webpack_exports__["a"]=DynamicView}])});