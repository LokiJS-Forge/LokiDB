(function webpackUniversalModuleDefinition(root,factory){if(typeof exports==="object"&&typeof module==="object")module.exports=factory();else if(typeof define==="function"&&define.amd)define([],factory);else if(typeof exports==="object")exports["@lokijs/full-text-search"]=factory();else{root["@lokijs/full-text-search"]=factory();root["LokiFullTextSearch"]=root["@lokijs/full-text-search"].default}})(this,function(){return function(modules){var installedModules={};function __webpack_require__(moduleId){if(installedModules[moduleId]){return installedModules[moduleId].exports}var module=installedModules[moduleId]={i:moduleId,l:false,exports:{}};modules[moduleId].call(module.exports,module,module.exports,__webpack_require__);module.l=true;return module.exports}__webpack_require__.m=modules;__webpack_require__.c=installedModules;__webpack_require__.d=function(exports,name,getter){if(!__webpack_require__.o(exports,name)){Object.defineProperty(exports,name,{configurable:false,enumerable:true,get:getter})}};__webpack_require__.n=function(module){var getter=module&&module.__esModule?function getDefault(){return module["default"]}:function getModuleExports(){return module};__webpack_require__.d(getter,"a",getter);return getter};__webpack_require__.o=function(object,property){return Object.prototype.hasOwnProperty.call(object,property)};__webpack_require__.p="";return __webpack_require__(__webpack_require__.s=3)}([function(module,__webpack_exports__,__webpack_require__){"use strict";var __WEBPACK_IMPORTED_MODULE_0__tokenizer__=__webpack_require__(1);class InvertedIndex{constructor(options={}){this._docCount=0;this._docStore={};this._totalFieldLength=0;this._root={};({store:this._store=true,optimizeChanges:this._optimizeChanges=true,tokenizer:this._tokenizer=new __WEBPACK_IMPORTED_MODULE_0__tokenizer__["a"]}=options)}get store(){return this._store}get tokenizer(){return this._tokenizer}get documentCount(){return this._docCount}get documentStore(){return this._docStore}get totalFieldLength(){return this._totalFieldLength}get root(){return this._root}insert(field,docId){if(this._docStore[docId]!==undefined){throw Error("Field already added.")}this._docCount+=1;this._docStore[docId]={};const fieldTokens=this._tokenizer.tokenize(field);this._totalFieldLength+=fieldTokens.length;const termRefs=[];this._docStore[docId]={fieldLength:fieldTokens.length};if(this._optimizeChanges){Object.defineProperties(this._docStore[docId],{termRefs:{enumerable:false,configurable:true,writable:true,value:termRefs}})}for(const term of new Set(fieldTokens)){if(term===""){continue}let tf=0;for(let j=0;j<fieldTokens.length;j++){if(fieldTokens[j]===term){++tf}}let branch=this._root;for(let i=0;i<term.length;i++){const c=term[i];if(branch[c]===undefined){const child={};if(this._optimizeChanges){Object.defineProperties(child,{pa:{enumerable:false,configurable:true,writable:true,value:branch}})}branch[c]=child}branch=branch[c]}if(branch.dc===undefined){branch.dc={};branch.df=0}branch.dc[docId]=tf;branch.df+=1;termRefs.push(branch)}}remove(docId){if(this._docStore[docId]===undefined){return}const docStore=this._docStore[docId];delete this._docStore[docId];this._docCount-=1;this._totalFieldLength-=docStore.fieldLength;if(this._optimizeChanges){const termRefs=docStore.termRefs;for(let j=0;j<termRefs.length;j++){let index=termRefs[j];index.df-=1;delete index.dc[docId];if(index.df===0){delete index.df;delete index.dc;if(Object.keys(index).length!==0){continue}let keys=[];do{const parent=index.pa;delete index.pa;keys=Object.keys(parent);for(let k=0;k<keys.length;k++){const key=keys[k];if(key.length!==1){continue}if(parent[key]===index){delete parent[key];break}}index=parent}while(index.pa!==undefined&&keys.length===1)}}}else{const recursive=root=>{const keys=Object.keys(root);for(let i=0;i<keys.length;i++){const key=keys[i];if(key.length===1){if(recursive(root[key])){delete root[key]}}}if(root.df!==undefined){if(root.dc[docId]!==undefined){root.df-=1;delete root.dc[docId];if(root.df===0){delete root.df;delete root.dc}}}return Object.keys(root).length===0};recursive(this._root)}}static getTermIndex(term,root,start=0){if(start>=term.length){return null}for(let i=start;i<term.length;i++){if(root[term[i]]===undefined){return null}root=root[term[i]]}return root}static getNextTermIndex(root){const termIndices=[];const keys=Object.keys(root);for(let i=0;i<keys.length;i++){if(keys[i].length===1){termIndices.push({index:root[keys[i]],term:keys[i]})}}return termIndices}static extendTermIndex(root){const termIndices=[];const stack=[root];const treeStack=[""];do{const root=stack.pop();const treeTerm=treeStack.pop();if(root.df!==undefined){termIndices.push({index:root,term:treeTerm})}const keys=Object.keys(root);for(let i=0;i<keys.length;i++){if(keys[i].length===1){stack.push(root[keys[i]]);treeStack.push(treeTerm+keys[i])}}}while(stack.length!==0);return termIndices}toJSON(){if(this._store){return this}return{_store:false,_optimizeChanges:this._optimizeChanges,_tokenizer:this._tokenizer}}static fromJSONObject(serialized,funcTok=undefined){const invIdx=new InvertedIndex({store:serialized._store,optimizeChanges:serialized._optimizeChanges,tokenizer:__WEBPACK_IMPORTED_MODULE_0__tokenizer__["a"].fromJSONObject(serialized._tokenizer,funcTok)});if(invIdx._store){invIdx._docCount=serialized._docCount;invIdx._docStore=serialized._docStore;invIdx._totalFieldLength=serialized._totalFieldLength;invIdx._root=serialized._root}const regenerate=(index,parent)=>{if(parent!==null){Object.defineProperties(index,{pa:{enumerable:false,configurable:true,writable:false,value:parent}})}const keys=Object.keys(index);for(let i=0;i<keys.length;i++){if(keys[i]==="dc"){const docIds=Object.keys(index.dc);for(let j=0;j<docIds.length;j++){const ref=invIdx._docStore[docIds[j]];if(ref.termRefs===undefined){Object.defineProperties(ref,{termRefs:{enumerable:false,configurable:true,writable:true,value:[]}})}ref.termRefs.push(index)}}else if(keys[i].length===1){regenerate(index[keys[i]],index)}}};if(invIdx._optimizeChanges){regenerate(invIdx._root,null)}return invIdx}}__webpack_exports__["a"]=InvertedIndex},function(module,__webpack_exports__,__webpack_require__){"use strict";function defaultSplitter(str){let tokens=str.split(/[^\w]+/);for(let i=0;i<tokens.length;i++){tokens[i]=tokens[i].toLowerCase()}return tokens}class Tokenizer{constructor(){this._queue=[];this._symbol=Symbol("label");this.reset()}setSplitter(label,func){if(label===""){throw Error("Label cannot be empty.")}func[this._symbol]=label;this._splitter=func}getSplitter(){return[this._splitter[this._symbol],this._splitter]}resetSplitter(){this._splitter=defaultSplitter}has(labelFunc){return this._getPosition(labelFunc)!==-1}get(labelFunc){let pos=this._getPosition(labelFunc);if(pos===-1){throw Error("Cannot find existing function.")}return[this._queue[pos][this._symbol],this._queue[pos]]}add(label,func){this._addFunction(label,func,this._queue.length)}addBefore(labelFunc,label,func){let pos=this._getPosition(labelFunc);if(pos===-1){throw Error("Cannot find existing function.")}this._addFunction(label,func,pos)}addAfter(labelFunc,label,func){let pos=this._getPosition(labelFunc);if(pos===-1){throw Error("Cannot find existing function.")}this._addFunction(label,func,pos+1)}remove(labelFunc){let pos=this._getPosition(labelFunc);if(pos===-1){throw Error("Cannot find existing function.")}this._queue.splice(pos,1)}reset(){this._splitter=defaultSplitter;this._queue=[]}tokenize(str){let tokens=this._splitter(str);for(let i=0;i<this._queue.length;i++){let newTokens=[];for(let j=0;j<tokens.length;j++){let token=this._queue[i](tokens[j]);if(token){newTokens.push(token)}}tokens=newTokens}return tokens}toJSON(){let serialized={tokenizers:[]};if(this._splitter!==defaultSplitter){serialized.splitter=this._splitter[this._symbol]}for(let i=0;i<this._queue.length;i++){serialized.tokenizers.push(this._queue[i][this._symbol])}return serialized}static fromJSONObject(serialized,funcTok=undefined){let tkz=new Tokenizer;if(funcTok!==undefined&&funcTok instanceof Tokenizer){if(serialized.splitter!==undefined){let splitter=funcTok.getSplitter();if(serialized.splitter!==splitter[0]){throw Error("Splitter function not found.")}tkz.setSplitter(splitter[0],splitter[1])}for(let i=0;i<serialized.tokenizers.length;i++){if(!funcTok.has(serialized.tokenizers[i])){throw Error("Tokenizer function not found.")}let labelFunc=funcTok.get(serialized.tokenizers[i]);tkz.add(labelFunc[0],labelFunc[1])}}else{if(serialized.splitter!==undefined){if(funcTok.splitters[serialized.splitter]===undefined){throw Error("Splitter function not found.")}tkz.setSplitter(serialized.splitter,funcTok.splitters[serialized.splitter])}for(let i=0;i<serialized.tokenizers.length;i++){if(funcTok.tokenizers[serialized.tokenizers[i]]===undefined){throw Error("Tokenizer function not found.")}tkz.add(serialized.tokenizers[i],funcTok.tokenizers[serialized.tokenizers[i]])}}return tkz}_getPosition(labelFunc){if(labelFunc instanceof Function){return this._queue.indexOf(labelFunc)}else{for(let i=0;i<this._queue.length;i++){if(this._queue[i][this._symbol]===labelFunc){return i}}}return-1}_addFunction(label,func,pos){if(label===""){throw Error("Label cannot be empty.")}func[this._symbol]=label;this._queue.splice(pos,0,func)}}__webpack_exports__["a"]=Tokenizer},function(module,__webpack_exports__,__webpack_require__){"use strict";class BaseQuery{constructor(type,data={}){this._data=data;this._data.type=type}boost(value){if(value<0){throw TypeError("Boost must be a positive number.")}this._data.boost=value;return this}build(){return this._data}}class TermQuery extends BaseQuery{constructor(field,term,data={}){super("term",data);this._data.field=field;this._data.value=term}}class TermsQuery extends BaseQuery{constructor(field,terms,data={}){super("terms",data);this._data.field=field;this._data.value=terms}}class WildcardQuery extends BaseQuery{constructor(field,wildcard,data={}){super("wildcard",data);this._data.field=field;this._data.value=wildcard}enableScoring(enable){this._data.enable_scoring=enable;return this}}class FuzzyQuery extends BaseQuery{constructor(field,fuzzy,data={}){super("fuzzy",data);this._data.field=field;this._data.value=fuzzy}fuzziness(fuzziness){if(fuzziness!=="AUTO"&&fuzziness<0){throw TypeError("Fuzziness must be a positive number or AUTO.")}this._data.fuzziness=fuzziness;return this}prefixLength(prefixLength){if(prefixLength<0){throw TypeError("Prefix length must be a positive number.")}this._data.prefix_length=prefixLength;return this}}class PrefixQuery extends BaseQuery{constructor(field,prefix,data={}){super("prefix",data);this._data.field=field;this._data.value=prefix}enableScoring(enable){this._data.enable_scoring=enable;return this}}class ExistsQuery extends BaseQuery{constructor(field,data={}){super("exists",data);this._data.field=field}}class MatchQuery extends BaseQuery{constructor(field,query,data={}){super("match",data);this._data.field=field;this._data.value=query}minimumShouldMatch(minShouldMatch){if(this._data.operator!==undefined&&this._data.operator==="and"){throw SyntaxError('Match query with "and" operator does not support minimum should match.')}this._data.minimum_should_match=minShouldMatch;return this}operator(op){if(op!=="and"&&op!=="or"){throw SyntaxError("Unknown operator.")}this._data.operator=op;if(this._data.minimum_should_match!==undefined&&this._data.operator==="and"){throw SyntaxError('Match query with "and" operator does not support minimum should match.')}return this}fuzziness(fuzziness){if(fuzziness!=="AUTO"&&fuzziness<0){throw TypeError("Fuzziness must be a positive number or AUTO.")}this._data.fuzziness=fuzziness;return this}prefixLength(prefixLength){if(prefixLength<0){throw TypeError("Prefix length must be a positive number.")}this._data.prefix_length=prefixLength;return this}}class MatchAllQuery extends BaseQuery{constructor(data={}){super("match_all",data)}}class ArrayQuery extends BaseQuery{constructor(callbackName,callback,data={}){super("array",data);this._data.values=[];this._callbackName=callbackName;this[callbackName]=callback;this._prepare=((queryType,...args)=>{const data={};const query=new queryType(...args,data);this._data.values.push(data);query.bool=this.bool;query.constantScore=this.constantScore;query.term=this.term;query.terms=this.terms;query.wildcard=this.wildcard;query.fuzzy=this.fuzzy;query.match=this.match;query.matchAll=this.matchAll;query.prefix=this.prefix;query.exists=this.exists;query._prepare=this._prepare;query[this._callbackName]=this[this._callbackName];return query})}bool(){return this._prepare(BoolQuery)}constantScore(){return this._prepare(ConstantScoreQuery)}term(field,term){return this._prepare(TermQuery,field,term)}terms(field,terms){return this._prepare(TermsQuery,field,terms)}wildcard(field,wildcard){return this._prepare(WildcardQuery,field,wildcard)}fuzzy(field,fuzzy){return this._prepare(FuzzyQuery,field,fuzzy)}match(field,query){return this._prepare(MatchQuery,field,query)}matchAll(){return this._prepare(MatchAllQuery)}prefix(field,prefix){return this._prepare(PrefixQuery,field,prefix)}exists(field){return this._prepare(ExistsQuery,field)}}class ConstantScoreQuery extends BaseQuery{constructor(data={}){super("constant_score",data)}beginFilter(){this._data.filter={};return new ArrayQuery("endFilter",()=>{return this},this._data.filter)}}class BoolQuery extends BaseQuery{constructor(data={}){super("bool",data)}beginMust(){this._data.must={};return new ArrayQuery("endMust",()=>{return this},this._data.must)}beginFilter(){this._data.filter={};return new ArrayQuery("endFilter",()=>{return this},this._data.filter)}beginShould(){this._data.should={};return new ArrayQuery("endShould",()=>{return this},this._data.should)}beginNot(){this._data.not={};return new ArrayQuery("endNot",()=>{return this},this._data.not)}minimumShouldMatch(minShouldMatch){this._data.minimum_should_match=minShouldMatch;return this}}class QueryBuilder{constructor(){this._data={query:{}};this.useBM25()}enableFinalScoring(enable){this._data.final_scoring=enable;return this}useBM25(k1=1.2,b=.75){if(k1<0){throw TypeError("BM25s k1 must be a positive number.")}if(b<0||b>1){throw TypeError("BM25s b must be a number between 0 and 1 inclusive.")}this._data.scoring={type:"BM25",k1:k1,b:b};return this}bool(){return this._prepare(BoolQuery)}constantScore(){return this._prepare(ConstantScoreQuery)}term(field,term){return this._prepare(TermQuery,field,term)}terms(field,terms){return this._prepare(TermsQuery,field,terms)}wildcard(field,wildcard){return this._prepare(WildcardQuery,field,wildcard)}fuzzy(field,fuzzy){return this._prepare(FuzzyQuery,field,fuzzy)}match(field,query){return this._prepare(MatchQuery,field,query)}matchAll(){return this._prepare(MatchAllQuery)}prefix(field,prefix){return this._prepare(PrefixQuery,field,prefix)}exists(field){return this._prepare(ExistsQuery,field)}_prepare(queryType,...args){this._child=new queryType(...args,this._data.query);this._child.build=(()=>{return this._data});return this._child}}__webpack_exports__["a"]=QueryBuilder},function(module,__webpack_exports__,__webpack_require__){"use strict";Object.defineProperty(__webpack_exports__,"__esModule",{value:true});var __WEBPACK_IMPORTED_MODULE_0__full_text_search__=__webpack_require__(4);var __WEBPACK_IMPORTED_MODULE_1__tokenizer__=__webpack_require__(1);__webpack_require__.d(__webpack_exports__,"Tokenizer",function(){return __WEBPACK_IMPORTED_MODULE_1__tokenizer__["a"]});var __WEBPACK_IMPORTED_MODULE_2__query_builder__=__webpack_require__(2);__webpack_require__.d(__webpack_exports__,"QueryBuilder",function(){return __WEBPACK_IMPORTED_MODULE_2__query_builder__["a"]});var __WEBPACK_IMPORTED_MODULE_3__inverted_index__=__webpack_require__(0);__webpack_require__.d(__webpack_exports__,"InvertedIndex",function(){return __WEBPACK_IMPORTED_MODULE_3__inverted_index__["a"]});__webpack_require__.d(__webpack_exports__,"FullTextSearch",function(){return __WEBPACK_IMPORTED_MODULE_0__full_text_search__["a"]});__webpack_exports__["default"]=__WEBPACK_IMPORTED_MODULE_0__full_text_search__["a"]},function(module,__webpack_exports__,__webpack_require__){"use strict";var __WEBPACK_IMPORTED_MODULE_0__inverted_index__=__webpack_require__(0);var __WEBPACK_IMPORTED_MODULE_1__index_searcher__=__webpack_require__(5);class FullTextSearch{constructor(fields=[],id="$loki"){this._invIdxs={};for(let i=0;i<fields.length;i++){let field=fields[i];this._invIdxs[field.name]=new __WEBPACK_IMPORTED_MODULE_0__inverted_index__["a"](field)}this._id=id;this._docs=new Set;this._idxSearcher=new __WEBPACK_IMPORTED_MODULE_1__index_searcher__["a"](this._invIdxs,this._docs)}addDocument(doc){if(doc[this._id]===undefined){throw new Error("Document is not stored in the collection.")}let fieldNames=Object.keys(doc);for(let i=0,fieldName;i<fieldNames.length,fieldName=fieldNames[i];i++){if(this._invIdxs[fieldName]!==undefined){this._invIdxs[fieldName].insert(doc[fieldName],doc[this._id])}}this._docs.add(doc[this._id]);this.setDirty()}removeDocument(doc){if(doc[this._id]===undefined){throw new Error("Document is not stored in the collection.")}let fieldNames=Object.keys(this._invIdxs);for(let i=0;i<fieldNames.length;i++){this._invIdxs[fieldNames[i]].remove(doc[this._id])}this._docs.delete(doc[this._id]);this.setDirty()}updateDocument(doc){this.removeDocument(doc);this.addDocument(doc)}search(query){return this._idxSearcher.search(query)}toJSON(){let serialized={};let fieldNames=Object.keys(this._invIdxs);for(let i=0,fieldName;i<fieldNames.length,fieldName=fieldNames[i];i++){serialized[fieldName]=this._invIdxs[fieldName].toJSON()}return serialized}static fromJSONObject(serialized,tokenizers){let db=JSON.parse(serialized);let fts=new FullTextSearch;let fieldNames=Object.keys(db);for(let i=0,fieldName;i<fieldNames.length,fieldName=fieldNames[i];i++){fts._invIdxs[fieldName]=__WEBPACK_IMPORTED_MODULE_0__inverted_index__["a"].fromJSONObject(db[fieldName],tokenizers[fieldName])}return fts}setDirty(){this._idxSearcher.setDirty()}}__webpack_exports__["a"]=FullTextSearch;var _unused_webpack_default_export=FullTextSearch},function(module,__webpack_exports__,__webpack_require__){"use strict";var __WEBPACK_IMPORTED_MODULE_0__scorer__=__webpack_require__(6);var __WEBPACK_IMPORTED_MODULE_1__inverted_index__=__webpack_require__(0);var __WEBPACK_IMPORTED_MODULE_2__query_builder__=__webpack_require__(2);class IndexSearcher{constructor(invIdxs,docs){this._invIdxs=invIdxs;this._docs=docs;this._scorer=new __WEBPACK_IMPORTED_MODULE_0__scorer__["a"](this._invIdxs)}search(query){let docResults=this._recursive(query.query,true);let finalScoring=query.final_scoring!==undefined?query.final_scoring:true;if(finalScoring){return this._scorer.finalScore(query,docResults)}return docResults}setDirty(){this._scorer.setDirty()}_recursive(query,doScoring){let docResults={};let boost=query.boost!==undefined?query.boost:1;let fieldName=query.field!==undefined?query.field:null;let enableScoring=query.enable_scoring!==undefined?query.enable_scoring:false;let root=null;let tokenizer=null;if(this._invIdxs[fieldName]!==undefined){root=this._invIdxs[fieldName].root;tokenizer=this._invIdxs[fieldName].tokenizer}switch(query.type){case"bool":{docResults=null;if(query.must!==undefined){docResults=this._getUnique(query.must.values,doScoring,docResults)}if(query.filter!==undefined){docResults=this._getUnique(query.filter.values,false,docResults)}if(query.should!==undefined){let shouldDocs=this._getAll(query.should.values,doScoring);let empty=false;if(docResults===null){docResults={};empty=true}let msm=1;if(query.minimum_should_match!==undefined){msm=query.minimum_should_match;let shouldLength=query.should.values.length;if(msm<=-1){msm=shouldLength+msm}else if(msm<0){msm=shouldLength-Math.floor(shouldLength*-msm)}else if(msm<1){msm=Math.floor(shouldLength*msm)}}let docs=Object.keys(shouldDocs);for(let i=0,docId;i<docs.length,docId=docs[i];i++){if(shouldDocs[docId].length>=msm){if(docResults[docId]!==undefined){docResults[docId].push(...shouldDocs[docId])}else if(empty){docResults[docId]=shouldDocs[docId]}else{delete docResults[docId]}}}}if(query.not!==undefined){let notDocs=this._getAll(query.not.values,false);let docs=Object.keys(notDocs);for(let i=0,docId;i<docs.length,docId=docs[i];i++){if(docResults[docId]!==undefined){delete docResults[docId]}}}break}case"term":{let termIdx=__WEBPACK_IMPORTED_MODULE_1__inverted_index__["a"].getTermIndex(query.value,root);this._scorer.prepare(fieldName,boost,termIdx,doScoring,docResults,query.value);break}case"terms":{for(let i=0;i<query.value.length;i++){let termIdx=__WEBPACK_IMPORTED_MODULE_1__inverted_index__["a"].getTermIndex(query.value[i],root);this._scorer.prepare(fieldName,boost,termIdx,doScoring,docResults,query.value[i])}break}case"fuzzy":{let f=new FuzzySearch(query);let b=f.search(root);for(let i=0;i<b.length;i++){this._scorer.prepare(fieldName,boost*b[i].boost,b[i].index,doScoring,docResults,b[i].term)}break}case"wildcard":{let w=new WildcardSearch(query);let a=w.search(root);for(let i=0;i<a.length;i++){this._scorer.prepare(fieldName,boost,a[i].index,doScoring&&enableScoring,docResults,a[i].term)}break}case"match_all":{for(let docId of this._docs){this._scorer.scoreConstant(boost,docId,docResults)}break}case"constant_score":{let tmpDocResults=this._getAll(query.filter.values,false);let docs=Object.keys(tmpDocResults);for(let i=0;i<docs.length;i++){this._scorer.scoreConstant(boost,docs[i],docResults)}break}case"prefix":{let termIdx=__WEBPACK_IMPORTED_MODULE_1__inverted_index__["a"].getTermIndex(query.value,root);if(termIdx!==null){const termIdxs=__WEBPACK_IMPORTED_MODULE_1__inverted_index__["a"].extendTermIndex(termIdx);for(let i=0;i<termIdxs.length;i++){this._scorer.prepare(fieldName,boost,termIdxs[i].index,doScoring&&enableScoring,docResults,query.value+termIdxs[i].term)}}break}case"exists":{if(root!==null){let docs=Object.keys(this._invIdxs[fieldName].documentStore);for(let i=0;i<docs.length;i++){this._scorer.scoreConstant(boost,docs[i],docResults)}}break}case"match":{let terms=tokenizer.tokenize(query.value);let operator=query.operator!==undefined?query.operator:"or";let tmpQuery=(new __WEBPACK_IMPORTED_MODULE_2__query_builder__["a"]).bool();if(operator==="or"){if(query.minimum_should_match!==undefined){tmpQuery=tmpQuery.minimumShouldMatch(query.minimum_should_match)}tmpQuery=tmpQuery.beginShould()}else{tmpQuery=tmpQuery.beginMust()}tmpQuery=tmpQuery.boost(boost);if(query.fuzziness!==undefined){let prefixLength=query.prefix_length!==undefined?query.prefix_length:2;for(let i=0;i<terms.length;i++){tmpQuery=tmpQuery.fuzzy(fieldName,terms[i]).fuzziness(query.fuzziness).prefixLength(prefixLength)}}else{for(let i=0;i<terms.length;i++){tmpQuery=tmpQuery.term(fieldName,terms[i])}}if(operator==="or"){tmpQuery=tmpQuery.endShould()}else{tmpQuery=tmpQuery.endMust()}docResults=this._recursive(tmpQuery.build().query,doScoring);break}default:break}return docResults}_getUnique(values,doScoring,docResults){if(values.length===0){return docResults}for(let i=0;i<values.length;i++){let currDocs=this._recursive(values[i],doScoring);if(docResults===null){docResults=this._recursive(values[0],doScoring);continue}let docs=Object.keys(docResults);for(let j=0,docId;j<docs.length,docId=docs[j];j++){if(currDocs[docId]===undefined){delete docResults[docId]}else{docResults[docId].push(...currDocs[docId])}}}return docResults}_getAll(values,doScoring){let docResults={};for(let i=0;i<values.length;i++){let currDocs=this._recursive(values[i],doScoring);let docs=Object.keys(currDocs);for(let j=0,docId;j<docs.length,docId=docs[j];j++){if(docResults[docId]===undefined){docResults[docId]=currDocs[docId]}else{docResults[docId].push(...currDocs[docId])}}}return docResults}}__webpack_exports__["a"]=IndexSearcher;class FuzzySearch{constructor(query){this._fuzzy=query.value;this._fuzziness=query.fuzziness!==undefined?query.fuzziness:"AUTO";if(this._fuzziness==="AUTO"){if(this._fuzzy.length<=2){this._fuzziness=0}else if(this._fuzzy.length<=5){this._fuzziness=1}else{this._fuzziness=2}}this._prefixLength=query.prefix_length!==undefined?query.prefix_length:2}static levenshtein_distance(a,b){if(a.length===0)return b.length;if(b.length===0)return a.length;let tmp;let i;let j;let prev;let val;if(a.length>b.length){tmp=a;a=b;b=tmp}const row=Array(a.length+1);for(i=0;i<=a.length;i++){row[i]=i}for(i=1;i<=b.length;i++){prev=i;for(j=1;j<=a.length;j++){if(b[i-1]===a[j-1]){val=row[j-1]}else{val=Math.min(row[j-1]+1,Math.min(prev+1,row[j]+1));if(i>1&&j>1&&b[i-2]===a[j-1]&&a[j-2]===b[i-1]){val=Math.min(val,row[j-1]-(a[j-1]===b[i-1]?1:0))}}row[j-1]=prev;prev=val}row[a.length]=prev}return row[a.length]}search(index){let start=index;let pre=this._fuzzy.slice(0,this._prefixLength);let fuzzy=this._fuzzy;if(this._prefixLength!==0){start=__WEBPACK_IMPORTED_MODULE_1__inverted_index__["a"].getTermIndex(pre,start);fuzzy=fuzzy.slice(this._prefixLength)}if(start===null){return[]}if(fuzzy.length===0){return[{term:"",index:start,boost:1}]}let similarTokens=[];let stack=[start];let treeStack=[""];do{let index=stack.pop();let treeTerms=treeStack.pop();if(index.df!==undefined&&Math.abs(fuzzy.length-treeTerms.length)<=this._fuzziness){const distance=FuzzySearch.levenshtein_distance(fuzzy,treeTerms);if(distance<=this._fuzziness){let term=pre+treeTerms;let boost=1-distance/Math.min(term.length,this._fuzzy.length);similarTokens.push({term:term,index:index,boost:boost})}}if(treeTerms.length-fuzzy.length<=this._fuzziness){let keys=Object.keys(index);for(let i=0;i<keys.length;i++){if(keys[i].length===1){stack.push(index[keys[i]]);treeStack.push(treeTerms+keys[i])}}}}while(stack.length!==0);return similarTokens}}class WildcardSearch{constructor(query){this._wildcard=query.value;this._result=[]}search(root){this._result=[];this._recursive(root);return this._result}_recursive(index,idx=0,term="",escaped=false){if(index===null){return}if(idx===this._wildcard.length){if(index.df!==undefined){this._result.push({index:index,term:term})}return}if(!escaped&&this._wildcard[idx]==="\\"){this._recursive(index,idx+1,term,true)}else if(!escaped&&this._wildcard[idx]==="?"){let others=__WEBPACK_IMPORTED_MODULE_1__inverted_index__["a"].getNextTermIndex(index);for(let i=0;i<others.length;i++){this._recursive(others[i].index,idx+1,term+others[i].term)}}else if(!escaped&&this._wildcard[idx]==="*"){if(idx+1===this._wildcard.length){const all=__WEBPACK_IMPORTED_MODULE_1__inverted_index__["a"].extendTermIndex(index);for(let i=0;i<all.length;i++){this._recursive(all[i].index,idx+1,term+all[i].term)}return}this._recursive(index,idx+1,term);const indices=[{index:index,term:""}];do{const index=indices.pop();let others=__WEBPACK_IMPORTED_MODULE_1__inverted_index__["a"].getNextTermIndex(index.index);for(let i=0;i<others.length;i++){this._recursive(others[i].index,idx+1,term+index.term+others[i].term);indices.push({index:others[i].index,term:index.term+others[i].term})}}while(indices.length!==0)}else{this._recursive(__WEBPACK_IMPORTED_MODULE_1__inverted_index__["a"].getTermIndex(this._wildcard[idx],index),idx+1,term+this._wildcard[idx])}}}},function(module,__webpack_exports__,__webpack_require__){"use strict";class Scorer{constructor(invIdxs){this._cache={};this._invIdxs=invIdxs}setDirty(){this._cache={}}prepare(fieldName,boost,termIdx,doScoring,docResults={},term=null){if(termIdx===null||termIdx.dc===undefined){return null}const idf=this._idf(fieldName,termIdx.df);const docIds=Object.keys(termIdx.dc);for(let j=0;j<docIds.length;j++){const docId=docIds[j];if(docResults[docId]===undefined){docResults[docId]=[]}if(doScoring){const tf=termIdx.dc[docId];docResults[docId].push({type:"BM25",tf:tf,idf:idf,boost:boost,fieldName:fieldName,term:term})}else{docResults[docId]=[{type:"constant",value:1,boost:boost,fieldName:fieldName}]}}return docResults}scoreConstant(boost,docId,docResults={}){if(docResults[docId]===undefined){docResults[docId]=[]}docResults[docId].push({type:"constant",value:1,boost:boost});return docResults}finalScore(query,docResults={}){const result={};const k1=query.scoring.k1;const b=query.scoring.b;const docs=Object.keys(docResults);for(let i=0,docId;i<docs.length,docId=docs[i];i++){let docScore=0;for(let j=0;j<docResults[docId].length;j++){const docResult=docResults[docId][j];let res=0;switch(docResult.type){case"BM25":{const tf=docResult.tf;const fieldLength=Scorer._calculateFieldLength(this._invIdxs[docResult.fieldName].documentStore[docId].fieldLength);const avgFieldLength=this._avgFieldLength(docResult.fieldName);const tfNorm=tf*(k1+1)/(tf+k1*(1-b+b*(fieldLength/avgFieldLength)));res=docResult.idf*tfNorm*docResult.boost;break}case"constant":res=docResult.value*docResult.boost;break}docScore+=res}result[docId]=docScore}return result}static _calculateFieldLength(fieldLength){const lockUp=[1,1.30612242,1.77777779,2.55999994,4,5.22448969,7.11111116,10.2399998,16,20.8979588,28.4444447,40.9599991,64,83.591835,113.777779,163.839996,256,334.36734,455.111115,655.359985,1024,1337.46936,1820.44446,2621.43994,4096,5349.87744,7281.77783,10485.7598,16384,21399.5098,29127.1113,41943.0391,65536,85598.0391,116508.445,167772.156,262144,342392.156,466033.781,671088.625,1048576,1369568.62,1864135.12,2684354.5,4194304,5478274.5,7456540.5,10737418,16777216,21913098,29826162,42949672,67108864,87652392,119304648,171798688,268435456,350609568,477218592,687194752];for(let i=0;i<lockUp.length;i++){if(lockUp[i]>=fieldLength){return lockUp[i]}}throw RangeError("Unsupported field length.")}_getCache(fieldName){if(this._cache[fieldName]===undefined){const avgFieldLength=this._invIdxs[fieldName].totalFieldLength/this._invIdxs[fieldName].documentCount;this._cache[fieldName]={idfs:{},avgFieldLength:avgFieldLength}}return this._cache[fieldName]}_idf(fieldName,docFreq){const cache=this._getCache(fieldName);if(cache.idfs[docFreq]!==undefined){return cache.idfs[docFreq]}return cache.idfs[docFreq]=Math.log(1+(this._invIdxs[fieldName].documentCount-docFreq+.5)/(docFreq+.5))}_avgFieldLength(fieldName){return this._getCache(fieldName).avgFieldLength}}__webpack_exports__["a"]=Scorer}])});